#tag Window
Begin Window LogoWin
   BackColor       =   &cFFFFFF00
   Backdrop        =   0
   CloseButton     =   True
   Composite       =   False
   Frame           =   9
   FullScreen      =   False
   FullScreenButton=   False
   HasBackColor    =   False
   Height          =   744
   ImplicitInstance=   True
   LiveResize      =   "True"
   MacProcID       =   0
   MaxHeight       =   32000
   MaximizeButton  =   True
   MaxWidth        =   32000
   MenuBar         =   149806200
   MenuBarVisible  =   True
   MinHeight       =   180
   MinimizeButton  =   True
   MinWidth        =   64
   Placement       =   0
   Resizeable      =   True
   Title           =   "SigmoID"
   Visible         =   False
   Width           =   1000
   Begin Toolbar1 LogoWinToolbar
      Enabled         =   True
      Index           =   -2147483648
      InitialParent   =   ""
      LockedInPosition=   False
      Scope           =   0
      TabPanelIndex   =   0
      Visible         =   True
   End
   Begin TextArea STDOUT
      AcceptTabs      =   False
      Alignment       =   0
      AutoDeactivate  =   True
      AutomaticallyCheckSpelling=   False
      BackColor       =   &cFFFF00FF
      Bold            =   False
      Border          =   True
      DataField       =   ""
      DataSource      =   ""
      Enabled         =   True
      Format          =   ""
      Height          =   744
      HelpTag         =   ""
      HideSelection   =   True
      Index           =   -2147483648
      Italic          =   False
      Left            =   0
      LimitText       =   0
      LineHeight      =   0.0
      LineSpacing     =   1.0
      LockBottom      =   True
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   True
      LockTop         =   True
      Mask            =   ""
      Multiline       =   True
      ReadOnly        =   False
      Scope           =   0
      ScrollbarHorizontal=   False
      ScrollbarVertical=   True
      Styled          =   True
      TabIndex        =   1
      TabPanelIndex   =   0
      TabStop         =   True
      Text            =   ""
      TextColor       =   &c00000000
      TextFont        =   "System"
      TextSize        =   0.0
      TextUnit        =   0
      Top             =   28
      Transparent     =   True
      Underline       =   False
      UseFocusRing    =   True
      Visible         =   True
      Width           =   1000
   End
   Begin Canvas Splitter
      AcceptFocus     =   False
      AcceptTabs      =   False
      AutoDeactivate  =   True
      Backdrop        =   0
      DoubleBuffer    =   True
      Enabled         =   True
      Height          =   5
      HelpTag         =   ""
      Index           =   -2147483648
      InitialParent   =   ""
      Left            =   1001
      LockBottom      =   False
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   True
      LockTop         =   True
      Scope           =   0
      TabIndex        =   5
      TabPanelIndex   =   0
      TabStop         =   True
      Top             =   229
      Transparent     =   True
      UseFocusRing    =   False
      Visible         =   True
      Width           =   1000
   End
   Begin PagePanel TopPanel
      AutoDeactivate  =   True
      Enabled         =   True
      Height          =   175
      HelpTag         =   ""
      Index           =   -2147483648
      InitialParent   =   ""
      Left            =   1001
      LockBottom      =   False
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   True
      LockTop         =   True
      PanelCount      =   2
      Panels          =   ""
      Scope           =   0
      TabIndex        =   4
      TabPanelIndex   =   0
      Top             =   27
      Transparent     =   True
      Value           =   0
      Visible         =   True
      Width           =   1000
      Begin TextArea Informer
         AcceptTabs      =   False
         Alignment       =   0
         AutoDeactivate  =   True
         AutomaticallyCheckSpelling=   False
         BackColor       =   &cFFFF00FF
         Bold            =   False
         Border          =   True
         DataField       =   ""
         DataSource      =   ""
         Enabled         =   True
         Format          =   ""
         Height          =   175
         HelpTag         =   ""
         HideSelection   =   True
         Index           =   -2147483648
         InitialParent   =   "TopPanel"
         Italic          =   False
         Left            =   1001
         LimitText       =   0
         LineHeight      =   0.0
         LineSpacing     =   1.0
         LockBottom      =   True
         LockedInPosition=   False
         LockLeft        =   True
         LockRight       =   True
         LockTop         =   True
         Mask            =   ""
         Multiline       =   True
         ReadOnly        =   False
         Scope           =   0
         ScrollbarHorizontal=   False
         ScrollbarVertical=   True
         Styled          =   True
         TabIndex        =   0
         TabPanelIndex   =   1
         TabStop         =   True
         Text            =   "Informer\n"
         TextColor       =   &c00000000
         TextFont        =   "System"
         TextSize        =   0.0
         TextUnit        =   0
         Top             =   27
         Transparent     =   True
         Underline       =   False
         UseFocusRing    =   True
         Visible         =   False
         Width           =   1000
      End
   End
   Begin ScrollBar HScrollBar
      AcceptFocus     =   True
      AutoDeactivate  =   True
      Enabled         =   True
      Height          =   11
      HelpTag         =   ""
      Index           =   -2147483648
      InitialParent   =   ""
      Left            =   0
      LineStep        =   200
      LiveScroll      =   False
      LockBottom      =   False
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   True
      LockTop         =   True
      Maximum         =   100
      Minimum         =   0
      PageStep        =   200
      Scope           =   0
      TabIndex        =   6
      TabPanelIndex   =   0
      TabStop         =   True
      Top             =   0
      Transparent     =   True
      Value           =   0
      Visible         =   False
      Width           =   1000
   End
   Begin Canvas LogoCanvas
      AcceptFocus     =   False
      AcceptTabs      =   False
      AutoDeactivate  =   True
      Backdrop        =   0
      DoubleBuffer    =   True
      Enabled         =   True
      Height          =   175
      HelpTag         =   ""
      Index           =   -2147483648
      InitialParent   =   ""
      Left            =   -11
      LockBottom      =   False
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   True
      LockTop         =   True
      Scope           =   0
      TabIndex        =   7
      TabPanelIndex   =   0
      TabStop         =   True
      Top             =   27
      Transparent     =   True
      UseFocusRing    =   True
      Visible         =   True
      Width           =   1000
   End
   Begin CustomTabPanelTabs LogoTabs
      AcceptFocus     =   False
      AcceptTabs      =   False
      AutoDeactivate  =   True
      Backdrop        =   0
      DoubleBuffer    =   False
      Enabled         =   True
      EnableTabReordering=   False
      Facing          =   0
      Height          =   27
      HelpTag         =   ""
      Index           =   -2147483648
      InitialParent   =   ""
      Left            =   -11
      LockBottom      =   False
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   True
      LockTop         =   True
      Scope           =   0
      TabIndex        =   8
      TabPanelIndex   =   0
      TabStop         =   True
      Top             =   0
      Transparent     =   True
      UseFocusRing    =   True
      value           =   0
      Visible         =   True
      Width           =   1000
   End
End
#tag EndWindow

#tag WindowCode
	#tag Event
		Sub Activate()
		  
		End Sub
	#tag EndEvent

	#tag Event
		Sub Close()
		  quit
		End Sub
	#tag EndEvent

	#tag Event
		Sub EnableMenuItems()
		  'adjust View menu command visibility:
		  ViewLogo.Visible=true
		  ViewSequences.Visible=true
		  ViewAlignmentInfo.Visible=true
		  ViewHmmProfile.Visible=true
		  ViewMEMEresults.Visible=true
		  ViewHmmerSettings.Visible=true
		  Separator1.Visible=true
		  ViewHideViewer.Visible=true
		  Separator2.Visible=false
		  ViewViewDetails.Visible=false
		  
		  
		  if ubound(SelArray1)>0 then
		    FileSaveAlignmentSelection.enabled=true
		  else
		    FileSaveAlignmentSelection.enabled=false
		  end if
		  if LogoWin.LogoFile<>Nil then
		    AlignmentProfileWizard.enabled=true
		  else
		    AlignmentProfileWizard.enabled=false
		  end if
		  
		  
		  ViewLogo.enabled=false
		  
		  if SeqsChanged then
		    FileSaveProfileAs.enabled=true
		  else
		    FileSaveProfileAs.enabled=false
		  end if
		  
		  // workaroung for Ubuntu bug with enabling menu items
		  #if targetlinux 
		    if GenomeWin.Visible=true then
		      GenomeAnnotate.Enabled=true   'not quite correct, but can't enable otherwise
		      GenomeMASTSearch.Enabled=true   'not quite correct, but can't enable otherwise
		      GenomeTFfamilySearch.Enabled=true
		      GenomeListRegulons.Enabled=true
		      GenomeGenomeInfo.Enabled=true
		      GenomeGenomeStatistics.Enabled=true
		      GenomeFind.Enabled=true
		      GenomeFindAgain.Enabled=true    'not quite correct, but can't enable otherwise
		      GenomeGoto.Enabled=true
		      GenomeMergePlotData.Enabled=true
		      GenomeAddPlot.Enabled=true
		      GenomeRemovePlots.Enabled=true    'not quite correct, but can't enable otherwise
		      GenomePrintMap.Enabled=true
		    end if
		  #endif
		  
		  
		  if SigFileOpened then
		    FileSaveLogo.enabled=true
		    ViewAlignmentInfo.enabled=true
		    ViewHmmerSettings.enabled=true
		    ViewHmmProfile.Enabled=true
		    ViewLogo.enabled=true
		    ViewSequences.enabled=true
		    ViewMEMEresults.enabled=true
		    AlignmentExtendBindingSites.enabled=true
		    AlignmentConvertToHmm.enabled=true
		    AlignmentConvertToMEME.enabled=true
		    AlignmentConverttoStockholm.enabled=true
		    GenomeRepeatSearch.Enabled=true
		    
		  else
		    ViewAlignmentInfo.enabled=false
		    ViewHmmerSettings.enabled=false
		    ViewHmmProfile.Enabled=false
		    ViewMEMEresults.enabled=false
		    'AlignmentExtendBindingSites.enabled=false
		    'AlignmentConvertToHmm.enabled=false
		    'AlignmentConvertToMEME.enabled=false
		    'AlignmentConverttoStockholm.enabled=false
		    if sequences<>"" then
		      if LengthsDiffer then
		        FileSaveLogo.enabled=false
		        palindromic=false
		        LogoWinToolbar.Item(4).Enabled=false
		      else
		        FileSaveLogo.enabled=true
		        ViewLogo.enabled=true
		        palindromic=true
		        LogoWinToolbar.Item(4).Enabled=true
		      end if
		      GenomeRepeatSearch.Enabled=true
		      ViewSequences.enabled=true
		      AlignmentExtendBindingSites.enabled=true
		      AlignmentConvertToHmm.enabled=true
		      AlignmentConvertToMEME.enabled=true
		      AlignmentConverttoStockholm.enabled=true
		      ProfilePalindromise.Enabled=true
		      ProfileReverseComplement.Enabled=true
		      'if WebLogoAvailable then
		      
		      
		      'else
		      'ViewLogo.enabled=false
		      'FileSaveLogo.enabled=false
		      'end if
		    end if
		    
		  end if
		  
		  if LogoFile<>NIL then
		    AlignmentConvertToMEME.enabled=true
		    AlignmentMEME.enabled=true
		    findSitesChipM.Enabled=true
		    GenomeMASTSearch.enabled=true
		    GenomeNhmmersearch.enabled=true
		    FilterDuplicateSites.enabled=true
		    
		    if RegulonID<>0 then
		      RegPreciseRegulonInfo.enabled=true
		      if IsRegulog then
		        RegPreciseRegulonInfo.Text="Regulog Info"
		      else
		        RegPreciseRegulonInfo.Text="Regulon Info"
		      end if
		    end if
		  end if
		  
		  if MEMEdata="" then
		    ViewMEMEresults.Enabled=false
		  else
		    ViewMEMEresults.Enabled=true
		  end if
		  
		  FileSaveCheckedSites.Visible=false
		  FileSaveCheckedSites.Enabled=false
		  FileSaveGenomeAs.Visible=false
		  FileSaveGenomeAs.Enabled=false
		  
		  FileSaveAlignmentSelection.visible=true
		  FileSaveLogo.visible=true
		  GenomeScanGenome.Visible=true
		  GenomeScanGenome.Enabled=true
		  FileOpenAlignment.visible=true
		  FileOpenAlignment.Enabled=true
		  if LastSearch<>"" then
		    GenomeAnnotate.Enabled=true
		  end if
		  
		  if Ubound(genomeWin.HmmHits)>0 then
		    RegPreciseCompareScores.Enabled=true
		  end if
		End Sub
	#tag EndEvent

	#tag Event
		Sub Open()
		  Dim cli As String
		  dim allProgsFine as boolean
		  
		  dim f As FolderItem
		  
		  ReadPrefs 'diplicating this function in several places as event order is different on different systems
		  
		  'a proper check for monospaced font is required
		  'STDOUT.TextFont="Courier"
		  STDOUT.TextFont=FixedFont
		  STDOUT.Refresh(false)
		  
		  'PathsChanged=true
		  
		  'Dictionary to store Bioprospector's settings
		  BioProspectSettings = New Dictionary
		  
		  f=resources_f.child("HmmGen.py")
		  if f<>Nil then
		    if f.exists then
		      hmmgenpath=PlaceQuotesToPath(f.ShellPath)
		    else
		      msgbox "Can't find the HmmGen.py script!"
		    end if
		  else
		    msgbox "A problem with the HmmGen.py script (it's Nil!)"
		  end if
		  
		  f=resources_f.child("RepeatGen.py")
		  if f<>Nil then
		    if f.exists then
		      RepeatGenPath=PlaceQuotesToPath(f.ShellPath)
		    else
		      msgbox "Can't find the RepeatGen.py script!"
		    end if
		  else
		    msgbox "A problem with the RepeatGen.py script (it's Nil!)"
		  end if
		  
		  f=resources_f.child("MastGen.py")
		  if f<>Nil then
		    if f.exists then
		      mastgenpath=PlaceQuotesToPath(f.ShellPath)
		      'SettingsWin.mastGenPathField.text=mastgenpath
		    else
		      msgbox "Can't find the MastGen.py script"
		    end if
		  else
		    msgbox "Can't find the MastGen.py script"
		  end if
		  
		  f=resources_f.child("TermGen.py")
		  if f<>Nil then
		    if f.exists then
		      TermGenpath=PlaceQuotesToPath(f.ShellPath)
		      'SettingsWin.TermGenPathField.text=TermGenpath
		    else
		      msgbox "Can't find the TermGen.py script"
		    end if
		  else
		    msgbox "Can't find the TermGen.py script"
		  end if
		  
		  f=resources_f.child("OperOn.py")
		  if f<>Nil then
		    if f.exists then
		      OperOnPath=PlaceQuotesToPath(f.ShellPath)
		      'SettingsWin.TermGenPathField.text=TermGenpath
		    else
		      msgbox "Can't find the OperOn.py script"
		    end if
		  else
		    msgbox "Can't find the OperOn.py script"
		  end if
		  
		  allProgsFine=true
		  
		  
		  'check for the command line tools:
		  
		  // python (python 3 now required)
		  
		  Dim pythonCheckString As String = "Checking python and scripts... "+EndOfLine.unix
		  
		  cli="python --version"
		  userShell(cli)
		  'If shError=0 Then
		  If InStr(shResult,"Python 3")>0 Then
		    pythonCheckString=pythonCheckString+Trim(shResult)
		    pythonPath=SystemPath("python")+" "
		    If pythonPath.Length=1 Then
		      pythonPath="python "
		    Else
		      pythonPath=PlaceQuotesToPath(pythonPath)
		    End If
		  Else
		    cli="python3 --version"
		    userShell(cli)
		    If shError=0 Then
		      If InStr(shResult,"Python 3")>0 Then
		        pythonCheckString=pythonCheckString+Trim (shResult)
		        pythonPath=SystemPath("python3")+" "
		        If pythonPath.Length=1 Then
		          pythonPath="python3 "
		        Else
		          pythonPath=PlaceQuotesToPath(pythonPath)
		        End If
		      Else
		        pythonPath=""
		        WriteToSTDOUT ("Can't find working Python 3 command. Python scripts won't work. ")
		      End If
		    Else
		      pythonPath=""
		      WriteToSTDOUT ("Can't find working Python 3 command. Python scripts won't work. ")
		    End If
		  End If
		  
		  
		  If InStr(shResult,"command not found")>0 Then
		    WriteToSTDOUT (shResult+EndOfLine.unix)
		    allProgsFine=false
		  else
		    'pythonCheckString=pythonCheckString+Trim (shResult)
		    
		    'check BioPython:
		    f=resources_f.child("BioPythonVersion.py")
		    if f<>Nil then
		      if f.exists then
		        cli=pythonPath+PlaceQuotesToPath(f.ShellPath)
		        userShell(cli)
		        If shError=0 Then
		          pythonCheckString=pythonCheckString+" with Biopython "+shResult
		        end if
		        
		      end if
		    end if
		    
		  end if
		  'else
		  'WriteToSTDOUT (shResult+EndOfLine.unix)
		  'allProgsFine=false
		  'end if
		  
		  settingsWin.hide  'read prefs
		  
		  WriteToSTDOUT EndOfLine.UNIX+pythonCheckString
		  
		  // Check python scripts
		  'WriteToSTDOUT ("Checking python scripts... "+EndOfLine.UNIX)
		  
		  'hmmgen
		  cli=pythonPath+hmmGenPath+" -v"
		  userShell(cli)
		  dim hmmg as boolean=false
		  If shError=0 Then
		    dim s As string=shResult
		    if instr(nthfield((shResult),EndOfLine.unix,1),"HmmGen")>0 then
		      if CountFields(shResult,EndOfLine.unix)=2 then
		        WriteToSTDOUT (s)
		        hmmg=true
		        'else
		        'msgbox str(CountFields(Sh.Result,EndOfLine))
		      End If
		    end if
		  end if
		  if Not hmmg then
		    WriteToSTDOUT (EndOfLine.Unix+"HmmGen script doesn't work properly. Please verify that biopython is installed."+EndOfLine.UNIX)
		    WriteToSTDOUT (EndOfLine.Unix)
		    allProgsFine=false
		  end if
		  
		  'RepeatGen
		  cli=pythonPath+RepeatGenPath+" -v"
		  userShell(cli)
		  hmmg=false
		  If shError=0 Then
		    dim s As string=shResult
		    if instr(nthfield((shResult),EndOfLine.unix,1),"RepeatGen")>0 then
		      if CountFields(shResult,EndOfLine.unix)=2 then
		        WriteToSTDOUT (s)
		        hmmg=true
		        'else
		        'msgbox str(CountFields(Sh.Result,EndOfLine))
		      End If
		    end if
		  end if
		  if Not hmmg then
		    WriteToSTDOUT (EndOfLine.Unix+"RepeatGen script doesn't work properly. Please verify that biopython is installed."+EndOfLine.UNIX)
		    WriteToSTDOUT (EndOfLine.Unix)
		    allProgsFine=false
		  end if
		  
		  'mastgen
		  'WriteToSTDOUT ("Checking the MastGen script... ")
		  cli=pythonPath+MastGenPath+" -v"
		  userShell(cli)
		  If shError=0 Then
		    dim s As string=shResult
		    if instr(nthfield((shResult),EndOfLine.unix,1),"MastGen")>0 then
		      if CountFields(shResult,EndOfLine.unix)=2 then
		        WriteToSTDOUT (s)
		        hmmg=true
		        'else
		        'msgbox str(CountFields(Sh.Result,EndOfLine))
		      End If
		    end if
		  end if
		  if Not hmmg then
		    WriteToSTDOUT ("MastGen script doesn't work properly. Please verify that biopython is installed."+EndOfLine.UNIX)
		    WriteToSTDOUT (EndOfLine.Unix)
		    allProgsFine=false
		  end if
		  
		  'TermGen
		  'WriteToSTDOUT ("Checking the TermGen script... ")
		  cli=pythonPath+TermGenPath+" -v"
		  userShell(cli)
		  hmmg=false
		  If shError=0 Then
		    Dim s As String=shResult
		    if instr(nthfield((shResult),EndOfLine.unix,1),"TermGen")>0 then
		      if CountFields(shResult,EndOfLine.unix)=2 then
		        WriteToSTDOUT (s)
		        hmmg=true
		        'else
		        'msgbox str(CountFields(shResult,EndOfLine))
		      End If
		    end if
		  end if
		  if Not hmmg then
		    WriteToSTDOUT ("TermGen script doesn't work properly. Please verify that biopython is installed."+EndOfLine.UNIX)
		    WriteToSTDOUT (EndOfLine.Unix)
		    allProgsFine=false
		  end if
		  
		  'OperOn
		  'WriteToSTDOUT ("Checking the OperOn script... ")
		  cli=pythonPath+OperOnPath+" -v"
		  userShell(cli)
		  hmmg=false
		  If shError=0 Then
		    dim s As string=shResult
		    if instr(nthfield((shResult),EndOfLine.unix,1),"OperOn")>0 then
		      if CountFields(shResult,EndOfLine.unix)=2 then
		        WriteToSTDOUT (s)
		        hmmg=true
		        'else
		        'msgbox str(CountFields(shResult,EndOfLine))
		      End If
		    end if
		  end if
		  if Not hmmg then
		    WriteToSTDOUT ("OperOn script doesn't work properly. Please verify that biopython is installed."+EndOfLine.UNIX)
		    WriteToSTDOUT ("The command was: "+cli+EndOfLine.UNIX)
		    WriteToSTDOUT ("The result was: "+shResult+EndOfLine.UNIX)
		    WriteToSTDOUT (EndOfLine.Unix)
		    allProgsFine=false
		  end if
		  
		  'ptt_converter
		  dim ptt_converterPath as string
		  ptt_converterPath=Replace(HmmGenPath, "hmmgen.py", "ptt_converter.py")
		  cli=pythonPath+ptt_converterPath+" -v"
		  userShell(cli)
		  hmmg=false
		  If shError=0 Then
		    dim s As string=shResult
		    if instr(nthfield((shResult),EndOfLine.unix,1),"converter")>0 then
		      if CountFields(shResult,EndOfLine.unix)=2 then
		        WriteToSTDOUT (s)
		        hmmg=true
		        'else
		        'msgbox str(CountFields(shResult,EndOfLine))
		      End If
		    end if
		  end if
		  if Not hmmg then
		    WriteToSTDOUT (EndOfLine.Unix+"Converter script doesn't work properly. Please verify that biopython is installed."+EndOfLine.UNIX)
		    WriteToSTDOUT (EndOfLine.Unix)
		    allProgsFine=false
		  end if
		  
		  
		  WriteToSTDOUT EndOfLine.UNIX+"Checking command line programs..."+EndOfLine.UNIX
		  
		  // WSL - only for Windows
		  
		  #if TargetWindows
		    cli="uname -a"
		    ExecuteWSL(cli)
		    If shError=0 Then
		      WriteToSTDOUT (shResult)
		    else
		      WriteToSTDOUT ("No WSL bash found at "+WSLBashPath+". Please install it or correct the path in the settings."+EndOfLine)
		      allProgsFine=false
		    End If
		  #endif
		  
		  // nhmmer
		  
		  cli=nhmmerPath+" -h"
		  #if TargetWindows
		    ExecuteWSL(cli)
		  #else
		    UserShell(cli)
		  #endif
		  If shError=0 Then
		    dim s As string=shResult
		    if instr(nthfield(s,EndOfLine.Unix,1),"nhmmer")>0 then
		      s=nthfield((shResult),EndOfLine.Unix,2)
		      s=nthfield((S),"HMMER",2)
		      s=trim(nthfield((S),";",1)) 'that will result in smth like "3.1b1 (May 2013)"
		      WriteToSTDOUT ("nhmmer "+s+EndOfLine.unix)
		      nhmmerVersion=trim(nthfield((S),"(",1))
		    else
		      WriteToSTDOUT ("No nhmmer found at "+nhmmerPath+". Please install it from http://hmmer.janelia.org/ or correct the path in the settings."+EndOfLine)
		      allProgsFine=false
		    end if
		  else
		    WriteToSTDOUT ("No nhmmer found at "+nhmmerPath+". Please install it from http://hmmer.janelia.org/ or correct the path in the settings."+EndOfLine)
		    allProgsFine=false
		  end if
		  
		  // hmmbuild
		  
		  cli=hmmBuildPath+" -h"
		  #if TargetWindows
		    ExecuteWSL(cli)
		  #else
		    UserShell(cli)
		  #endif
		  If shError=0 Then
		    dim s As string=shResult
		    if instr(nthfield(s,EndOfLine.Unix,1),"hmmbuild")>0 then
		      s=nthfield((shResult),EndOfLine.Unix,2)
		      s=nthfield((S),"HMMER",2)
		      s=nthfield((S),";",1) 'that will result in smth like "3.1b1 (May 2013)"
		      WriteToSTDOUT ("hmmbuild "+trim(s)+EndofLine.unix)
		      'nhmmerVersion=trim(nthfield((S),"(",1))
		    else
		      WriteToSTDOUT ("No hmmbuild found at "+hmmbuildPath+". Please install it from http://hmmer.janelia.org/ or correct the path in the settings."+EndOfLine)
		      allProgsFine=false
		    end if
		  else
		    WriteToSTDOUT ("No hmmbuild found at "+hmmbuildPath+". Please install it from http://hmmer.janelia.org/ or correct the path in the settings."+EndOfLine)
		    allProgsFine=false
		  End If
		  
		  // alimask
		  
		  cli=alimaskPath+" -h"
		  #if TargetWindows
		    ExecuteWSL(cli)
		  #else
		    UserShell(cli)
		  #endif
		  If shError=0 Then
		    dim s As string=shResult
		    if instr(nthfield((shResult),EndOfLine.Unix,1),"alimask")>0 then
		      s=nthfield((shResult),EndOfLine.Unix,2)
		      s=nthfield((S),"HMMER",2)
		      s=nthfield((S),";",1)
		      WriteToSTDOUT ("alimask "+s+EndofLine.unix)
		      
		    else
		      WriteToSTDOUT ("No alimask found at "+alimaskPath+". Please install it or correct the path in the settings."+EndOfLine.unix)
		      allProgsFine=false
		    end if
		  else
		    WriteToSTDOUT ("No alimask found at "+alimaskPath+". Please install it or correct the path in the settings."+EndOfLine.unix)
		    allProgsFine=false
		  end if
		  
		  // TransTerm
		  
		  f=resources_f.child("transterm")
		  if f<>Nil then
		    if f.exists or TargetWindows then
		      #if TargetWindows
		        cli = "transterm -h"
		        ExecuteWSL(cli)
		      #else
		        cli=f.ShellPath+" -h"
		        UserShell(cli)
		      #endif
		      If shError=0 OR shError=3 then 'TransTerm returns error code when run without all args
		        dim s As string
		        s=nthfield((shResult),EndOfLine.Unix,1)
		        s=replaceall(s,EndOfLine,"") 'otherwise an extra line on some Windows machines
		        if instr(s,"TransTermHP")>0 then
		          WriteToSTDOUT (s+EndofLine.unix)
		        else
		          WriteToSTDOUT ("No transterm found at "+f.ShellPath+". Please copy it alongside with the 'expterm.dat' file into the expected place."+EndOfLine.unix)
		          allProgsFine=false
		        end if
		      else
		        WriteToSTDOUT ("No transterm found at "+f.ShellPath+". Please copy it alongside with the 'expterm.dat' file into the expected place."+EndOfLine.unix)
		        allProgsFine=false
		      end if
		    else
		      WriteToSTDOUT ("No transterm found at "+f.ShellPath+". Please copy it alongside with the 'expterm.dat' file into the expected place."+EndOfLine.unix)
		      allProgsFine=false
		    end if
		  else
		    WriteToSTDOUT ("No transterm found at "+f.ShellPath+". Please copy it alongside with the 'expterm.dat' file into the expected place."+EndOfLine.unix)
		    allProgsFine=false
		  end if
		  
		  // MEME
		  
		  cli=memePath+" -version"
		  #if TargetWindows
		    ExecuteWSL(cli)
		  #else
		    UserShell(cli)
		  #endif
		  If shError=0 Then
		    WriteToSTDOUT ("meme "+shResult)
		  else
		    WriteToSTDOUT ("No MEME found at "+memePath+". Please install it from http://meme-suite.org/ or correct the path in the settings."+EndOfLine)
		    allProgsFine=false
		  end if
		  
		  // MAST
		  
		  cli=MASTPath+" -version"
		  #if TargetWindows
		    ExecuteWSL(cli)
		  #else
		    UserShell(cli)
		  #endif
		  If shError=0 Then
		    WriteToSTDOUT ("mast "+shResult)
		    MASTVersion=trim(shResult)
		  else
		    WriteToSTDOUT ("No MAST found at "+MASTPath+". Please install it from http://meme-suite.org/ or correct the path in the settings."+EndOfLine)
		    allProgsFine=false
		  end if
		  
		  // TomTom
		  
		  cli=TomTomPath+" -version"
		  #if TargetWindows
		    ExecuteWSL(cli)
		  #else
		    UserShell(cli)
		  #endif
		  If shError=0 Then
		    WriteToSTDOUT ("tomtom "+shResult)
		  else
		    WriteToSTDOUT ("No TomTom found at "+TomTomPath+". Please install it from http://meme-suite.org/ or correct the path in the settings."+EndOfLine)
		    allProgsFine=false
		  End If
		  
		  // MeShClust
		  
		  If MeshClustPath<>"" Then
		    #if TargetWindows
		      ExecuteWSL(MeshClustPath)
		    #else
		      userShell(MeshClustPath)
		    #endif
		    If sherror=1 Then 'running meshclust without args produces this error and help info
		      Dim s As String=shResult
		      If InStr(s,"meshclust")>0 Then
		        s=NthField(s,"version ",2)
		        s=NthField(s,EndOfLine.Unix,1)
		        WriteToSTDOUT ("MeShClust "+s+EndOfLine.UNIX)
		      Else
		        WriteToSTDOUT ("No MeShClust found at "+MeshClustPath+". Please install it from https://github.com/BioinformaticsToolsmith/MeShClust or correct the path in the settings."+EndOfLine.unix)
		        allProgsFine=False
		      End If
		    Else
		      WriteToSTDOUT ("No MeShClust found at "+MeshClustPath+". Please install it from https://github.com/BioinformaticsToolsmith/MeShClust or correct the path in the settings."+EndOfLine.unix)
		      allProgsFine=False
		    End If
		  Else
		    WriteToSTDOUT ("No MeShClust found. Please install it from https://github.com/BioinformaticsToolsmith/MeShClust or correct the path in the settings."+EndOfLine.unix)
		    allProgsFine=False
		  End If
		  
		  // tfastx
		  
		  cli=tfastxPath
		  #if TargetWindows
		    ExecuteWSL(cli)
		  #else
		    UserShell(cli)
		  #endif
		  If shError=0 Then 
		    dim s As string=shResult
		    if instr(s,"TFASTX")>0 then
		      s=nthfield((shResult)," version: ",2)
		      s=nthfield((S),EndOfLine.Unix,1)
		      WriteToSTDOUT ("tfastx "+s+EndOfLine.UNIX)
		    else
		      WriteToSTDOUT ("No tfastx found at "+tfastxPath+". Please install it from http://faculty.virginia.edu/wrpearson/fasta/CURRENT/ or correct the path in the settings."+EndOfLine.unix)
		      allProgsFine=false
		    end if
		  else
		    WriteToSTDOUT ("No tfastx found at "+tfastxPath+". Please install it from http://faculty.virginia.edu/wrpearson/fasta/CURRENT/ or correct the path in the settings."+EndOfLine.unix)
		    allProgsFine=false
		  end if
		  
		  // NCBI Edirect
		  
		  #If TargetWindows
		    ExecuteWSL("esearch -h")
		  #Else
		    userShell("esearch -h")
		  #EndIf
		  If sherror=0 Then 
		    Dim s As String=shResult
		    If Left(s,7)="esearch" Then
		      s=NthField(s,"esearch ",2)
		      s=NthField(s,EndOfLine.Unix,1)
		      WriteToSTDOUT ("NCBI Edirect "+s+EndOfLine.UNIX)
		    Else
		      WriteToSTDOUT ("No NCBI Edirect found on your PATH. Please follow install instructions at https://www.ncbi.nlm.nih.gov/books/NBK179288/"+EndOfLine.unix)
		      'allProgsFine=False
		    End If
		  Else
		    WriteToSTDOUT ("No NCBI Edirect found on your PATH. Please follow install instructions at https://www.ncbi.nlm.nih.gov/books/NBK179288/"+EndOfLine.unix)
		    'allProgsFine=False
		  End If
		  
		  // RegPrecise
		  ' web services don't work after the move to new server
		  
		  'WriteToSTDOUT ("Accessing RegPrecise... ")
		  ChangeView("HideViewer")
		  
		  me.Show
		  
		  'dim res as string
		  'dim jsn as new JSONItem
		  'dim hts as new HTTPSocket
		  'hts.Yield=true
		  'res=hts.Get("https://regprecise.lbl.gov/Services/rest/release",5)
		  'if hts.HTTPStatusCode>=200 AND hts.HTTPStatusCode<300 then 'successful
		  '
		  'if Res="" then
		  'WriteToSTDOUT ("no response in 5 seconds")
		  'else
		  'JSN.load(res)
		  'RegPreciseWin.RegPreciseVersion=JSN.value("majorVersion")+"."+JSN.value("mionrVersion")+" "+JSN.value("releaseDate")
		  'WriteToSTDOUT (RegPreciseWin.RegPreciseVersion)+EndOfLine.Unix
		  'end if
		  '
		  'else
		  '
		  'dim httpErr as String = HTTPerror(hts.HTTPStatusCode, false)
		  'LogoWin.WriteToSTDOUT (httpErr)
		  '
		  'end if
		  
		  
		  if not allProgsFine then
		    SettingsWin.ShowModalWithin(self)
		    
		  end
		  
		  
		  LogoWinToolbar.Item(1).Enabled=false 'Search: disable until alignment loaded
		  LogoWinToolbar.Item(2).Enabled=false 'HmmGen: disable until nhmmer is run
		  'LogoWinToolbar.Item(3).Enabled=false 'TermGen: enable from the beginning
		  LogoWinToolbar.Item(4).Enabled=false 'palindromise: disable until alignment loaded
		  LogoWinToolbar.Item(5).Enabled=false 'SaveLog: disable until alignment loaded
		  
		  //Determine and store CPU core number
		  CPUcores=CountCPUcores  'physical cores only!
		  lCPUcores=CountCPUcores(true)  'logical cores
		  If CPUcores>1 Then
		    userShell(MEMEpath+" -p 2")
		    If InStr(shResult,"Parallel MEME not configured")>0 Then
		      LogoWin.WriteToSTDOUT(EndOfLine.unix+"Parallel MEME not configured (refer to install.html from MEME Suite docs for proper installation)."+EndOfLine.unix)
		      cores2use=1 ' to suppress error message since serial meme can only be run anyway
		    Else
		      LogoWin.WriteToSTDOUT(EndOfLine.unix+Str(lCPUcores)+" CPU cores detected. All of them can be used for running MEME."+EndOfLine.unix)
		      If lCPUcores<>cores2use Then
		        LogoWin.WriteToSTDOUT("The current setting is to use "+Str(cores2use)+" cores. The number can be changed in the preferences window."+EndOfLine.unix)
		      End If
		    End If
		  End If
		  WriteToSTDOUT (EndOfLine.unix+EndOfLine.unix+"Load alignment or genome file to start."+EndOfLine.Unix)
		  
		  about.close
		  Exception err
		    ExceptionHandler(err,"LogoWin:Open")
		    
		End Sub
	#tag EndEvent


	#tag MenuHandler
		Function AlignmentConvertToHmm() As Boolean Handles AlignmentConvertToHmm.Action
			Dim dlg as New SaveAsDialog
			dim HmmFile as folderitem
			
			dlg.InitialDirectory=Logofile.Parent
			dlg.promptText="Select a name for Hmm file to export alignment to."
			dlg.SuggestedFileName=nthfield(Logofile.Name,".",1)+".hmm"
			dlg.Title="Export hmm Profile"
			dlg.Filter=FileTypes.Text
			dlg.CancelButtonCaption=kCancel
			dlg.ActionButtonCaption=kSave
			HmmFile=dlg.ShowModalwithin(self)
			if HmmFile<>nil then
			dim StockholmFile as FolderItem = TemporaryFolder.child("stock")
			if StockholmFile <> nil then
			Stockholm(LogoFile,StockholmFile,"")
			if hmmbuild(StockholmFile.shellpath,HmmFile.shellpath) then
			else
			WriteToSTDOUT(EndOfLine+"hmmbuild error")
			end if
			end if
			end if
			
			Exception err
			ExceptionHandler(err,"LogoWin:AlignmentConvertToHmm")
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function AlignmentConvertToMEME() As Boolean Handles AlignmentConvertToMEME.Action
			dim d as integer = MEMEconvert(logoFile,self.palindromic)
			
			if d=0 then
			dim MEMEtmp as folderitem
			MEMEtmp=TemporaryFolder.child("MEME.txt")
			FixPath4Windows(MEMEtmp)
			
			if MEMEtmp<>NIL then
			if MEMEtmp.Exists then
			
			dim tis as TextInputStream
			tis=TextInputStream.Open(MEMEtmp)
			if tis <>nil then
			WriteToSTDOUT(tis.ReadAll)
			end if
			end if
			end if
			end if
			
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function AlignmentConverttoStockholm() As Boolean Handles AlignmentConverttoStockholm.Action
			Dim dlg as New SaveAsDialog
			dim StockholmFile as folderitem
			
			dlg.InitialDirectory=Logofile.Parent
			dlg.promptText="Select a name for Stockholm file to export alignment to."
			dlg.SuggestedFileName=nthfield(Logofile.Name,".",1)+".sto"
			dlg.Title="Export alignment in Stockholm format"
			dlg.Filter=FileTypes.Text
			dlg.CancelButtonCaption=kCancel
			dlg.ActionButtonCaption=kSave
			StockholmFile=dlg.ShowModalwithin(self)
			if StockholmFile<>nil then
			Stockholm(LogoFile,StockholmFile,"")
			end if
			
			Exception err
			ExceptionHandler(err,"LogoWin:AlignmentConvertToStockholm")
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function AlignmentExtendBindingSites() As Boolean Handles AlignmentExtendBindingSites.Action
			if GenomeFile<>Nil then
			ExtendSitesWin.GenomeField.text=GenomeFile.ShellPath
			ExtendSitesWin.ExtendButton.Enabled=true
			else
			ExtendSitesWin.ExtendButton.Enabled=false
			end if
			ExtendSitesWin.ShowModalWithin(self)
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function AlignmentMEME() As Boolean Handles AlignmentMEME.Action
			MEMESettingsWin.ShowModalwithin(self)
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function AlignmentProfileWizard() As Boolean Handles AlignmentProfileWizard.Action
			ProfileWizardWin.reveal(me.sequences)
			
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function BioProspData2Logo() As Boolean Handles BioProspData2Logo.Action
			BioProspectData2Logo
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function FileSaveAlignmentSelection() As Boolean Handles FileSaveAlignmentSelection.Action
			if ubound(SelArray1)=1 then
			
			Dim dlg as New SaveAsDialog
			Dim outfile as FolderItem
			'dlg.InitialDirectory=Profile_f
			'dlg.promptText="Prompt Text"
			
			dlg.SuggestedFileName=NthField(LogoFile.Name,".",1)+"_short.fasta"
			dlg.Title="Save subrange of the alignment"
			'dlg.Filter=FileTypes1.Text  //defined as a file type in FileTypes1 File Type Set
			dlg.CancelButtonCaption=kCancel
			dlg.ActionButtonCaption=kSave
			outfile=dlg.ShowModal()
			If outfile <> Nil then
			dim instream as TextInputStream
			dim outstream As TextOutputStream
			dim aLine as string
			dim start,length as integer
			
			start=floor((SelArray1(1)-7)/30)
			length=floor((SelArray2(1)-7)/30)-start
			InStream = logofile.OpenAsTextFile
			if Instream<>Nil then
			OutStream = outfile.createTextFile 'make the file to store the stuff in
			while not InStream.EOF
			aLine=InStream.readLine
			if left(aLine,1)=">" then
			OutStream.writeLine aline
			else
			OutStream.writeLine mid(aline,start,length)
			end if
			
			wend
			InStream.close
			else
			msgbox "Error trying to create file"
			end if
			OutStream.close
			
			
			Else
			//user canceled
			End if
			
			
			else
			msgbox "You need to have single selection range in the logo for this function to work."
			end if
			Return True
			
			Exception err
			ExceptionHandler(err,"LogoWin:FileSaveAlignmentSelection")
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function FileSaveLogo() As Boolean Handles FileSaveLogo.Action
			
			SaveLogo
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function FileSaveProfileAs() As Boolean Handles FileSaveProfileAs.Action
			'write the changed seqs to a temp file, point LogoFile to it
			'and open Profile Wizard
			
			if SeqsChanged then
			dim TFname as string
			TFname=nthfield(ProfileWizardWin.ValueField.Text," ",1)
			dim BSfastaFile as folderitem = TemporaryFolder.child(TFname+".fasta")
			if BSfastaFile<>nil then
			dim outstream As TextOutputStream
			outstream = TextOutputStream.Create(BSfastaFile)
			outstream.write(trim(Sequences))
			outstream.close
			LogoFile=BSfastaFile
			WriteToSTDOUT("Edited alignment loaded."+EndOfLine.unix)
			
			end if
			end if
			
			ProfileWizardWin.show
			
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function FindSBioPros() As Boolean Handles FindSBioPros.Action
			BioProspectorLogoW
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function findSitesChipM() As Boolean Handles findSitesChipM.Action
			dim w as new ChipMParam
			w.actionButton.Caption="Run"
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function GenomeAnnotate() As Boolean Handles GenomeAnnotate.Action
			if LastSearch="nhmmer" then
			HmmGenSearch
			elseif LastSearch="MAST" then
			HmmGenOptions=""
			MASTGenSettingsWin.showmodalwithin(self)
			if MASTGenSettingsWin.OKpressed then
			if GenomeFile<>Nil then
			dim fn as string=nthfield(GenomeFile.Name,".",1)+"_"+nthfield(Logofile.Name,".",1)+".gb"
			outfile=GetSaveFolderItem("????",fn)
			if outfile<>nil then
			if MastGen then
			if MASTGenSettingsWin.GenomeBrowserCheckBox.Value then 'Load the Seq into browser
			if ubound(GenomeWin.HmmHitDescriptions)>0 then
			GenomeWin.opengenbankfile(outFile)
			genomeWin.ShowHit
			WriteToSTDOUT (" done."+EndofLine)
			end if
			end if
			end if
			end if
			else
			MsgBox "No genome file selected. Have you run MAST search?"
			end if
			end if
			
			end if
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function GenomeMASTSearch() As Boolean Handles GenomeMASTSearch.Action
			dim memeResultAvailable as boolean
			
			if GenomeFile<>Nil then
			MASTSettingsWin.GenomeField.text=GenomeFile.ShellPath
			
			MASTSettingsWin.RunButton.Enabled=true
			else
			
			MASTSettingsWin.RunButton.Enabled=false
			
			end if
			MASTSettingsWin.EnableRun
			MASTSettingsWin.ShowModalWithin(self)
			
			if nhmmerOptions <> "" then    'lazy to rename into MASToptions
			'check if we have meme file already within the .sig
			if SigFileOpened then
			dim memefile as FolderItem
			memefile=LogoFile.parent.child("MEME.txt")
			if memefile<>NIL and memefile.Exists then
			memefile.CopyFileTo(TemporaryFolder)
			MEMEtmp=TemporaryFolder.child("MEME.txt")
			if memetmp<>nil then
			memeResultAvailable=true
			WriteToSTDOUT (EndofLine+"MEME results from the .sig file will be used.")
			end if
			else
			WriteToSTDOUT (EndofLine+"No MEME result file in the .sig, so have to run MEME...")
			
			if MEMEconvert(LogoFile,self.palindromic) = 0 then
			memeResultAvailable=true
			end if
			
			end if
			
			else
			if MEMEconvert(LogoFile,self.palindromic) = 0 then
			memeResultAvailable=true
			end if
			
			end if
			
			
			
			if memeResultAvailable then
			
			MASTsearch
			
			if MASTSettingsWin.ShowHitsCheckBox.value then
			// the 'Add annotation' and 'Mask hits within ORFs' options are mutually exclusive
			// both can't be selected (but can be deselected) at the same time
			
			if MastSettingsWin.AddAnnotationCheckBox.value then
			HmmGenOptions=""
			Dim dlg as New SaveAsDialog
			dlg.InitialDirectory=genomefile.Parent
			dlg.promptText="Select where to save the modified genome file"
			dlg.SuggestedFileName=nthfield(GenomeFile.Name,".",1)+"_"+nthfield(Logofile.Name,".",1)+".gb"
			dlg.Title="Save genome file"
			dlg.Filter=FileTypes.genbank
			dlg.CancelButtonCaption=kCancel
			dlg.ActionButtonCaption=kSave
			outfile=dlg.ShowModal()
			if outfile<>nil then
			MastGenSettingsWin.ReadOptions
			if MastGen then
			if MastGenSettingsWin.GenomeBrowserCheckBox.Value then 'Load the Seq into browser
			if ubound(GenomeWin.HmmHitDescriptions)>0 then
			GenomeWin.opengenbankfile(outFile)
			genomeWin.ShowHit
			WriteToSTDOUT (" done."+EndofLine)
			end if
			end if
			end if
			end if
			
			elseif MastSettingsWin.MaskWithinORFCheckBox.value then
			
			'remove hits within CDS:
			dim HitCount,Featurecount as integer
			dim m,n as integer
			WriteToSTDOUT (EndofLine+"Filtering out hits within ORFs...")
			
			GenomeWin.opengenbankfile(genomeFile)
			
			HitCount=ubound(genomeWin.HmmHitChecked)
			FeatureCount=ubound(genomeWin.genome.features)
			for m=HitCount downto 1
			for n=1 to Featurecount
			'if genomeWin.genome.features(n).type="CDS" then
			if (genomeWin.genome.features(n).start<=GenomeWin.HmmHits(m) And genomeWin.genome.features(n).Finish>=GenomeWin.HmmHits(m)) OR (genomeWin.genome.features(n).Finish<=GenomeWin.HmmHits(m) And genomeWin.genome.features(n).Start>=GenomeWin.HmmHits(m)) then
			if left(genomeWin.genome.features(n).FeatureText,3)="CDS" then
			genomeWin.HmmHitChecked.Remove(m)
			genomeWin.HmmHitDescriptions.Remove(m)
			genomeWin.HmmHitNames.Remove(m)
			genomeWin.HmmHits.Remove(m)
			exit
			end if
			end if
			'end if
			next 'n
			next 'm
			WriteToSTDOUT ("  "+str(HitCount-ubound(genomeWin.HmmHits))+" hits within ORF removed.")
			
			if Ubound(genomeWin.HmmHits)>0 then
			'if NOT ScanningGenome then
			'WriteToSTDOUT (EndofLine+"Genbank file with added features written to "+outFile.ShellPath+EndofLine)
			'end if
			
			WriteToSTDOUT (EndofLine.unix+"Loading the GenBank file...")
			
			'Set the genome map scrollbar:
			Genomewin.SetScrollbar
			
			'Display the hit:
			genomeWin.CurrentHit=1
			Dim s0 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 0 )
			s0.Enabled=false 'first hit: there's no previous one
			Dim s1 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 1 )
			s1.Title="1/"+str(UBound(genomeWin.HmmHits))
			Dim s2 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 2 )
			s2.enabled=true
			
			genomeWin.ShowHit
			WriteToSTDOUT (" done."+EndofLine)
			end if
			
			else
			
			if Ubound(genomeWin.HmmHits)>0 then
			'if NOT ScanningGenome then
			'WriteToSTDOUT (EndofLine+"Genbank file with added features written to "+outFile.ShellPath+EndofLine)
			'end if
			
			WriteToSTDOUT (EndofLine.unix+"Loading the GenBank file...")
			
			GenomeWin.opengenbankfile(genomeFile)
			
			'Set the genome map scrollbar:
			Genomewin.SetScrollbar
			
			'Display the hit:
			genomeWin.CurrentHit=1
			Dim s0 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 0 )
			s0.Enabled=false 'first hit: there's no previous one
			Dim s1 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 1 )
			s1.Title="1/"+str(UBound(genomeWin.HmmHits))
			Dim s2 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 2 )
			s2.enabled=true
			
			genomeWin.ShowHit
			WriteToSTDOUT (" done."+EndofLine)
			end if
			
			end if
			end if
			end if
			end if
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function GenomeNhmmersearch() As Boolean Handles GenomeNhmmersearch.Action
			'if NOT SigFileOpened then
			
			'masking should be allowed for .sig files too...
			if masked then
			nhmmerSettingsWin.MaskingBox.Enabled=true
			nhmmerSettingsWin.MaskingBox.HelpTag="Masking options for alimask. HMMer default is Henikoff position-based"
			else
			nhmmerSettingsWin.MaskingBox.Enabled=False
			nhmmerSettingsWin.MaskingBox.HelpTag="Masking options for alimask. To enable, drag/shift-drag over undesired positions in the logo"
			'show cutoff values:
			end if
			'end if
			if GenomeFile<>Nil then
			nhmmerSettingsWin.GenomeField.text=GenomeFile.ShellPath
			
			nhmmerSettingsWin.RunButton.Enabled=true
			else
			'#if Debugbuild
			'GenomeFile=GetFolderItem(nhmmerSettingsWin.GenomeField.text,FolderItem.PathTypeShell)
			'#else
			nhmmerSettingsWin.RunButton.Enabled=false
			'#endif
			end if
			nhmmerSettingsWin.EnableRun
			nhmmerSettingsWin.ShowModalWithin(self)
			'Genomefile=GetFolderItem(trim(nhmmerSettingsWin.GenomeField.text), FolderItem.PathTypeShell)
			if nhmmerOptions <> "" then
			if nhmmer then
			if nhmmerSettingsWin.AddAnnotationCheckBox.value then
			Dim dlg as New SaveAsDialog
			dlg.InitialDirectory=genomefile.Parent
			dlg.promptText="Select where to save the modified genome file"
			dlg.SuggestedFileName=nthfield(GenomeFile.Name,".",1)+"_"+nthfield(Logofile.Name,".",1)+".gb"
			dlg.Title="Save genome file"
			dlg.Filter=FileTypes.genbank
			dlg.CancelButtonCaption=kCancel
			dlg.ActionButtonCaption=kSave
			outfile=dlg.ShowModal()
			if outfile<>nil then
			HmmGenSettingsWin.ReadOptions
			if HmmGen then
			if HmmGenSettingsWin.GenomeBrowserCheckBox.Value then 'Load the Seq into browser
			if ubound(GenomeWin.HmmHitDescriptions)>0 then
			GenomeWin.opengenbankfile(outFile)
			genomeWin.ShowHit
			WriteToSTDOUT (" done."+EndofLine)
			end if
			end if
			end if
			end if
			end if
			end if
			end if
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function GenomeRepeatSearch() As Boolean Handles GenomeRepeatSearch.Action
			if GenomeFile<>Nil then
			RepeatSearchSettingsWin.GenomeField.text=GenomeFile.ShellPath
			
			RepeatSearchSettingsWin.RunButton.Enabled=true
			else
			'#if Debugbuild
			'GenomeFile=GetFolderItem(nhmmerSettingsWin.GenomeField.text,FolderItem.PathTypeShell)
			'#else
			RepeatSearchSettingsWin.RunButton.Enabled=false
			'#endif
			end if
			RepeatSearchSettingsWin.EnableRun
			RepeatSearchSettingsWin.ShowModalWithin(self)
			'Genomefile=GetFolderItem(trim(nhmmerSettingsWin.GenomeField.text), FolderItem.PathTypeShell)
			
			
			if hmmgenOptions <> "" then
			'set nhmmer options:
			
			nhmmeroptions=" --max"                     '--max
			
			dim RSW as RepeatSearchSettingsWin = RepeatSearchSettingsWin
			
			if RSW.EvalueButton.Value then
			if val(RSW.EvalueField.text)>0 then    'if cutoff isn't entered, run without it
			nhmmeroptions=nhmmeroptions+" -E "+Trim(RSW.EvalueField.Text)
			end if
			elseif RSW.BitScoreButton.value then
			if val(RSW.BitScoreField.text)>0 then    'if cutoff isn't entered, run without it
			nhmmeroptions=nhmmeroptions+" -T "+trim(RSW.BitScoreField.text)
			end if
			end if
			
			
			
			if nhmmerOptions <> "" then
			if nhmmer then
			if RepeatSearchSettingsWin.GenomeBrowserCheckBox.value then
			Dim dlg as New SaveAsDialog
			dlg.InitialDirectory=genomefile.Parent
			dlg.promptText="Select where to save the modified genome file"
			dlg.SuggestedFileName=nthfield(GenomeFile.Name,".",1)+"_"+nthfield(Logofile.Name,".",1)+".gb"
			dlg.Title="Save genome file"
			dlg.Filter=FileTypes.genbank
			dlg.CancelButtonCaption=kCancel
			dlg.ActionButtonCaption=kSave
			outfile=dlg.ShowModal()
			if outfile<>nil then
			'RepeatSearchSettingsWin.ReadOptions
			
			if RepeatGen then
			if RepeatSearchSettingsWin.GenomeBrowserCheckBox.Value then 'Load the Seq into browser
			if ubound(GenomeWin.HmmHitDescriptions)>0 then
			GenomeWin.opengenbankfile(outFile)
			genomeWin.ShowHit
			WriteToSTDOUT (" done."+EndofLine)
			end if
			end if
			end if
			end if
			end if
			end if
			end if
			end if
			
			Return True
			
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function GenomeTerminatorSearch() As Boolean Handles GenomeTerminatorSearch.Action
			TermGenSearch
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function LogoFromPWMtest() As Boolean Handles LogoFromPWMtest.Action
			// only testing
			
			dim p as picture
			dim s as string
			s=" 0.375000  0.250000  0.375000  0.000000 " + EndOfLine
			s=s+" 0.500000  0.250000  0.250000  0.000000 " + EndOfLine
			s=s+" 0.000000  0.750000  0.000000  0.250000 " + EndOfLine
			s=s+" 0.000000  0.000000  0.125000  0.875000 " + EndOfLine
			s=s+" 0.875000  0.000000  0.000000  0.125000 " + EndOfLine
			s=s+" 0.125000  0.250000  0.250000  0.375000 " + EndOfLine
			s=s+" 0.875000  0.000000  0.000000  0.125000 " + EndOfLine
			s=s+" 0.000000  0.750000  0.000000  0.250000 " + EndOfLine
			s=s+" 0.125000  0.250000  0.250000  0.375000 " + EndOfLine
			s=s+" 0.499999  0.000000  0.000000  0.499999 " + EndOfLine
			s=s+" 0.500000  0.000000  0.000000  0.500000 " + EndOfLine
			s=s+" 0.374999  0.249999  0.249999  0.124999 " + EndOfLine
			s=s+" 0.249999  0.000000  0.749999  0.000000 " + EndOfLine
			s=s+" 0.124999  0.000000  0.000000  0.874999 " + EndOfLine
			s=s+" 0.374999  0.249999  0.249999  0.124999 " + EndOfLine
			s=s+" 0.124999  0.000000  0.000000  0.874999 " + EndOfLine
			s=s+" 0.874999  0.124999  0.000000  0.000000 " + EndOfLine
			s=s+" 0.249999  0.000000  0.749999  0.000000 " + EndOfLine
			s=s+" 0.000000  0.249999  0.249999  0.499999 " + EndOfLine
			s=s+" 0.000000  0.374999  0.249999  0.374999 "
			
			p=LogoFromPWM(s)
			beep
			
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function ProfileConvertFolderToMEME() As Boolean Handles ProfileConvertFolderToMEME.Action
			// Select a folder with .sig files and convert all of them into a single file in the minimal meme format
			
			
			Dim SigF, f As FolderItem
			Dim m,n,q As Integer
			Dim basename As String
			Dim vv As VirtualVolume
			Dim tis As TextInputStream
			Dim dlg As New SelectFolderDialog
			dlg.ActionButtonCaption = "Select"
			dlg.Title = "Select Folder with .sig files"
			dlg.PromptText = "Select Folder with .sig files to convert"
			'dlg.InitialDirectory = Profile_f.parent
			
			SigF = dlg.ShowModal
			If SigF <> Nil Then
			ConvertProfilesToMEMEWin.Foldername=SigF.DisplayName
			m=SigF.Count
			For n=1 To m
			If SigF.Item(n).name<>".DS_Store" Then
			If SigF.Item(n).Directory Then
			'skip folder
			Else
			If Right(SigF.Item(n).Name,4)=".sig" Then
			
			'Get MEME data:
			vv=SigF.Item(n).openAsVirtualVolume
			If vv<> Nil Then
			basename=NthField(SigF.Item(n).DisplayName,".sig",1)
			f=vv.root.child("meme.txt")
			If f<> Nil And f.exists Then
			'tis = New TextInputStream
			tis = TextInputStream.Open(f)
			MEMEdata=tis.ReadAll
			tis.Close
			
			Dim motifName, nSites, PWMdata, sitelen, FastaData, Info, Options  As String 
			Dim LEloc As Integer
			
			motifName=NthField(SigF.Item(n).Name,".sig",1)
			'nSites=Str(Val(NthField(MEMEdata," nsites=",2)))     'MEME ignores duplicates, so this number can be less than the actual number of seqs
			PWMdata=NthField(MEMEdata," nsites=",2)               'get closer to the data
			LEloc=InStr(PWMdata,EndOfLine)
			PWMdata=Right(PWMdata,Len(PWMdata)-LEloc)                 'still has trailing lines
			PWMdata=NthField(PWMdata,"--",1)
			'PWMdata=ReplaceAll(PWMdata,EndOfLine+EndOfLine,EndOfLine) 'remove empty lines
			'PWMdata=ReplaceAll(PWMdata,EndOfLine+EndOfLine,EndOfLine)
			'PWMdata=ReplaceAll(PWMdata,EndOfLine+EndOfLine,EndOfLine)
			
			sitelen=Str(CountFields(PWMdata,EndOfLine))
			
			'get fasta data:
			f=vv.root.child(basename+".fasta")
			If f<> Nil And f.exists Then
			tis = TextInputStream.Open(f)
			FastaData=tis.ReadAll
			tis.Close
			End If
			
			nSites=str(countfields(FastaData,">")-1)
			
			'get info:
			f=vv.root.child(basename+".info")
			If f<> Nil And f.exists Then
			tis = TextInputStream.Open(f)
			Info=tis.ReadAll
			tis.Close
			End If
			
			'get options:
			f=vv.root.child(basename+".options")
			If f<> Nil And f.exists Then
			tis = TextInputStream.Open(f)
			Options=tis.ReadAll
			tis.Close
			End If
			
			// CollectionList columns are:
			' 0 - Checkbox
			' 1 - Profile Name
			' 2 - Number of seqs
			' 3 - Information (bits)
			' 4 - Logo picture
			' 5 (invisible) - TFBS seqs (in fasta format)
			' 6 (invisible) - TFBS length.
			
			'added for profile merge:
			' 7 (invisible) - profile info
			' 8 (invisible) - profile options
			' 9 (invisible) - profile name
			
			Dim reg() As String = Array("",motifName,nSites,Str(Globals.InfoBits),"", FastaData,siteLen,Info,Options,basename)  'first column contains checkboxes
			
			ConvertProfilesToMEMEWin.CollectionList.AddRow(reg)
			
			Dim p As picture = LogoFromPWM(PWMdata)
			''scale the picture down to 35 pixel heigh and stretch it horisontally a bit
			'dim LogoPicScaled as new Picture (p.width*50/170,35,32)
			'LogoPicScaled.Graphics.DrawPicture (p,0,0,p.width*50/170,35,0,0,p.width,p.Height)
			'LogoPicScaled.Transparent=1
			
			''scale the picture down to 60 pixel heigh and stretch it horisontally a bit
			'dim LogoPicScaled as new Picture (p.width*50/170,45,32)
			'LogoPicScaled.Graphics.DrawPicture (p,0,0,p.width*50/170,45,0,0,p.width,p.Height)
			Dim LogoPicScaled As New Picture (p.width*70/170,60,32)
			LogoPicScaled.Graphics.DrawPicture (p,0,0,LogoPicScaled.width,LogoPicScaled.height,0,0,p.width,p.Height)
			
			LogoPicScaled.Transparent=1
			
			
			'add picture to the last row as variant, so it is sorted properly 
			ConvertProfilesToMEMEWin.CollectionList.RowTag(ConvertProfilesToMEMEWin.collectionlist.LastIndex)=LogoPicScaled
			
			'Update progress text
			ConvertProfilesToMEMEWin.ProgressLabel.Text="Loading profiles: "+Str(ConvertProfilesToMEMEWin.CollectionList.ListCount)
			
			
			ConvertProfilesToMEMEWin.CollectionList.Enabled=True
			
			
			
			
			
			
			Else
			WriteToSTDOUT(EndOfLine.UNIX+"No MEME data in "+SigF.Item(n).DisplayName+EndOfLine.UNIX)
			
			
			
			End If
			Else
			Beep
			End If
			
			
			End If
			End If
			End If
			Next
			
			'logowin.WriteToSTDOUT(EndOfLine+"Converted sig files written to "+OutF.ShellPath+EndOfLine)
			
			Else
			// User cancelled
			End If
			
			
			ConvertProfilesToMEMEWin.show
			
			Exception err
			ExceptionHandler(err,"App:ProfileConvertFolderToMEME")
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function ProfilePalindromise() As Boolean Handles ProfilePalindromise.Action
			Palindromise
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function ProfileReverseComplement() As Boolean Handles ProfileReverseComplement.Action
			PalindromeLogoFile=TemporaryFolder.child("LogoPalindrome")
			
			'since we change data, that's not the .sig any more!
			SigFileOpened=false
			
			If PalindromeLogoFile <> Nil then
			RevCompAlignment(logofile, palindromeLogofile,false)
			logofile=PalindromeLogoFile
			
			'replace contents of the Sequence variable (for viewing)
			dim instream as TextInputStream = PalindromeLogoFile.OpenAsTextFile
			Sequences=Instream.ReadAll
			instream.Close
			DrawLogo
			palindromic=true
			LogoWinToolbar.Item(4).Enabled=false
			HmmGenSettingsWin.PalindromicBox.value=true
			End If
			
			Exception err
			ExceptionHandler(err,"LogoWin:Palindromise")
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function RegPreciseCompareScores() As Boolean Handles RegPreciseCompareScores.Action
			'run nhmmer, then hmmgen, then convert hits to fasta string
			'and feed it to the actual comparison routine
			
			'for now, assume that both nhmmer and HmmGen have been run and we have the required hits.
			
			dim score as double
			
			score=CompareScores(GenomeWin.GetCheckedHits,me.Sequences)
			
			
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function RegPreciseRegulonInfo() As Boolean Handles RegPreciseRegulonInfo.Action
			
			if IsRegulog then
			RegulonInfo(RegulogID,true)
			else
			RegulonInfo(RegulonID,false)
			end if
			
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function RegPreciseWeights() As Boolean Handles RegPreciseWeights.Action
			
			WriteToSTDOUT("__7,1,0,3__:"+EndOfLine)
			WriteToSTDOUT("base 2 log: "+PosNucWeight(7,1,0,3)+EndOfLine)
			WriteToSTDOUT("base 10 log: "+PosNucWeight1(7,1,0,3)+EndOfLine)
			WriteToSTDOUT("base 2 log counts: "+PosNucWeight3(7,1,0,3)+EndOfLine)
			WriteToSTDOUT("base 10 log counts: "+PosNucWeight2(7,1,0,3)+EndOfLine)
			WriteToSTDOUT("__2,0,0,9__:"+EndOfLine)
			WriteToSTDOUT("base 2 log: "+PosNucWeight(2,0,0,9)+EndOfLine)
			WriteToSTDOUT("base 10 log: "+PosNucWeight1(2,0,0,9)+EndOfLine)
			WriteToSTDOUT("base 2 log counts: "+PosNucWeight3(2,0,0,9)+EndOfLine)
			WriteToSTDOUT("base 10 log counts: "+PosNucWeight2(2,0,0,9)+EndOfLine)
			WriteToSTDOUT("__0,0,0,12__:"+EndOfLine)
			WriteToSTDOUT("base 2 log: "+PosNucWeight(0,0,0,12)+EndOfLine)
			WriteToSTDOUT("base 10 log: "+PosNucWeight1(0,0,0,12)+EndOfLine)
			WriteToSTDOUT("base 2 log counts: "+PosNucWeight3(0,0,0,12)+EndOfLine)
			WriteToSTDOUT("base 10 log counts: "+PosNucWeight2(0,0,0,12)+EndOfLine)
			WriteToSTDOUT("base 2 log countsM: "+PosNucWeight4(0,0,0,12)+EndOfLine)
			
			WriteToSTDOUT("__11,0,1,0__:"+EndOfLine)
			WriteToSTDOUT("base 2 log countsM: "+PosNucWeight4(11,0,1,0)+EndOfLine)
			
			WriteToSTDOUT("__0,5,1,6__:"+EndOfLine)
			WriteToSTDOUT("base 2 log countsM: "+PosNucWeight4(0,5,1,6)+EndOfLine)
			
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function ViewAlignmentInfo() As Boolean Handles ViewAlignmentInfo.Action
			LogoTabs.value=2
			ChangeView("AlignmentInfo")
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function ViewHideViewer() As Boolean Handles ViewHideViewer.Action
			ChangeView("HideViewer")
			
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function ViewHmmerSettings() As Boolean Handles ViewHmmerSettings.Action
			LogoTabs.value=3
			ChangeView("ProfileSettings")
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function ViewHmmProfile() As Boolean Handles ViewHmmProfile.Action
			LogoTabs.value=4
			
			ChangeView("HmmProfile")
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function ViewLogo() As Boolean Handles ViewLogo.Action
			LogoTabs.value=0
			ChangeView("Logo")
			
			Return True
			
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function ViewMEMEresults() As Boolean Handles ViewMEMEresults.Action
			LogoTabs.value=5
			ChangeView("MEMEresults")
			Return True
		End Function
	#tag EndMenuHandler

	#tag MenuHandler
		Function ViewSequences() As Boolean Handles ViewSequences.Action
			LogoTabs.value=1
			ChangeView("Sequences")
			Return True
			
		End Function
	#tag EndMenuHandler


	#tag Method, Flags = &h0
		Sub alimask(infile as folderitem)
		  '/usr/local/bin/alimask
		  
		  '# alimask :: appending modelmask line to a multiple sequence alignments
		  '# HMMER 3.1b1 (May 2013); http://hmmer.org/
		  '# Copyright (C) 2013 Howard Hughes Medical Institute.
		  '# Freely distributed under the GNU General Public License (GPLv3).
		  '# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
		  'Usage: alimask [-options] <msafile> <postmsafile>
		  '
		  'Basic options:
		  '-h     : show brief help on version and usage
		  '-o <f> : direct summary output to file <f>, not stdout
		  '
		  'Mask range options (format:  --xxx 10-20,30-40 ) :
		  '--modelrange <s> : range(s) for mask(s) in model coordinates
		  '--alirange <s>   : range(s) for mask(s) in alignment coordinates
		  '--apendmask      : add to existing mask (default ignores to existing mask)
		  '--model2ali <s>  : print model ranges corresponding to input alignment ranges
		  '--ali2model <s>  : print alignment ranges corresponding to input model ranges
		  '
		  'Options for selecting alphabet rather than guessing it:
		  '--amino         : input alignment is protein sequence data
		  '--dna           : input alignment is DNA sequence data
		  '--rna           : input alignment is RNA sequence data
		  '--outformat <s> : output alignment in format <s>  [Stockholm]
		  '
		  'Alternative model construction strategies:
		  '--fast           : assign cols w/ >= symfrac residues as consensus  [default]
		  '--hand           : manual construction (requires reference annotation)
		  '--symfrac <x>    : sets sym fraction controlling --fast construction  [0.5]
		  '--fragthresh <x> : if L <= x*alen, tag sequence as a fragment  [0.5]
		  '
		  'Alternative relative sequence weighting strategies:
		  '--wpb     : Henikoff position-based weights  [default]
		  '--wgsc    : Gerstein/Sonnhammer/Chothia tree weights
		  '--wblosum : Henikoff simple filter weights
		  '--wnone   : don't do any relative weighting; set all to 1
		  '--wgiven  : use weights as given in MSA file
		  '--wid <x> : for --wblosum: set identity cutoff  [0.62]  (0<=x<=1)
		  '
		  'Other options:
		  '--informat <s> : assert input alifile is in format <s> (no autodetect)
		  '--seed <n>     : set RNG seed to <n> (if 0: one-time arbitrary seed)  [42]
		  
		  dim mask as string
		  dim n as integer
		  dim cli as string
		  
		  'get the temp file to store the output
		  alimaskTmp=TemporaryFolder.child("alimaskTmp")
		  
		  if ubound(SelArray1)>0 then
		    for n=1 to ubound(SelArray1)
		      mask=mask+str(floor((SelArray1(n)-7)/30))+"-"+str(floor((SelArray2(n)-7)/30)-1)+","
		    next
		    mask=left(mask,len(mask)-1)
		    
		    if alimaskTmp<>nil then
		      if infile<>Nil then
		        FixPath4Windows(alimaskTmp)
		        cli=alimaskpath+" --alirange "+mask+weighting+PlaceQuotesToPath(MakeWSLPath(inFile.ShellPath))+" "+PlaceQuotesToPath(MakeWSLPath(alimaskTmp.shellpath))
		        
		      else
		        msgbox "Invalid input file for alimask"
		      end if
		      
		      #If TargetWindows
		        ExecuteWSL(cli)
		      #Else
		        UserShell(cli)
		      #endif
		      If shError=0 Then
		        masked=true 'return shResult
		      else
		        MsgBox "Error Code: "+Str(shError)
		      end if
		    else
		      msgbox "Nothing to mask. Please select base range(s) first."
		    end if
		  else
		    MsgBox "Problem creating temporary file"
		  end if
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:alimask")
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub AnnotateMEMEresults()
		  dim Splitter As String = "********************************************************************************"+EndOfLine.UNIX+"--------------------------------------------------------------------------------"
		  dim dlg As New SelectFolderDialog
		  dim MEMEfolder As FolderItem
		  dim MEMEresult As FolderItem
		  dim TFFamilyFolder As FolderItem
		  dim nhmmerOutput As FolderItem = TemporaryFolder.Child("annotateResNhmmer.table")
		  dim hmmgenOutput As FolderItem = TemporaryFolder.Child("annotateResHmmgen")
		  dim CalProfiles As FolderItem
		  dim instream As TextInputStream
		  dim outstream As TextOutputStream
		  
		  dim MotifFile, f As FolderItem
		  dim Fasta As String
		  dim MEMEtxt As String
		  dim MotifWidth As Integer
		  dim TFMotif(-1) As String
		  dim TFmotifsFasta() As Motif
		  
		  dim sh As Shell
		  dim cli As String
		  dim SigBases As New Dictionary
		  dim Tag As String
		  dim vv As VirtualVolume
		  dim basename As String
		  dim Threshold As String
		  dim HmmsearchFile As String
		  dim HmmsearchArray(-1) As String
		  dim CRtag As String
		  dim  BoundMoietyStr As String
		  
		  CalProfiles = Resources_f.Child("CalibratedProfiles")
		  For Each Family As FolderItem In CalProfiles.Children
		    If Family.IsFolder Then
		      For Each SigFile As FolderItem in Family.Children
		        If SigFile.Type="SigmoidFile" Then
		          Tag = Nthfield(SigFile.Name,"_",1)
		          If Tag<>"" Then
		            dim sig As New Motif
		            vv=SigFile.openAsVirtualVolume
		            If vv<>nil then
		              basename=nthfield(SigFile.DisplayName,".sig",1)
		              f=vv.root.child(basename+".fasta")
		              If f<>Nil and f.Exists Then
		                instream = TextInputStream.Open(f)
		                sig.fasta=instream.ReadAll
		                sig.TFname=basename
		                instream.Close
		                f=vv.root.child(basename+".options")
		                If f<>Nil and f.Exists Then
		                  instream = TextInputStream.Open(f)
		                  Threshold=instream.ReadAll
		                  instream.Close
		                  Threshold=Nthfield(Threshold,"#=GF NC ",2)
		                  Threshold=Nthfield(Threshold," ",1)
		                  sig.Threshold=Threshold
		                End
		                dim ProfileModels() As Motif
		                If Not SigBases.HasKey(Tag) Then
		                  ProfileModels.Append(sig)
		                  SigBases.Value(Tag)=ProfileModels()
		                Else
		                  ProfileModels= SigBases.Value(Tag)
		                  ProfileModels.Append(sig)
		                  SigBases.Value(Tag)=ProfileModels()
		                End
		              Else
		                
		              End
		            End
		          End
		        End
		      Next
		    End
		  Next
		  
		  
		  dlg.ActionButtonCaption = "Select"
		  dlg.Title = "Provide path to the MEME_results folder content"
		  'dlg.PromptText = ""
		  TFFamilyFolder = dlg.ShowModal
		  If TFFamilyFolder <> Nil and TFFamilyFolder.IsFolder Then
		    For Each Family As FolderItem in TFFamilyFolder.Children
		      If Family <> Nil and Family.IsFolder Then
		        MEMEfolder = Family.Child("MEME_results")
		        If MEMEfolder<>Nil And MEMEfolder.Exists Then
		          For Each Folder As FolderItem in MEMEfolder.Children
		            If Folder.IsFolder Then
		              For Each ModeFolder As FolderItem in Folder.Children
		                If ModeFolder.IsFolder Then
		                  MEMEresult = ModeFolder.Child("meme.txt")
		                  if MEMEresult <> nil and MEMEresult.Exists Then
		                    instream = TextInputStream.Open(MEMEresult)
		                    MEMEtxt = instream.ReadAll
		                    dim MemeModels(-1) As String
		                    MemeModels = MEMEtxt.Split(Splitter)
		                    For n As Integer =1 to UBound(MemeModels)
		                      Fasta = getMotifFasta(MemeModels(n))
		                      If Fasta<>"" Then
		                        dim MotifModel As New Motif
		                        MotifModel.fasta= Fasta
		                        MotifModel.mode=ModeFolder.Name
		                        MotifModel.TFname=Folder.Name
		                        MotifModel.number=n
		                        TFmotifsFasta.Append(MotifModel)
		                      End
		                    Next
		                  End
		                End
		              Next
		              f = Family.Child("hmmsearch_result_withCRtags.txt")
		              If f<>Nil And f.Exists Then 
		                instream = TextInputStream.Open(f)
		                HmmsearchFile = instream.ReadAll
		                HmmsearchFile = Nthfield(HmmsearchFile,"> "+Folder.Name,1)
		                HmmsearchArray=HmmsearchFile.Split(">")
		                CRtag=HmmsearchArray(UBound(HmmsearchArray))
		                If SigBases.HasKey(CRtag) Then
		                  dim sig As New Motif 
		                  dim ProfileModels() As Motif = SigBases.Value(CRTag)
		                  If Ubound(ProfileModels)>1 Then
		                    For i As Integer =0 to UBound(ProfileModels)
		                      sig = ProfileModels(i)
		                      dim TFname As String = sig.TFname
		                      WriteToSTDOUT(Folder.Name+" CR-tag matches calibrated profile "+sig.TFname+". Model added for genome-wide inference."+EndOfLine.Unix)
		                      sig.TFname=TFname.ReplaceAll(" ","")+"-"+Folder.Name.ReplaceAll(" ","")
		                      TFmotifsFasta.Append(sig)
		                      
		                    Next
		                  Else
		                    sig= ProfileModels(Ubound(ProfileModels))
		                    WriteToSTDOUT(Folder.Name+" CR-tag matches calibrated profile "+sig.TFname+". Model added for genome-wide infererence."+EndOfLine.Unix)
		                    dim TFname As String = sig.TFname
		                    sig.TFname=TFname.ReplaceAll(" ","")+"-"+Folder.Name.ReplaceAll(" ","")
		                    TFmotifsFasta.Append(sig)
		                  End If
		                  
		                End
		              End
		            End
		          Next
		        Else
		          WriteToSTDOUT("MEME_results folder not found at "+str(Family.NativePath)+ EndOfLine.Unix)
		        End
		      End
		    Next
		  End
		  If Ubound(TFMotifsFasta)>0 Then
		    nhmmerSettingsWin.AnnotateRes=True
		    nhmmerSettingsWin.BitScoreField.enabled=True
		    nhmmerSettingsWin.BitScoreButton.enabled=True
		    nhmmerSettingsWin.GenomeField.Enabled = False
		    nhmmerSettingsWin.PushButton3.Enabled = False
		    nhmmerSettingsWin.ThresholdsBox.Enabled = True
		    nhmmerSettingsWin.EvalueButton.Enabled = False
		    nhmmerSettingsWin.EvalueField.Enabled=False
		    nhmmerSettingsWin.CutoffBox.Enabled = False
		    nhmmerSettingsWin.RunButton.Enabled = True
		    'nhmmerSettingsWin.ShowModalWithin(self)
		    nhmmerSettingsWin.ShowModal()
		    dim GBfile As String = Nthfield(GenomeWin.GenomeFile.Name,".gb",1)+"_annotated.gb"
		    dim AnnotatedGenome As FolderItem = TemporaryFolder.Child(GBfile)
		    Try
		      If AnnotatedGenome.Exists then AnnotatedGenome.Remove
		      outstream = TextOutputStream.Create(AnnotatedGenome)
		      instream = TextInputStream.Open(GenomeFile)
		      dim SourceGenome As String = instream.ReadAll
		      outstream.Write(SourceGenome)
		      outstream.Close
		    Catch err as IOException
		      LogoWin.WriteToSTDOUT("Can't save fasta file with motif sequences."+EndOfLine.UNIX)
		    End
		    If nhmmerOptions<>"" Then
		      MotifFile = TemporaryFolder.Child("TFmotif.fasta")
		      If MotifFile <> Nil Then
		        App.DoEvents
		        dim MotifsCount As String = str(UBound(TFMotifsFasta))
		        dim i As Integer = 1
		        For Each MotifModel As Motif In TFMotifsFasta
		          BoundMoietyStr=MotifModel.TFname
		          If MotifModel.mode<>"" Then
		            BoundMoietyStr= BoundMoietyStr+"-"+MotifModel.mode+"-"+str(MotifModel.number)
		          End
		          LogoWin.WriteToSTDOUT("Processing "+BoundMoietyStr+" model."+EndOfLine.UNIX)
		          'calculate motif width
		          Fasta=MotifModel.fasta
		          MotifWidth=len(Nthfield(Fasta,EndOfLine.UNIX,2))
		          if MotifWidth=0 then 
		            LogoWin.WriteToSTDOUT("Incorrect motif width for "+MotifModel.TFname+"-"+MotifModel.mode+str(MotifModel.number)+" model. Skipped."+EndOfLine.UNIX)
		            Continue
		          End
		          If nhmmerSettingsWin.BitScoreField.Value="" Then
		            If MotifModel.Threshold="" Then
		              Dim IC As Double
		              IC=Fasta2IC(Fasta)
		              'Calcucate model threshold if it's not provided by user
		              Dim cutoffs,NC As String
		              cutoffs=Bits2thresholds(IC)
		              NC=NthField(cutoffs,"#=GF NC ",2)
		              NC=NthField(NC," ",1)
		              nhmmerOptions=nhmmerOptions+" -T "+str(NC)
		              LogoWin.WriteToSTDOUT("Significance threshold derived from motif's model IC value, used value: "+str(NC)+" bit(s)"+EndOfLine.UNIX)
		            Else
		              nhmmerOptions=nhmmerOptions+" -T "+MotifModel.Threshold
		              LogoWin.WriteToSTDOUT("Significance threshold derived from motif's NC options, used value: "+MotifModel.Threshold+" bit(s)"+EndOfLine.UNIX)
		            End
		          End
		          If MotifFile.Exists Then MotifFile.Remove
		          Try
		            outstream = TextOutputStream.Create(MotifFile)
		            outstream.Write(MotifModel.fasta)
		            outstream.Close
		          Catch err as IOException
		            LogoWin.WriteToSTDOUT("Can't save fasta file with motif sequences."+EndOfLine.UNIX)
		            Continue 
		          End
		          cli=PlaceQuotesToPath(nhmmerpath)+" --dna "+nhmmeroptions+" --tblout "+PlaceQuotesToPath(nhmmerOutput.shellpath)+" "+PlaceQuotesToPath(MotifFile.ShellPath)+" "+PlaceQuotesToPath(AnnotatedGenome.ShellPath)
		          sh=New Shell
		          sh.Mode=1
		          sh.TimeOut=-1
		          WriteToSTDOUT ("Running nhmmer..."+EndOfLine.UNIX)
		          #if TargetWindows
		            sh.execute(cli)
		          #else
		            sh.execute("bash --login -c "+chr(34)+cli+chr(34)) 'Should be corrected
		          #endif
		          While sh.IsRunning=true
		            App.DoEvents
		          wend
		          
		          If sh.errorCode=0 Then
		            Dim HitsCount As String = trim(Nthfield(NthField(Sh.Result, "Total number of hits:",2),"(",1))
		            LogoWin.WriteToSTDOUT("Total number of hits: "+HitsCount+EndOfLine.UNIX)
		            
		          Else
		            If instr(sh.Result,"No hits detected that satisfy reporting thresholds")>0 Then
		              WriteToSTDOUT ("No hits detected that satisfy reporting threshold"+EndofLine)
		            Else
		              WriteToSTDOUT (EndofLine+Sh.Result)
		              WriteToSTDOUT (EndofLine+"nhmmer command line was: "+cli+EndofLine)
		            End
		            nhmmerOptions=""
		            Continue
		          End if
		          If hmmgenOutput.Exists Then hmmgenOutput.Remove
		          cli=pythonPath+PlaceQuotesToPath(hmmGenPath)+" "+PlaceQuotesToPath(nhmmerOutput.ShellPath)+" "+PlaceQuotesToPath(AnnotatedGenome.ShellPath)+" "
		          'intergenic distance is hardcoded, should be configurable
		          'cli = cli + hmmgenOutput.ShellPath+" -d -S "+trim(Nthfield(Nthfield(nhmmerOptions," -T",2),"--tblout",1))+" -i -b 50 -L 110 -n -f protein_bind -q"+chr(34)
		          cli = cli + PlaceQuotesToPath(hmmgenOutput.ShellPath)+" -d -S "+trim(Nthfield(Nthfield(nhmmerOptions," -T",2),"--tblout",1))+" -i -b 50 -L "+str(MotifWidth)+" -n -f protein_bind -q bound_moiety"+chr(34)
		          'cli = cli + chr(34)+"#"+chr(34)+MotifModel.TFname+"-"+chr(34)+chr(34)+"inference"+chr(34)+chr(34)+"#"+chr(34)+"profile:nhmmer:3.3"
		          cli = cli + chr(34)+"#"+chr(34)+BoundMoietyStr+"-"+chr(34)+chr(34)+"inference"+chr(34)+chr(34)+"#"+chr(34)+"profile:nhmmer:3.3"
		          
		          sh=New Shell
		          sh.Mode=1
		          sh.TimeOut=-1
		          #if TargetWindows
		            sh.execute(cli)
		          #else
		            sh.execute("bash --login -c "+chr(34)+cli+chr(34)) 'Should be corrected
		          #endif
		          
		          While sh.IsRunning=true
		            App.DoEvents
		          wend
		          If sh.errorCode=0 Then
		            dim AnnotatedCount as string
		            AnnotatedCount=NthField(NthField(Sh.Result,"Features added:",3),"--------------------------------------------------",1)
		            LogoWin.WriteToSTDOUT("Number of features added: "+trim(AnnotatedCount)+EndOfLine.UNIX)
		            instream = TextInputStream.Open(hmmgenOutput)
		            dim annotation as string = instream.ReadAll
		            If annotation<>"" Then
		              If AnnotatedGenome.Exists Then AnnotatedGenome.Remove
		              outstream = TextOutputStream.Open(AnnotatedGenome)
		              outstream.Write(annotation)
		              outstream.Close
		              nhmmerOutput.Remove
		              hmmgenOutput.Remove
		            End
		          Else
		            WriteToSTDOUT (EndofLine+"HmmGen error code: "+Str(sh.errorCode)+EndofLine.UNIX)
		            WriteToSTDOUT (EndofLine+Sh.Result)
		            WriteToSTDOUT (EndofLine+"HmmGen command line was: "+cli+EndofLine.UNIX)
		          End
		          If nhmmerSettingsWin.BitScoreField.Value="" Then
		            nhmmerOptions=Nthfield(nhmmerOptions," -T ",1)
		          End
		          LogoWin.WriteToSTDOUT(str(i)+" out of "+MotifsCount+" models processed."+EndOfLine.UNIX+EndOfLine.UNIX)
		          i = i+1
		        Next
		        LogoWin.WriteToSTDOUT("Annotation is complete."+EndOfLine.UNIX)
		        If AnnotatedGenome.Exists Then
		          Try 
		            AnnotatedGenome.CopyTo(TFFamilyFolder)
		            LogoWin.WriteToSTDOUT("Annotated genome file location: "+TFFamilyFolder.NativePath+EndOfLine.UNIX)
		          Catch err As IOException
		            LogoWin.WriteToSTDOUT("Can't save annotated file to "+TFFamilyFolder.NativePath+EndOfLine.UNIX)
		          End
		        End
		        App.DoEvents
		      End
		    End
		  End
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub BioProspectData2Logo()
		  Dim dlg As New OpenFileDialog
		  Dim inputData As New FolderItem
		  Dim instream As TextInputStream
		  Dim motifEntry As String
		  Dim rawData As String
		  Dim motifBlocks(-1) As String
		  Dim LogoWinSequences As New Dictionary
		  Dim Motifs As New Dictionary
		  Dim heading As String
		  Dim motifSite As BioProsMotifSite
		  Dim siteSeq As string
		  Dim values(-1) As Integer
		  Dim seqLength As Integer
		  Dim motifEntries as BioProsMotifs
		  Dim FirstBlock  As new RegEx
		  Dim SecBlock  As new RegEx
		  Dim StrandCheck As new RegEx
		  Dim FBlockWidth As new RegEx
		  Dim RBlockWidth As new RegEx
		  Dim FastaHeader As new RegEx
		  Dim firstBlockWidth As Integer
		  Dim secBlockWidth As Integer 
		  Dim firstBlockMatch As RegExMatch
		  Dim secBlockMatch As RegExMatch
		  Dim valueMatch As RegExMatch
		  Dim FastaHeaderMatch As RegExMatch
		  Dim twoBlockMotif As Boolean = True
		  Dim outstream As TextOutputStream
		  FirstBlock.SearchPattern = "(?<=\()\d+"
		  SecBlock.SearchPattern = "\d+(?=\))"
		  FastaHeader.SearchPattern = "\>.*"
		  FBlockWidth.SearchPattern = "(?<=f )\d+"
		  RBlockWidth.SearchPattern = "(?<=r )\d+"
		  StrandCheck.SearchPattern = "\sf\s\d"
		  If LogoWin.Sequences <> "" then
		    Dim seqsFasta(-1) As String = LogoWin.Sequences.split(EndOfLine.UNIX)
		    Dim fastaHeading As String
		    for i As Integer = 0 to UBound(seqsFasta)
		      if seqsFasta(i).BeginsWith(">") then
		        fastaHeading = ReplaceAll(seqsFasta(i), " ", "_")
		        LogoWinSequences.Value(fastaHeading) = seqsFasta(i + 1)
		      end
		    next
		    
		  else
		    msgBox("LogoWin motif window should contain sequences on which bioprospector search was performed")
		    Return
		  end
		  dlg.ActionButtonCaption = "Select"
		  dlg.Title = "BioProspector results to logo"
		  dlg.PromptText = "Select BioProspector file with motifs search results"
		  inputData = dlg.ShowModal
		  If inputData <> Nil Then
		    instream = TextInputStream.Open(inputData)
		    rawData = instream.ReadAll
		    firstBlockMatch = FirstBlock.Search(rawData)
		    secBlockMatch = SecBlock.Search(rawData)
		    If firstBlockMatch <> Nil Then
		      firstBlockWidth = val(firstBlockMatch.SubExpressionString(0))
		    End
		    If secBlockMatch <> Nil Then
		      secBlockWidth = val(secBlockMatch.SubExpressionString(0))
		      If secBlockWidth = 0 Then
		        twoBlockMotif = False
		      End 
		    End
		    motifBlocks = rawData.split("Motif #")
		    For i as Integer = 1 to ubound(motifBlocks)
		      motifEntries = New BioProsMotifs
		      FastaHeaderMatch = FastaHeader.Search(motifBlocks(i))
		      do
		        motifSite = New BioProsMotifSite
		        if FastaHeaderMatch <> Nil Then
		          heading = FastaHeaderMatch.SubExpressionString(0)
		          motifSite.heading = Rtrim(Nthfield(heading, "len", 1))
		          valueMatch = StrandCheck.Search(heading)
		          if valueMatch <> Nil Then
		            motifSite.strand = "f"
		            valueMatch = FBlockWidth.Search(heading)
		            do
		              If valueMatch <> Nil then
		                values.Append(val(valueMatch.SubExpressionString(0)))
		              End
		              valueMatch = FBlockWidth.Search
		            loop until valueMatch = Nil
		          else
		            motifSite.strand = "r"
		            valueMatch = RBlockWidth.Search(heading)
		            do
		              If valueMatch <> Nil then
		                values.Append(val(valueMatch.SubExpressionString(0)))
		              End
		              valueMatch = RBlockWidth.Search
		            loop until valueMatch = Nil
		          end
		          heading = ReplaceAll(motifSite.heading, " ", "_")
		          if motifSite.strand = "r" then
		            siteSeq = ReverseComplement(LogoWinSequences.Value(heading))
		          else
		            siteSeq = LogoWinSequences.Value(heading)
		          end
		          seqLength = lenb(siteSeq)
		          if Ubound(values) = 0 Then
		            if motifSite.strand = "r" Then
		              motifSite.firstBlockStart = seqLength-values(0)
		            else
		              motifSite.firstBlockStart = values(0)
		            end
		            motifSite.firstBlockSeq = mid(siteSeq, motifSite.firstBlockStart, firstBlockWidth)
		          ElseIf Ubound(values) = 1 Then
		            if motifSite.strand = "r" Then
		              motifSite.firstBlockStart = seqLength-values(0)+1
		              motifSite.secondBlockStart = seqLength-values(1)+1
		            else
		              motifSite.firstBlockStart = values(0)
		              motifSite.secondBlockStart = values(1)
		            end
		            motifSite.firstBlockSeq = mid(siteSeq, motifSite.firstBlockStart, firstBlockWidth)
		            motifSite.SecondBlockSeq = mid(siteSeq, motifSite.secondBlockStart, secBlockWidth)
		            motifSite.interBlockSeq = mid(siteSeq, motifSite.firstBlockStart+firstBlockWidth, motifSite.secondBlockStart-(motifSite.firstBlockStart+firstBlockWidth))
		          End
		          redim values(-1)
		          motifEntries.Entries.append(motifSite)
		        end if
		        FastaHeaderMatch = FastaHeader.Search
		      loop until FastaHeaderMatch = nil
		      Motifs.value("Motif#"+str(i)) = motifEntries
		    Next
		    dim clustalalign as FolderItem = TemporaryFolder.Child("gapmotifseq.align")
		    if clustalalign.Exists Then
		      clustalalign.Remove
		    end
		    ' to do: make run only for two block motifs
		    ' imrove window for logo demonstration
		    Dim cli as String
		    Dim motifEntryFasta As String
		    Dim output(-1) As String
		    Dim EntryM as BioProsMotifs
		    Dim alignedSeq as Dictionary
		    Dim m as Motif
		    Dim s as Site
		    Dim w as ChipMLogo
		    me.bioprospectLogo =True
		    w = New ChipMLogo
		    Dim count as integer = 1
		    if Motifs.KeyCount <> 0 then
		      for each Entry as DictionaryEntry in Motifs
		        m = New Motif
		        EntryM = Entry.Value
		        if twoBlockMotif then
		          for each Site as BioProsMotifSite in EntryM.Entries
		            motifEntryFasta = motifEntryFasta + Site.heading + EndOfLine.UNIX + Site.interBlockSeq + EndOfLine.UNIX
		          next
		          outstream = TextOutputStream.Create(clustalalign)
		          outstream.Write(ConvertEncoding(motifEntryFasta, Encodings.UTF8))
		          outstream.Close
		          cli = ClustalPath + " -i "+clustalalign.NativePath
		          #If TargetWindows
		            ExecuteWSL(cli)
		          #Else
		            UserShell(cli)
		          #endif
		          if shError <> 0 then
		          else
		            output = shResult.split(EndOfLine.UNIX)
		            alignedSeq = new Dictionary
		            for  i as integer = 0 to UBound(output)
		              if output(i).BeginsWith(">") then
		                alignedSeq.value(ReplaceAll(output(i), " ", "_")) = output(i+1)
		              end
		            next
		            redim output(-1)
		            for each Site as BioProsMotifSite in EntryM.Entries
		              s = New Site
		              heading = ReplaceAll(Site.heading, " ", "_")
		              Site.seqComplete = Site.firstBlockSeq + alignedSeq.value(heading) +  Site.SecondBlockSeq
		              s.id = heading
		              s.seq = Site.seqComplete
		              m.Sites.Append(s)
		              m.fasta = m.fasta + s.id + EndOfLine.UNIX + s.seq  + EndOfLine.UNIX
		            next
		          end
		        else
		          for each Site as BioProsMotifSite in EntryM.Entries
		            s = New Site
		            heading = ReplaceAll(Site.heading, " ", "_")
		            s.id = heading
		            s.seq = Site.firstBlockSeq
		            m.Sites.Append(s)
		            m.fasta = m.fasta + s.id + EndOfLine.UNIX + s.seq  + EndOfLine.UNIX
		          next
		        end
		        
		        m.number = count
		        count = count + 1
		        w.Motifs.Append(m)
		      next
		    end
		    
		    w.populateListbox
		    w.Title="Found motifs" 
		    w.Visible=True
		    me.bioprospectLogo = False
		    
		    
		  End If
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub BioProspectorLogoW()
		  dim dlg As New SaveFileDialog
		  dim BioPOutput As New FolderItem 
		  dim SeqSource As New FolderItem 
		  dim w As BioProspectWin
		  
		  SeqSource = TemporaryFolder.Child("bioprospector_input_seq")
		  dlg.ActionButtonCaption = "Select"
		  dlg.Title = "File for search results "
		  dlg.PromptText = "BioProspector output file" 
		  
		  BioPOutput = dlg.ShowModal
		  
		  If BioPOutput <> Nil Then
		    w = New BioProspectWin
		    w.launcher = "logowin"
		    While BioProsWinClosed <> True
		      App.DoEvents
		    Wend
		    If BioPrSettingsSaved Then
		      if SeqSource.Exists Then
		        SeqSource.delete 
		      end
		      dim outstream as TextOutputStream
		      outstream = TextOutputStream.Create(SeqSource)
		      outstream.Write(ConvertEncoding(Sequences, Encodings.UTF8))
		      outstream.Close
		      dim returncode as Integer
		      LogoWin.WriteToSTDOUT("Path to store output result: "+BioPOutput.NativePath+EndOfLine.UNIX)
		      LogoWin.WriteToSTDOUT("Running BioProspector...")
		      returncode = BioProspector(SeqSource,BioPOutput)
		      if returncode = 0 Then
		        LogoWin.WriteToSTDOUT("ok."+EndOfLine.UNIX)
		      else
		        LogoWin.WriteToSTDOUT("failed."+EndOfLine.UNIX)
		        LogoWin.WriteToSTDOUT(shResult)
		      end
		    end
		    
		  else
		    
		  End If
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub BuildTBButtonMenu()
		  //create the menu for the first toolbar button
		  Dim ButtMenu as New MenuItem
		  Dim aMenuItem as MenuItem
		  dim m,n as integer
		  dim f as folderitem
		  dim MenuTexts(0) as string
		  
		  f=Profile_f
		  if f=nil then
		    msgbox "Profile folder is missing."
		    exit
		  end if
		  m=f.Count
		  for n=1 to m
		    if f.Item(n).name<>".DS_Store" then
		      'if f.Item(n).Directory then
		      ''skip folder
		      'else
		      if right(f.Item(n).DisplayName,4)=".sig" then
		        MenuTexts.append nthfield(f.Item(n).Name,".sig",1) 'drop the extension
		      end if
		    end if
		  next
		  
		  'the array and its sorting is required on Linux as file order in a folder is unpredictable 
		  MenuTexts.Sort
		  m=ubound(MenuTexts)
		  for n=1 to m
		    aMenuItem = new MenuItem
		    aMenuItem.text = MenuTexts(n)
		    ButtMenu.Append aMenuItem
		  next
		  
		  
		  
		  
		  #if TargetCocoa then               'a workaround for toolbar deficiency on Mac
		    aMenuItem = new MenuItem
		    aMenuItem.text = "-"
		    ButtMenu.Append aMenuItem
		    aMenuItem = new MenuItem
		    aMenuItem.text = "More..."
		    ButtMenu.Append aMenuItem
		    
		  #endif
		  //assign the new menu to the toolitem..
		  toolbutton(LogoWinToolBar.Item(0)).DropdownMenu=ButtMenu
		  
		  Exception err
		    ExceptionHandler(err,"LogoWinToolbar:BuildTBButtonMenu")
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub ChangeView(View As string)
		  Select Case View
		    
		  case "Logo"
		    if SeqsChanged then
		      dim TFname as string
		      TFname=nthfield(ProfileWizardWin.ValueField.Text," ",1)
		      if TFname="" then 
		        TFname="TrfX"
		      end if
		      dim BSfastaFile as folderitem = TemporaryFolder.child(TFname+".fasta")
		      if BSfastaFile<>nil then
		        dim outstream As TextOutputStream
		        outstream = TextOutputStream.Create(BSfastaFile)
		        outstream.write(trim(Informer.text))
		        outstream.close
		        LoadAlignment(BSfastaFile)
		        'SeqsChanged=False
		        
		        if LengthsDiffer then
		          logowin.ChangeView("Sequences")
		          logowin.LogoTabs.value=1
		          return
		        else
		          logowin.ChangeView("Logo")
		          logowin.LogoTabs.value=0
		        end if
		        MEMEdata=""
		        if NOT LengthsDiffer then
		          WriteToSTDOUT("Edited alignment loaded."+EndOfLine.unix)
		        end if
		      end if
		    end if
		    
		    if NOT LengthsDiffer then
		      ViewLogo.Checked=true
		      ViewSequences.Checked=false
		      TopPanel.Value=1
		    end if
		    ViewAlignmentInfo.checked=false
		    ViewHideViewer.Checked=false
		    ViewHmmerSettings.Checked=false
		    ViewHmmProfile.Checked=false
		    ViewMEMEresults.checked=false
		    ControlAdjust
		    LogoCanvas.visible=true
		    'LogoCanvas.Enabled=true
		    'Informer.visible=false
		    'Informer.enabled=false
		    
		    TopPanel.visible=false
		    LogoCanvas.visible=True
		    LogoTabs.Visible=True
		    DownshiftLog true
		  case "Sequences"
		    if ViewSequences.Checked=false then
		      ViewLogo.Checked=false
		      ViewAlignmentInfo.checked=false
		      ViewHideViewer.Checked=false
		      ViewHmmerSettings.Checked=false
		      ViewHmmProfile.Checked=false
		      ViewMEMEresults.checked=false
		      Informer.text=Sequences
		      Informer.ReadOnly=false
		      TopPanel.Value=0
		      informer.visible=true
		      TopPanel.visible=true
		      DownshiftLog true
		      ViewSequences.Checked=true
		      informer.SetFocus
		      HScrollBar.Visible=False
		      TopPanel.left=0 
		      TopPanel.height=splitter.top-LogoTabs.height
		      splitter.left=0
		      STDOUT.top=splitter.top+splitter.height
		      LogoCanvas.visible=False
		      
		    else
		      ViewSequences.Checked=true
		    end
		    LogoTabs.Visible=True
		    
		  Case "Info"
		    ViewLogo.Checked=false
		    ViewSequences.Checked=false
		    ViewAlignmentInfo.checked=true
		    ViewHideViewer.Checked=false
		    ViewHmmerSettings.Checked=false
		    ViewHmmProfile.Checked=false
		    ViewMEMEresults.checked=false
		    Informer.Text=Info
		    Informer.ReadOnly=true
		    TopPanel.value=0
		    informer.visible=true
		    TopPanel.visible=true
		    HScrollBar.Visible=False
		    TopPanel.height=splitter.top-LogoTabs.height
		    DownshiftLog true
		    informer.SetFocus
		    LogoCanvas.visible=False
		    LogoTabs.Visible=True
		  case "HideViewer"
		    If TopPanel.Visible Or LogoCanvas.visible Then
		      
		      'store current state
		      if ViewLogo.Checked then
		        CheckState="ViewLogo"
		      elseif ViewSequences.Checked then
		        CheckState="ViewSequences"
		      elseif ViewAlignmentInfo.checked then
		        CheckState="ViewAlignmentInfo"
		      elseif ViewHmmerSettings.Checked then
		        CheckState="ViewHmmerSettings"
		      elseif ViewHmmProfile.Checked then
		        CheckState="ViewHmmProfile"
		      elseif ViewMEMEresults.checked then
		        CheckState="ViewMEMEresults"
		      end if
		      
		      ViewLogo.Checked=false
		      ViewSequences.Checked=false
		      ViewAlignmentInfo.checked=false
		      ViewHideViewer.Checked=true
		      ViewHmmerSettings.Checked=false
		      ViewHmmProfile.Checked=false
		      ViewMEMEresults.checked=false
		      TopPanel.visible=false
		      LogoCanvas.visible=false
		      DownshiftLog false
		      HScrollBar.Visible=False
		      LogoTabs.Visible=False
		    Else
		      ViewHideViewer.Checked=false
		      
		      'restore previous state:
		      select case CheckState
		      case "ViewLogo"
		        ViewLogo.Checked=true
		      case "ViewSequences"
		        ViewSequences.Checked=true
		      case "ViewAlignmentInfo"
		        ViewAlignmentInfo.checked=true
		      case "ViewHmmerSettings"
		        ViewHmmerSettings.Checked=true
		      case "ViewHmmProfile"
		        ViewHmmProfile.Checked=true
		      case "ViewMEMEresults"
		        ViewMEMEresults.checked=true
		        
		      end select
		      
		      LogoCanvas.visible=true
		      TopPanel.visible=true
		      DownshiftLog True
		      LogoTabs.Visible=True
		    end if
		  case "Settings"
		    ViewLogo.Checked=false
		    ViewSequences.Checked=false
		    ViewAlignmentInfo.checked=false
		    ViewHideViewer.Checked=false
		    ViewHmmerSettings.Checked=true
		    ViewHmmProfile.Checked=false
		    ViewMEMEresults.checked=false
		    Informer.Text=ProfileSettings
		    Informer.ReadOnly=true
		    TopPanel.visible=true
		    TopPanel.Value=0
		    informer.visible=true
		    HScrollBar.Visible=False
		    TopPanel.height=splitter.top-LogoTabs.height
		    DownshiftLog true
		    LogoCanvas.visible=False
		    LogoTabs.Visible=True
		  case "HMM"
		    ViewLogo.Checked=false
		    ViewSequences.Checked=false
		    ViewAlignmentInfo.checked=false
		    ViewHideViewer.Checked=false
		    ViewHmmerSettings.Checked=False
		    ViewHmmProfile.Checked=true
		    ViewMEMEresults.checked=false
		    Informer.Text=HmmProfile
		    Informer.ReadOnly=true
		    TopPanel.Value=0
		    TopPanel.visible=true
		    informer.visible=true
		    HScrollBar.Visible=False
		    TopPanel.height=splitter.top-LogoTabs.height
		    DownshiftLog true
		    LogoCanvas.visible=false
		  case "MEME"
		    ViewLogo.Checked=false
		    ViewSequences.Checked=false
		    ViewAlignmentInfo.checked=false
		    ViewHideViewer.Checked=false
		    ViewHmmerSettings.Checked=False
		    ViewHmmProfile.Checked=false
		    ViewMEMEresults.checked=true
		    Informer.text=MEMEdata
		    Informer.ReadOnly=true
		    TopPanel.Value=0
		    TopPanel.visible=true
		    informer.visible=true
		    HScrollBar.Visible=False
		    TopPanel.height=splitter.top-LogoTabs.height
		    DownshiftLog true
		    LogoCanvas.visible=false
		  End Select
		  
		  if View="Logo" then
		    Splitter.Enabled=false
		  else
		    Splitter.Enabled=True
		  End If
		  informer.VerticalScrollPosition=0
		  LogoTabs.RePaint
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Function CleanedProfileCopy(tmpfile as folderItem) As folderItem
		  ' removes restricted characters (CleanUpReg) in file, creates a copy in OS temporary location, works fast if length of RawRead string  doesn't exceed 10000 characters
		  
		  'dim FileLocation as folderitem = TemporaryFolder.child(tmpfile.Name)
		  ''dim FileLocation2 as folderitem = TemporaryFolder.child("1"+tmpfile.Name)
		  'dim tos as new TextOutputStream
		  'dim tis as TextInputStream
		  'dim stream as BinaryStream
		  'dim RawRead, Seq, Achar as String
		  '
		  ''two temporary files needed to awoid IOexception (file remains locked for some reason!)
		  'tis=TextInputStream.Open(tmpfile)
		  'if FileLocation<>Nil then
		  'if FileLocation.exists then
		  'FileLocation.Delete
		  'if FileLocation.exists then
		  'FileLocation = TemporaryFolder.child("1"+tmpfile.Name)
		  'if FileLocation<>Nil then
		  'if FileLocation.exists then
		  'FileLocation.Delete
		  'end if
		  'end if
		  'end if
		  'If FileLocation.LastErrorCode > 0 Then
		  'MsgBox("Error "+Str(FileLocation.LastErrorCode)+" trying to delete tmp file")
		  'end if
		  'end if
		  'tos = TextOutputStream.Create(FileLocation) 
		  
		  'stream = BinaryStream.Create(FileLocation, True) // Overwrite if exists
		  
		  'end if
		  
		  dim FileLocation as folderitem = TemporaryFolder.child("1"+tmpfile.Name)
		  Dim tos As TextOutputStream
		  dim tis as TextInputStream
		  dim RawRead, Seq, Achar as String
		  
		  tis=TextInputStream.Open(tmpfile)
		  tos = TextOutputStream.Create(FileLocation) 
		  
		  
		  tos.Delimiter = EndOfLine.Unix
		  Do
		    RawRead=Trim(tis.ReadLine)
		    Achar=Left(RawRead,1)
		    if Achar=">" then
		      if len(Seq)>0 then
		        Seq=CleanUpReg(Seq)
		        tos.WriteLine(Seq)
		        'stream.Write(Seq+EndOfLine.UNIX)
		        Seq=""
		      end if
		      tos.WriteLine(RawRead)
		      'stream.Write(RawRead+EndOfLine.UNIX)
		    else
		      Seq=Seq+RawRead
		    end if
		  Loop until tis.EOF
		  if len(Seq)>0 then
		    Seq=CleanUpReg(Seq)
		    tos.WriteLine(Seq)
		    'stream.Write(Seq+EndOfLine.UNIX)
		    Seq=""
		  end
		  tos.close
		  'stream.close
		  tis.close
		  return FileLocation
		  
		  
		  
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub ControlAdjust()
		  'adjusts control positions when alignment file loads
		  if LogoPic<>nil then
		    HScrollBarLast=0
		    HScrollBar.value=0
		    LogoCanvas.left=0
		    splitter.left=0
		    TopPanel.height=175
		    
		    if LogoPic.width>LogoWin.width then
		      HScrollBar.Visible=true
		      HScrollBar.top=TopPanel.height+LogoTabs.height
		      LogoCanvas.Width=Logopic.width
		    else
		      HScrollBar.Visible=false
		      LogoCanvas.width=LogoWin.width
		    end
		    
		    if HScrollBar.visible=true then
		      STDOUT.top=LogoCanvas.Height+HScrollBar.Height+splitter.Height+LogoTabs.height
		      STDOUT.height=Logowin.height-(LogoCanvas.Height+hscrollbar.height+splitter.height+LogoTabs.height)
		      Splitter.top=LogoCanvas.Height+HScrollBar.Height+LogoTabs.height
		    else
		      STDOUT.top=LogoCanvas.Height+splitter.Height+LogoTabs.height
		      STDOUT.height=Logowin.height-(splitter.height+LogoCanvas.Height+LogoTabs.height)
		      Splitter.top=LogoCanvas.Height+LogoTabs.height
		    end
		    
		  end
		  
		  
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub DownshiftLog(boo as boolean)
		  If boo Then
		    if STDOUT.top=0 then
		      TopPanel.left=0
		      Splitter.left=0
		      stdout.top=TopPanel.Height+LogoTabs.Height+5
		      stdout.height=Self.Height-TopPanel.Height-LogoTabs.Height-5
		    else
		      'already down
		    end if
		  else
		    if STDOUT.top=0 then
		      'already up
		    else
		      TopPanel.left=self.width+1 'prevent control overlap
		      Splitter.left=self.width+1
		      STDOUT.top=0
		      STDOUT.height=self.Height
		    end if
		    
		  End If
		  
		  stdout.ScrollPosition=stdout.LineNumber(Len(stdout.Text))
		  stdout.refresh(False)
		  App.DoEvents
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h1
		Protected Sub DrawLogo()
		  'Information content per position as defined by Schneider et al, 1986
		  '
		  ' Ii=2+sum(Fb,i*log2(Fb,i)),
		  '
		  'where i is the position within site, b refers to each of the four bases,
		  'and Fb,i is the frequency of each base at that position
		  
		  dim replicas, baseX, currentX,letterData as integer
		  dim entropy,  LetterHeight, baseY, nextY,freq As double
		  dim posarray(4),letterName as string
		  totalEntropy=0
		  
		  
		  baseX= -3
		  baseY=150
		  
		  
		  dim Acounter(0) as integer
		  dim Ccounter(0) as integer
		  dim Gcounter(0) as integer
		  dim Tcounter(0) as integer
		  dim tis as TextInputStream
		  dim Arow, Achar as string
		  dim n, SeqLen as integer
		  
		  
		  'LogoData is an array of base counts at numbered positions
		  
		  'determine seqlength
		  tis=TextInputStream.Open(Logofile)
		  if tis<>Nil then
		    While Not tis.EOF
		      Arow = tis.ReadLine
		      Arow=trim(Arow) 'just in case
		      Achar=left(Arow,1)
		      if Achar<>">" then
		        SeqLen=len(Arow)
		        exit
		      end if
		    Wend
		  else
		    Msgbox "Can't read alignment data."
		    return
		  end if
		  Redim Acounter(SeqLen)
		  Redim Ccounter(SeqLen)
		  Redim Gcounter(SeqLen)
		  Redim Tcounter(SeqLen)
		  
		  tis=TextInputStream.Open(Logofile)
		  if tis<>Nil then
		    While Not tis.EOF
		      Arow = tis.ReadLine
		      Arow=trim(Arow) 'just in case
		      Achar=left(Arow,1)
		      if Achar<>">" AND len(Arow)>0 then
		        replicas=replicas+1
		        if len(Arow)<>SeqLen then
		          WriteToSTDOUT "The sequences are of different lengths!"+EndOfLine.UNIX
		          WriteToSTDOUT "Can't draw the logo for unaligned sequences, hence just showing them."+EndOfLine.UNIX
		          LengthsDiffer=true
		          MEMEdata=""
		          LogoWin.LogoWinToolbar.Item(4).Enabled=false 'disable 'Palindromise' for unaligned data
		          return
		        else
		          LengthsDiffer=false
		        end if
		        
		        for n=1 to SeqLen
		          Achar=mid(Arow,n,1)
		          select case Achar
		          case "A"
		            Acounter(n)=Acounter(n)+1
		          case "C"
		            Ccounter(n)=Ccounter(n)+1
		          case "G"
		            Gcounter(n)=Gcounter(n)+1
		          case "T"
		            Tcounter(n)=Tcounter(n)+1
		          case "N"
		            'do nothing
		          case "-"
		            'do nothing
		          case else
		            msgbox "Unexpected non-nucleotide character in input (only ACGTN- allowed)."
		            return
		          end select
		        next
		      end if
		      
		    Wend
		  end if
		  
		  LogoPic=new Picture (30*(SeqLen+1),170,32)
		  LogoPic.Transparent=1
		  
		  for n=1 to SeqLen
		    'combine letter names with counts for sorting
		    if Acounter(n)=0 AND Ccounter(n)=0 AND Gcounter(n)=0 AND Tcounter(n)=0 then
		      'some sites (e.g. in RegPrecise) have all 'N' positions
		      entropy=0
		    else
		      posarray(1)=format(Acounter(n),"000")+"A"
		      posarray(2)=format(Ccounter(n),"000")+"C"
		      posarray(3)=format(Gcounter(n),"000")+"G"
		      posarray(4)=format(Tcounter(n),"000")+"T"
		      posarray.Sort
		      entropy=2
		      freq=Acounter(n)/replicas
		      entropy=entropy+freq*log2(freq)
		      freq=Ccounter(n)/replicas
		      entropy=entropy+freq*log2(freq)
		      freq=Gcounter(n)/replicas
		      entropy=entropy+freq*log2(freq)
		      freq=Tcounter(n)/replicas
		      entropy=entropy+freq*log2(freq)
		    end if
		    
		    totalEntropy=totalEntropy+entropy
		    
		    'lowest letter
		    letterData=val(posarray(1))
		    letterName=right(posarray(1),1)
		    LetterHeight=70*entropy*letterData/replicas
		    NextY=baseY-letterheight
		    CurrentX=baseX+n*30
		    select case letterName
		    case "A"
		      LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "C"
		      LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "G"
		      LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "T"
		      LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    end select
		    
		    'second lowest letter
		    letterData=val(posarray(2))
		    letterName=right(posarray(2),1)
		    LetterHeight=70*entropy*letterData/replicas
		    NextY=NextY-LetterHeight
		    select case letterName
		    case "A"
		      LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "C"
		      LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "G"
		      LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "T"
		      LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    end select
		    
		    'third lowest letter
		    letterData=val(posarray(3))
		    letterName=right(posarray(3),1)
		    LetterHeight=70*entropy*letterData/replicas
		    NextY=NextY-LetterHeight
		    select case letterName
		    case "A"
		      LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "C"
		      LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "G"
		      LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "T"
		      LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    end select
		    
		    'topmost letter
		    letterData=val(posarray(4))
		    letterName=right(posarray(4),1)
		    LetterHeight=70*entropy*letterData/replicas
		    NextY=NextY-LetterHeight
		    select case letterName
		    case "A"
		      LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "C"
		      LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "G"
		      LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    case "T"
		      LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		    end select
		    
		  next
		  
		  'draw rulers
		  'horisontal:
		  LogoPic.graphics.DrawLine(baseX+25,BaseY+3,baseX+30*(n),BaseY+3)
		  for n=1 to Seqlen
		    LogoPic.graphics.DrawLine(baseX+15+30*n,BaseY+3,baseX+15+30*n,BaseY+7)
		  next
		  for n=5 to Seqlen step 5
		    LogoPic.graphics.DrawString(str(n),baseX+10+30*n,baseY+20)
		  next
		  
		  'vertical:
		  LogoPic.graphics.DrawLine(baseX+25,BaseY+3,baseX+25,BaseY-140)
		  LogoPic.graphics.DrawLine(baseX+25,BaseY-140,baseX+18,BaseY-140)
		  LogoPic.graphics.DrawLine(baseX+25,BaseY-70,baseX+18,BaseY-70)
		  LogoPic.graphics.DrawLine(baseX+25,BaseY,baseX+18,BaseY)
		  LogoPic.graphics.DrawLine(baseX+25,BaseY-105,baseX+21,BaseY-105)
		  LogoPic.graphics.DrawLine(baseX+25,BaseY-35,baseX+21,BaseY-35)
		  
		  LogoPic.graphics.DrawString("0",6,baseY+5)
		  LogoPic.graphics.DrawString("1",6,baseY-65)
		  LogoPic.graphics.DrawString("2",6,baseY-135)
		  
		  'clear selection arrays to remove selection from previous logo:
		  redim selarray1(0)
		  redim selarray2(0)
		  lastX=0
		  masked=false
		  
		  #if DebugBuild
		    WriteToSTDOUT (EndofLine+"Alignment from "+LogoFile.shellpath+" ("+str(replicas)+" seqs) loaded."+EndofLine)
		  #else
		    WriteToSTDOUT (EndofLine+"The alignment "+" ("+str(replicas)+" seqs) loaded."+EndofLine)
		    
		  #endif
		  WriteToSTDOUT ("Information content of this site is "+str(totalEntropy)+" bits."+EndofLine)
		  LogoCanvas.Invalidate(false) 'there are problems updating the logo pic when scanning genome
		  self.refresh(false) 'needed if logo of the same size is drawn and to remove selection
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:DrawLogo")
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h1
		Protected Sub DrawWebLogo()
		  'Information content per position as defined by Schneider et al, 1986
		  '
		  ' Ii=2+sum(Fb,i*log2(Fb,i)),
		  '
		  'where i is the position within site, b refers to each of the four bases,
		  'and Fb,i is the frequency of each base at that position
		  
		  'No small sample correction!
		  
		  'WebLogo still used, but only to count nucleotides
		  
		  
		  dim n,replicas, baseX, currentX,letterData as integer
		  dim entropy, LetterHeight, baseY, nextY,freq As double
		  dim posarray(4),letterName, Acount, Ccount, Gcount, Tcount as string
		  totalEntropy=0
		  
		  
		  baseX= -3
		  baseY=150
		  'read data from the file into array
		  'ReadLogoData
		  
		  '#if targetlinux then
		  LogoPic=new Picture (30*(ubound(logodata)+1),170,32)
		  '#else
		  'LogoPic=new Picture (30*ubound(logodata),170,32)
		  '#endif
		  LogoPic.Transparent=1
		  
		  if ubound(LogoData)>1 then
		    
		    
		    
		    'format of the data is:
		    '#    A     C     G     T     Entropy    Low    High    Weight
		    '1     1     0     0     19     0.9777     0.6344     1.3210     1.0000
		    '2     13     3     2     2     0.3639     0.1286     0.7196     1.0000
		    
		    
		    'count number of replicates (bases per position)
		    replicas=val(NthField(logodata(1),chr(9),2))+val(NthField(logodata(1),chr(9),3))+val(NthField(logodata(1),chr(9),4))+val(NthField(logodata(1),chr(9),5))
		    
		    'maxentropy correction
		    'maxentropy=0
		    'for n=1 to ubound(LogoData)
		    'entropy=val(NthField(logodata(n),chr(9),8))
		    'if entropy>maxentropy then
		    'maxentropy=entropy
		    'end if
		    'next
		    'maxentropy=2 '(it should be just bits, but apparently isn't)
		    
		    for n=1 to ubound(LogoData)
		      Acount=NthField(logodata(n),chr(9),2)
		      Ccount=NthField(logodata(n),chr(9),3)
		      Gcount=NthField(logodata(n),chr(9),4)
		      Tcount=NthField(logodata(n),chr(9),5)
		      
		      'combine letter names with counts for sorting
		      posarray(1)=format(val(Acount),"000")+"A"
		      posarray(2)=format(val(Ccount),"000")+"C"
		      posarray(3)=format(val(Gcount),"000")+"G"
		      posarray(4)=format(val(Tcount),"000")+"T"
		      posarray.Sort
		      entropy=2
		      freq=val(Acount)/replicas
		      entropy=entropy+freq*log2(freq)
		      freq=val(Ccount)/replicas
		      entropy=entropy+freq*log2(freq)
		      freq=val(Gcount)/replicas
		      entropy=entropy+freq*log2(freq)
		      freq=val(Tcount)/replicas
		      entropy=entropy+freq*log2(freq)
		      totalEntropy=totalEntropy+entropy
		      
		      'lowest letter
		      letterData=val(posarray(1))
		      letterName=right(posarray(1),1)
		      LetterHeight=70*entropy*letterData/replicas
		      NextY=baseY-letterheight
		      CurrentX=baseX+n*30
		      select case letterName
		      case "A"
		        LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "C"
		        LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "G"
		        LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "T"
		        LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      end select
		      
		      'second lowest letter
		      letterData=val(posarray(2))
		      letterName=right(posarray(2),1)
		      LetterHeight=70*entropy*letterData/replicas
		      NextY=NextY-LetterHeight
		      select case letterName
		      case "A"
		        LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "C"
		        LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "G"
		        LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "T"
		        LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      end select
		      
		      'third lowest letter
		      letterData=val(posarray(3))
		      letterName=right(posarray(3),1)
		      LetterHeight=70*entropy*letterData/replicas
		      NextY=NextY-LetterHeight
		      select case letterName
		      case "A"
		        LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "C"
		        LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "G"
		        LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "T"
		        LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      end select
		      
		      'topmost letter
		      letterData=val(posarray(4))
		      letterName=right(posarray(4),1)
		      LetterHeight=70*entropy*letterData/replicas
		      NextY=NextY-LetterHeight
		      select case letterName
		      case "A"
		        LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "C"
		        LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "G"
		        LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "T"
		        LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      end select
		      
		    next
		    
		    'draw rulers
		    'horisontal:
		    '#if targetlinux then
		    LogoPic.graphics.DrawLine(baseX+25,BaseY+3,baseX+30*(n),BaseY+3)
		    for n=1 to ubound(LogoData)
		      LogoPic.graphics.DrawLine(baseX+15+30*n,BaseY+3,baseX+15+30*n,BaseY+7)
		    next
		    for n=5 to ubound(LogoData) step 5
		      LogoPic.graphics.DrawString(str(n),baseX+10+30*n,baseY+20)
		    next
		    '#else
		    'LogoPic.graphics.DrawLine(baseX+25,BaseY+3,baseX+30*(n-1),BaseY+3)
		    'for n=1 to ubound(LogoData)-1
		    'LogoPic.graphics.DrawLine(baseX+15+30*n,BaseY+3,baseX+15+30*n,BaseY+7)
		    'next
		    'for n=5 to ubound(LogoData) step 5
		    'LogoPic.graphics.DrawString(str(n),baseX+10+30*n,baseY+20)
		    'next
		    '#endif
		    
		    'vertical:
		    LogoPic.graphics.DrawLine(baseX+25,BaseY+3,baseX+25,BaseY-140)
		    LogoPic.graphics.DrawLine(baseX+25,BaseY-140,baseX+18,BaseY-140)
		    LogoPic.graphics.DrawLine(baseX+25,BaseY-70,baseX+18,BaseY-70)
		    LogoPic.graphics.DrawLine(baseX+25,BaseY,baseX+18,BaseY)
		    LogoPic.graphics.DrawLine(baseX+25,BaseY-105,baseX+21,BaseY-105)
		    LogoPic.graphics.DrawLine(baseX+25,BaseY-35,baseX+21,BaseY-35)
		    
		    LogoPic.graphics.DrawString("0",6,baseY+5)
		    LogoPic.graphics.DrawString("1",6,baseY-65)
		    LogoPic.graphics.DrawString("2",6,baseY-135)
		    
		    'self.Width=LogoPic.width+20
		    'clear selection arrays to remove selection from previous logo:
		    redim selarray1(0)
		    redim selarray2(0)
		    lastX=0
		    masked=false
		    
		    #if DebugBuild
		      WriteToSTDOUT (EndofLine+"Alignment from "+LogoFile.shellpath+" ("+str(replicas)+" seqs) loaded."+EndofLine)
		    #else
		      WriteToSTDOUT (EndofLine+"The alignment "+" ("+str(replicas)+" seqs) loaded."+EndofLine)
		      
		    #endif
		    WriteToSTDOUT ("Information content of this site is "+str(totalEntropy)+" bits."+EndofLine)
		    
		    'Palindromic=false
		    'ChangeView("Logo")
		  else
		    WriteToSTDOUT (EndofLine+"Could not load alignment from "+LogoFile.shellpath+EndofLine)
		    'disable nhmmer:
		    LogoWin.LogoWinToolbar.Item(1).Enabled=false
		    
		  end if
		  
		  LogoCanvas.Invalidate(false) 'there are problems updating the logo pic when scanning genome
		  me.refresh(false) 'needed if logo of the same size is drawn and to remove selection
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:DrawLogo")
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h1
		Protected Sub DrawWebLogo_SScorr()
		  dim n,replicas, baseX, currentX,letterData as integer
		  dim entropy, maxentropy, LetterHeight, baseY, nextY As double
		  dim posarray(4),letterName as string
		  totalEntropy=0
		  
		  ' the calculations below assume the maximal entropy is 1
		  ' this, however, isn't the case, so the max entropy adjustment is required!
		  ' use the 'high' mark in case error bars are to be displayed later
		  
		  baseX= -3
		  baseY=150
		  'read data from the file into array
		  ReadLogoData
		  if ubound(LogoData)>1 then
		    '#if targetlinux then
		    LogoPic=new Picture (30*(ubound(logodata)+1),170,32)
		    '#else
		    'LogoPic=new Picture (30*ubound(logodata),170,32)
		    '#endif
		    LogoPic.Transparent=1
		    
		    
		    'format of the data is:
		    '#    A     C     G     T     Entropy    Low    High    Weight
		    '1     1     0     0     19     0.9777     0.6344     1.3210     1.0000
		    '2     13     3     2     2     0.3639     0.1286     0.7196     1.0000
		    
		    
		    'count number of replicates (bases per position)
		    replicas=val(NthField(logodata(1),chr(9),2))+val(NthField(logodata(1),chr(9),3))+val(NthField(logodata(1),chr(9),4))+val(NthField(logodata(1),chr(9),5))
		    
		    'maxentropy correction
		    maxentropy=0
		    for n=1 to ubound(LogoData)
		      entropy=val(NthField(logodata(n),chr(9),8))
		      if entropy>maxentropy then
		        maxentropy=entropy
		      end if
		    next
		    'maxentropy=2 '(it should be just bits, but apparently isn't)
		    
		    for n=1 to ubound(LogoData)
		      'combine letter names with counts for sorting
		      posarray(1)=format(val(NthField(logodata(n),chr(9),2)),"000")+"A"
		      posarray(2)=format(val(NthField(logodata(n),chr(9),3)),"000")+"C"
		      posarray(3)=format(val(NthField(logodata(n),chr(9),4)),"000")+"G"
		      posarray(4)=format(val(NthField(logodata(n),chr(9),5)),"000")+"T"
		      posarray.Sort
		      entropy=val(NthField(logodata(n),chr(9),6))
		      totalEntropy=totalEntropy+entropy
		      
		      'lowest letter
		      letterData=val(posarray(1))
		      letterName=right(posarray(1),1)
		      LetterHeight=140*(entropy/maxentropy)*letterData/replicas
		      NextY=baseY-letterheight
		      CurrentX=baseX+n*30
		      select case letterName
		      case "A"
		        LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "C"
		        LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "G"
		        LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "T"
		        LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      end select
		      
		      'second lowest letter
		      letterData=val(posarray(2))
		      letterName=right(posarray(2),1)
		      LetterHeight=140*(entropy/maxentropy)*letterData/replicas
		      NextY=NextY-LetterHeight
		      select case letterName
		      case "A"
		        LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "C"
		        LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "G"
		        LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "T"
		        LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      end select
		      
		      'third lowest letter
		      letterData=val(posarray(3))
		      letterName=right(posarray(3),1)
		      LetterHeight=140*(entropy/maxentropy)*letterData/replicas
		      NextY=NextY-LetterHeight
		      select case letterName
		      case "A"
		        LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "C"
		        LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "G"
		        LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "T"
		        LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      end select
		      
		      'topmost letter
		      letterData=val(posarray(4))
		      letterName=right(posarray(4),1)
		      LetterHeight=140*(entropy/maxentropy)*letterData/replicas
		      NextY=NextY-LetterHeight
		      select case letterName
		      case "A"
		        LogoPic.graphics.DrawPicture(A2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "C"
		        LogoPic.graphics.DrawPicture(C2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "G"
		        LogoPic.graphics.DrawPicture(G2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      case "T"
		        LogoPic.graphics.DrawPicture(T2,CurrentX,NextY,30,LetterHeight,0,0,120,140)
		      end select
		      
		    next
		    
		    'draw rulers
		    'horisontal:
		    '#if targetlinux then
		    LogoPic.graphics.DrawLine(baseX+25,BaseY+3,baseX+30*(n),BaseY+3)
		    for n=1 to ubound(LogoData)
		      LogoPic.graphics.DrawLine(baseX+15+30*n,BaseY+3,baseX+15+30*n,BaseY+7)
		    next
		    for n=5 to ubound(LogoData) step 5
		      LogoPic.graphics.DrawString(str(n),baseX+10+30*n,baseY+20)
		    next
		    '#else
		    'LogoPic.graphics.DrawLine(baseX+25,BaseY+3,baseX+30*(n-1),BaseY+3)
		    'for n=1 to ubound(LogoData)-1
		    'LogoPic.graphics.DrawLine(baseX+15+30*n,BaseY+3,baseX+15+30*n,BaseY+7)
		    'next
		    'for n=5 to ubound(LogoData) step 5
		    'LogoPic.graphics.DrawString(str(n),baseX+10+30*n,baseY+20)
		    'next
		    '#endif
		    
		    'vertical:
		    LogoPic.graphics.DrawLine(baseX+25,BaseY+3,baseX+25,BaseY-140)
		    LogoPic.graphics.DrawLine(baseX+25,BaseY-140,baseX+18,BaseY-140)
		    LogoPic.graphics.DrawLine(baseX+25,BaseY-70,baseX+18,BaseY-70)
		    LogoPic.graphics.DrawLine(baseX+25,BaseY,baseX+18,BaseY)
		    LogoPic.graphics.DrawLine(baseX+25,BaseY-105,baseX+21,BaseY-105)
		    LogoPic.graphics.DrawLine(baseX+25,BaseY-35,baseX+21,BaseY-35)
		    
		    LogoPic.graphics.DrawString("0",6,baseY+5)
		    LogoPic.graphics.DrawString("1",6,baseY-65)
		    LogoPic.graphics.DrawString("2",6,baseY-135)
		    
		    'self.Width=LogoPic.width+20
		    'clear selection arrays to remove selection from previous logo:
		    redim selarray1(0)
		    redim selarray2(0)
		    lastX=0
		    masked=false
		    LogoCanvas.Invalidate(false) 'there are problems updating the logo pic when scanning genome
		    me.refresh(false) 'needed if logo of the same size is drawn and to remove selection
		    
		    #if DebugBuild
		      WriteToSTDOUT (EndofLine+"Alignment from "+LogoFile.shellpath+" ("+str(replicas)+" seqs) loaded."+EndofLine)
		    #else
		      WriteToSTDOUT (EndofLine+"The alignment "+" ("+str(replicas)+" seqs) loaded."+EndofLine)
		    #endif
		    
		    WriteToSTDOUT ("Binding site entropy is "+str(totalEntropy)+"."+EndofLine)
		    
		    'Palindromic=false
		    ChangeView("Logo")
		    LogoTabs.value=0
		  else
		    WriteToSTDOUT (EndofLine+"Could not load alignment from "+LogoFile.shellpath+EndofLine)
		  end if
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:DrawLogo")
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub filerRedundancy()
		  dim InputStream as TextInputStream
		  dim fasta as String
		  dim sequence, revSequence as String
		  dim FastaArray(-1), UniqueSites as String
		  dim count as Integer = 0
		  
		  
		  
		  if LogoFile<>Nil then
		    InputStream = TextInputStream.Open(LogoFile)
		    fasta = InputStream.ReadAll
		    FastaArray  = fasta.Split(">")
		    for i as Integer = 1 to UBound(FastaArray)
		      if FastaArray(i)<>"" then 
		        sequence = NthField(FastaArray(i),EndOfLine.UNIX,2)
		        revSequence = ReverseComplement(sequence)
		        if UniqueSites.IndexOf(sequence)=-1 and UniqueSites.IndexOf(revSequence)=-1 then
		          UniqueSites=UniqueSites+">"+FastaArray(i)
		        else
		          count=count+1
		        end
		      end
		    next
		    if UniqueSites<>"" then
		      LogoWin.WriteToSTDOUT(EndOfLine.UNIX+"Sequences set without duplicates ("+str(count)+" sequences have been removed):"+EndOfLine.UNIX+UniqueSites)
		    end
		  end
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Function HmmGen() As boolean
		  'returns true if completed without errors
		  
		  'outfile must be set before calling this method
		  
		  'GenomeFile=GetOpenFolderItem("")
		  
		  dim HitName as string
		  if GenomeFile<> nil then
		    dim cli as string
		    
		    
		    'usage:
		    'HmmGen <report_file>  <input_file> <output_file> [options]
		    '
		    'This script allows to add features to a genbank file according to nhmmer
		    'results. Requires Biopython 1.64 (or newer)
		    '
		    'positional arguments:
		    'report_file           path to nhmmer report file produced with -tblout
		    'option.
		    'input_file            path to input Genbank file.
		    'output_file           path to output Genbank file.
		    '
		    'optional arguments:
		    '-h, --help            show this help message and exit
		    '-L <integer> or <integer>:<integer>, --length <integer> or <integer>:<integer>
		    'maximal and minimal allowed length of profile to
		    'genome alignment.
		    '-q [<key#"value"> [<key#"value"> ...]], --qual [<key#"value"> [<key#"value"> ...]]
		    'add this qualifier to each annotated feature.
		    '-p, --palindromic     filter palindromic sites.
		    '-n, --name            don't pick 'locus_tag' and 'gene' qualifiers from the
		    'next CDS feature.
		    '-E <float or integer>, --eval <float or integer>
		    'threshold E-Value.
		    '-i, --insert          don't add features inside CDS
		    '-b <integer>, --boundary <integer>
		    'set allowed length boundary for hits being within
		    'features
		    '-d, --duplicate       no duplicate features with the same location and the
		    'same protein_bind qualifier value
		    '-v, --version         show program's version number and exit
		    '-f <"feature key">, --feature <"feature key">
		    'feature key to add (promoter, protein_bind etc.)
		    
		    
		    
		    if outfile<>nil then
		      WriteToSTDOUT (EndofLine+EndofLine+"Running the HmmGen script..."+EndofLine)
		      dim GenomeFilePath,outFilePath as string
		      #if TargetWindows
		        'GenomeFilePath=GetShortPathName(GenomeFile.shellpath)
		        FixPath4Windows(outfile)
		        GenomeFilePath=chr(34)+GenomeFile.shellpath+chr(34)
		        outFilePath=chr(34)+outFile.ShellPath+chr(34)
		      #else
		        GenomeFilePath=GenomeFile.shellpath
		        outFilePath=outFile.ShellPath
		      #endif
		      
		      cli=pythonPath+PlaceQuotesToPath(hmmGenPath)+" "+PlaceQuotesToPath(nhmmerResultFile.ShellPath)+" "+PlaceQuotesToPath(GenomeFilePath)+" "+PlaceQuotesToPath(outFilePath)+" "+HmmGenOptions
		      
		      userShell(cli)
		      If shError=0 Then
		        'store hit number for genome scan:
		        dim LastHitStr as string
		        LastHitStr=NthField(shResult,"Features added:",3)
		        LastHitStr=NthField(LastHitStr,"CPU time:",1)
		        LastHitNo=Val(LastHitStr)
		        
		        WriteToSTDOUT (EndofLine+shResult)
		        
		        
		        dim ms,t1 as double
		        ms=microseconds
		        
		        'display the hits in the browser:
		        if HmmGenSettingsWin.GenomeBrowserCheckBox.value then
		          
		          
		          redim GenomeWin.HmmHits(0)
		          redim GenomeWin.HmmHitDescriptions(0)
		          redim genomeWin.HmmHitNames(0)
		          
		          dim m,n,o,colonPos as integer
		          dim currentHit,HitInfo, hits2sort(0),hitloc as string
		          
		          'sort the hits according to genome position:
		          m=CountFields(shResult,"location: [")
		          for n=2 to m
		            currentHit=nthfield(shResult,"location: [",n)
		            colonPos=instrb(currenthit,":")
		            hitloc=nthfield(currentHit,":",1)
		            if lenb(hitLoc)<8 then 'assuming genome length is less than 100Mb
		              for o=0 to 8-lenb(hitLoc)
		                hitloc="0"+hitloc
		              next
		            end if
		            hitloc=hitloc+midb(currenthit,colonpos,lenb(currentHit)-colonpos)
		            hits2sort.append hitloc'+midb(currenthit,colonpos,lenb(currentHit)-colonpos)
		            'nthfield(sh.result,"location: [",n)
		          next
		          hits2sort.Sort
		          m=ubound(hits2sort)
		          for n=1 to m
		            while left(hits2sort(n),1)="0"
		              hits2sort(n)=right(hits2sort(n),lenb(hits2sort(n))-1)
		            wend
		          next
		          
		          'add sorted hits and their info into genome browser arrays:
		          'hmmgen result:
		          '2233715:2233745](-)
		          'qualifiers:
		          'Key: bound_moiety, Value: ['HrpL alternative sigma factor']
		          'Key: gene, Value: ['hrpJ']
		          'Key: inference, Value: ['profile:nhmmer:3.1b1']
		          'Key: locus_tag, Value: ['OA04_20620']
		          'Key: note, Value: nhmmer score 12.8 E-value 1.2
		          'Key: regulatory_class, Value: ['promoter']
		          'type: regulatory
		          
		          for n=1 to ubound(hits2sort)
		            currentHit=hits2sort(n)
		            GenomeWin.HmmHits.append(val(nthfield(currentHit,":",1)))
		            HitInfo=nthfield(currentHit,"]",1)+" ("+right(nthfield(currentHit,")",1),1)+") "
		            HitInfo=HitInfo+nthfield(nthfield(currentHit,"bound_moiety, Value: ['",2),"']",1)
		            HitInfo=HitInfo+" "+NthField(nthfield(currentHit,"nhmmer ",2),Endofline,1)
		            HitName=""
		            if instr(currenthit,"Key: gene")>0 then
		              'extract gene name
		              Hitname=nthfield(currentHit,"Key: gene, Value: ['",2)
		              Hitname=nthfield(HitName,"']",1)+" "
		            end if
		            'add locus_tag
		            Hitname=Hitname+nthfield(nthfield(currentHit,"Key: locus_tag, Value: ['",2),"']",1)+" "
		            
		            Hitinfo=Replace(HitInfo,"score ","Score=")
		            Hitinfo=Replace(HitInfo,"E-value ","E-value=")
		            genomeWin.HmmHitDescriptions.append HitInfo
		            genomeWin.HmmHitNames.append HitName
		            
		          next
		          
		          'initialise array to select/deselect hits:
		          redim genomeWin.HmmHitChecked(ubound(hits2sort))
		          for n=1 to ubound(hits2sort)
		            genomeWin.HmmHitChecked(n)=true
		          next
		          genomeWin.AnyHitDeselected=false
		        end if
		        
		        
		        
		        if Ubound(genomeWin.HmmHits)>0 then
		          if NOT ScanningGenome then
		            WriteToSTDOUT (EndofLine.unix+"Genbank file with added features written to "+outFile.ShellPath+EndofLine)
		          end if
		          
		          WriteToSTDOUT (EndofLine.unix+"Loading the GenBank file...")
		          
		          'Set the genome map scrollbar:
		          Genomewin.SetScrollbar
		          
		          'Display the hit:
		          genomeWin.CurrentHit=1
		          Dim s0 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 0 )
		          s0.Enabled=false 'first hit: there's no previous one
		          Dim s1 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 1 )
		          s1.Title="1/"+str(UBound(genomeWin.HmmHits))
		          Dim s2 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 2 )
		          if Ubound(genomeWin.HmmHits)>1 then
		            s2.enabled=true
		          else
		            s2.enabled=false
		          end if
		          
		        end if
		        return true
		      else
		        WriteToSTDOUT (EndofLine+"HmmGen error code: "+Str(shError)+EndofLine)
		        WriteToSTDOUT (EndofLine+shResult)
		        WriteToSTDOUT (EndofLine+"HmmGen command line was: "+cli+EndofLine)
		        return false
		      end if
		    else
		      return false
		    end if
		    
		  end if
		  
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:HmmGen")
		    
		End Function
	#tag EndMethod

	#tag Method, Flags = &h1
		Protected Sub HmmGenSearch()
		  HmmGenOptions=""
		  HmmGenSettingsWin.showmodalwithin(self)
		  if HmmGenSettingsWin.OKpressed then
		    if GenomeFile<>Nil then
		      dim fn as string=nthfield(GenomeFile.Name,".",1)+"_"+nthfield(Logofile.Name,".",1)+".gb"
		      outfile=GetSaveFolderItem("????",fn)
		      if outfile<>nil then
		        if HmmGen then
		          if HmmGenSettingsWin.GenomeBrowserCheckBox.Value then 'Load the Seq into browser
		            if ubound(GenomeWin.HmmHitDescriptions)>0 then
		              GenomeWin.opengenbankfile(outFile)
		              genomeWin.ShowHit
		              WriteToSTDOUT (" done."+EndofLine)
		            end if
		          end if
		        end if
		      end if
		    else
		      MsgBox "No genome file selected. Please repeat nhmmer search."
		    end if
		  end if
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Function hmmsearch() As boolean
		  'returns true if completed without errors
		  
		  hmmSearchSettingsWin.ShowModalWithin(self)
		  if hmmSearchSettings="" then
		    return false
		    
		  end if
		  
		  dim cli as string
		  
		  
		  
		  if GenomeFile=Nil then
		    WriteToSTDOUT("Please select a file to search first.")
		    return false
		  end if
		  
		  'export protein fastas:
		  dim CDSfasta as folderitem
		  CDSfasta=TemporaryFolder.child("CDS.fasta")
		  
		  if CDSfasta<>nil then
		    GenomeWin.ExportProteins(CDSfasta)
		    cli=""
		    
		    
		    FixPath4Windows(CDSfasta)
		    
		    dim genomefilepath as string
		    #if TargetWindows
		      'GenomeFilePath=GetShortPathName(GenomeFile.shellpath)
		      GenomeFilePath=chr(34)+GenomeFile.shellpath+chr(34)
		    #else
		      GenomeFilePath=GenomeFile.shellpath
		    #endif
		    
		    dim modelFile as string
		    modelFile=hmmSearchSettingsWin.PopupFiles(hmmSearchSettingsWin.PfamPopup.ListIndex-1)
		    
		    dim HmmSearchPath as string
		    #if TargetWindows
		      'GenomeFilePath=GetShortPathName(GenomeFile.shellpath)
		      HmmSearchPath=replace(nhmmerPath,"nhmmer","hmmsearch")
		    #else
		      HmmSearchPath=replace(nhmmerPath,"/nhmmer","/hmmsearch")
		    #endif
		    cli=HmmSearchPath+" "+PlaceQuotesToPath(MakeWSLPath(hmmSearchSettings))+" "+modelFile+" "+PlaceQuotesToPath(MakeWSLPath(CDSfasta.ShellPath)) ' +" -o "+nhmmerResultFile.shellpath
		    
		    
		    WriteToSTDOUT (EndofLine+"Running hmmsearch...")
		    #If TargetWindows
		      ExecuteWSL(cli)
		    #Else
		      UserShell(cli)
		    #endif
		    If shError=0 Then
		      WriteToSTDOUT (EndofLine+shResult)
		      'LogoWinToolbar.Item(2).Enabled=true
		      LastSearch="hmmsearch"
		      return true
		    else
		      WriteToSTDOUT (EndofLine+shResult)
		      MsgBox "hmmsearch error code: "+Str(shError)
		      WriteToSTDOUT (EndofLine+"hmmsearch command line was: "+cli+EndofLine)
		      'LogoWinToolbar.Item(2).Enabled=false
		      return false
		    end if
		  end if
		  
		  
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:nhmmer")
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub LoadAlignment(tmpfile as folderitem)
		  Dim HmmAccession, SigmoIDaccession, SigmoIDtag As String
		  
		  if tmpfile<> nil then
		    TF_HMM=""
		    CRtag=""
		    SeedProteinID=""
		    SeedProteinSeq=""
		    
		    Dim vv As VirtualVolume
		    vv=tmpfile.openAsVirtualVolume
		    If vv<> Nil Or (tmpfile.Directory And Right(tmpfile.Name,4)=".sig") Then ' .sig file or folder
		      '
		      'else
		      'if vv<> nil then                   ' .sig file
		      'set behaviour
		      SigFileOpened=true
		      nhmmerSettingsWin.AddAnnotationCheckBox.value=true
		      nhmmerSettingsWin.AddAnnotationCheckBox.value=true
		      nhmmerSettingsWin.AddAnnotationCheckBox.enabled=true
		      nhmmerSettingsWin.AddAnnotationCheckBox.HelpTag="Annotation will be added with the HmmGen.py script"
		      nhmmerSettingsWin.MaskingBox.enabled=false
		      'nhmmerSettingsWin.CutoffBox.enabled=true
		      nhmmerSettingsWin.BitScoreField.enabled=true
		      nhmmerSettingsWin.BitScoreButton.enabled=false
		      nhmmerSettingsWin.EvalueButton.enabled=false
		      'nhmmerSettingsWin.CutOffBox.enabled=false
		      'nhmmerSettingsWin.ThresholdsBox.enabled=false
		      nhmmerSettingsWin.ThresholdsBox.enabled=true
		      
		      nhmmerSettingsWin.BitScoreField.text=""
		      nhmmerSettingsWin.EvalueField.Text=""
		      nhmmerSettingsWin.MaskingBox.HelpTag="Positions selected in the logo above will be masked according to the algorithm chosen." ' Disabled as the calibrated profile cannot be masked."
		      nhmmerSettingsWin.CutoffBox.HelpTag="Use score tresholds stored in the profile."
		      nhmmerSettingsWin.ThresholdsBox.HelpTag="Thresholds to use with uncalibrated profile. Disabled as the cutoffs from the opened calibrated profile will be used."
		      'Read data
		      dim basename as string=nthfield(tmpfile.DisplayName,".sig",1)
		      
		      if vv<>Nil then
		        LogoFile=vv.root.child(basename+".fasta")
		        HmmFile=vv.root.child(basename+".hmm")
		      else
		        LogoFile=tmpfile.child(basename+".fasta")
		        HmmFile=tmpfile.child(basename+".hmm")
		      end if
		      
		      'read the accessory files
		      Dim f As folderitem
		      dim inStream as TextInputStream
		      if vv<>Nil then
		        f=vv.root.child(basename+".info")     'Info
		      else
		        f=tmpfile.child(basename+".info")
		      end if
		      
		      if f.exists then
		        InStream = f.OpenAsTextFile
		        if InStream <>nil then
		          Info=inStream.ReadAll
		          ProfileWizardWin.InfoArea.Italic=false
		          ProfileWizardWin.InfoArea.TextColor=&c00000000 'black
		          ProfileWizardWin.InfoArea.Text=info
		          inStream.close
		        else
		          msgbox "Can't read alignment info"
		        End If
		      else
		        msgbox "No alignment info file ("+ f.Name+") located at "+f.ShellPath
		      end if
		      
		      If vv<>Nil Then
		        f=vv.root.child(basename+".options")  'Profile Settings
		      else
		        f=tmpfile.child(basename+".options")  
		      end if
		      
		      
		      InStream = f.OpenAsTextFile
		      if InStream <>nil then
		        ProfileSettings=inStream.ReadAll
		        
		        inStream.close
		        
		        'clean up existing values
		        ProfileWizardWin.CRtagSeqField.Text=""
		        ProfileWizardWin.CRtagField.Text=""
		        ProfileWizardWin.GatheringField.Text=""
		        ProfileWizardWin.NoiseField.Text=""
		        ProfileWizardWin.TrustedField.Text=""
		        ProfileWizardWin.SeedProteinArea.Text=""
		        
		        'read CRtag and profile calibration values
		        dim aline As string
		        
		        InStream = f.OpenAsTextFile
		        While Not InStream.EOF
		          aLine=InStream.readLine
		          dim score as string
		          if left(aLine,6)="TF_HMM" then
		            dim l As integer
		            dim ht as string
		            ht=trim(NthField(aline," ",2))
		            for l=0 to ProfileWizardWin.TFhmmPopup.ListCount-1
		              if ProfileWizardWin.TFhmmPopup.List(l)=ht then
		                TF_HMM=ht
		                ProfileWizardWin.TFhmmPopup.ListIndex=l
		                exit
		              end if
		            next
		            
		          elseif left(aLine,6)="CRtag " then 'space to distinguish from CRtagCoords
		            CRtag=Right(aline,Len(aline)-6)
		            ProfileWizardWin.CRtagSeqField.Text=CRtag
		          Elseif Left(aLine,11)="CRtagCoords" Then
		            CRtagCoords=Right(aline,Len(aline)-12)
		            ProfileWizardWin.CRtagField.Text=CRtagCoords
		          Elseif Left(aLine,8)="HMM_ACC " Then
		            HmmAccession=Trim(Right(aline,Len(aline)-8))
		          Elseif Left(aLine,10)="protein_id" Then
		            SeedProteinID=trim(NthField(aline,"protein_id",2))
		            ProfileWizardWin.SeedProteinArea.Text=">"+SeedProteinID+EndOfLine.Unix
		            ProfileWizardWin.SeedProteinArea.TextColor=&c00000000
		          elseif left(aLine,12)="seed_protein" then
		            SeedProteinSeq=Trim(NthField(aline," ",2))
		            ProfileWizardWin.SeedProteinArea.Text=ProfileWizardWin.SeedProteinArea.Text+SeedProteinSeq
		            ProfileWizardWin.SeedProteinArea.Italic=False
		          elseif left(aLine,7)="#=GF GA" then
		            score=trim(NthField(aline," ",3))
		            nhmmerSettingsWin.GAvalue.text="("+score+")"
		            ProfileWizardWin.GatheringField.text=score
		          elseif left(aLine,7)="#=GF NC" then
		            score=trim(NthField(aline," ",3))
		            nhmmerSettingsWin.NCvalue.text="("+score+")"
		            ProfileWizardWin.NoiseField.text=score
		          Elseif Left(aLine,7)="#=GF TC" Then
		            score=trim(NthField(aline," ",3))
		            nhmmerSettingsWin.TCvalue.text="("+score+")"
		            ProfileWizardWin.TrustedField.Text=score
		          end if
		        wend
		        inStream.close
		        
		        // Check if the family HMM within SigmoID matches the one in the profile
		        
		        '
		        
		        If TF_HMM<>"" Then
		          Dim ModelFile As folderitem 
		          ModelFile=Resources_f.child("TF_HMMs")
		          If ModelFile<>Nil Then ModelFile=ModelFile.child(TF_HMM)
		          If ModelFile<> Nil Then
		            If ModelFile.exists Then
		              InStream = ModelFile.OpenAsTextFile
		              While Not InStream.EOF
		                aLine=InStream.readLine
		                If Left(aLine,6)="ACC   " Then
		                  SigmoIDaccession=Trim(Right(aline,Len(aline)-6))
		                Elseif Left(aLine,6)="CRTAG "Then
		                  SigmoIDtag=Trim(Right(aline,Len(aline)-6))
		                End If
		              Wend
		              If SigmoIDaccession<>HMMaccession Then
		                MsgBox "TF family accession within SigmoID ("+SigmoIDaccession+") differs from the one used to create this profile ("+HMMaccession+"). The profile may perform suboptimally If the model has changed significantly."
		              End If
		              If SigmoIDtag<>CRtagCoords Then
		                MsgBox "TF family CR tag within SigmoID ("+SigmoIDtag+") differs from the one used to create this profile ("+CRtagCoords+"). The profile should be re-checked and probably re-constructed."
		              End If
		            Else
		              MsgBox "No matching TF family model present in SigmoID"
		            End If
		          Else
		            MsgBox "No matching TF family model present in SigmoID"
		          End If
		        End If
		        
		        
		      else
		        msgbox "Can't read SigmoID file options"
		      end if
		      'HmmGenSettingsWin.EvalueField.enabled=false
		      'HmmGenSettingsWin.EvalueButton.enabled=false
		      
		      If vv<>Nil Then
		        f=vv.root.child(basename+".refs")  'References with evidence codes
		      Else
		        f=tmpfile.child(basename+".refs")  
		      End If
		      
		      ProfileWizardWin.RefsList.RemoveAllRows
		      
		      Dim aLine As String
		      InStream = f.OpenAsTextFile
		      If InStream <>Nil Then
		        
		        While Not InStream.EOF
		          aLine=InStream.readLine
		          ProfileWizardWin.RefsList.AddRow(aLine.Split(Chr(9)))
		        Wend
		        inStream.close
		      Else
		        ProfileWizardWin.RefsList.AddRow
		      End If
		      
		      If vv<>Nil Then
		        f=vv.root.child(basename+".cur")  'Curator info
		      Else
		        f=tmpfile.child(basename+".cur")  
		      End If
		      
		      ProfileWizardWin.CuratorList.RemoveAllRows
		      
		      InStream = f.OpenAsTextFile
		      If InStream <>Nil Then
		        While Not InStream.EOF
		          aLine=InStream.readLine
		          ProfileWizardWin.CuratorList.AddRow(aLine.Split(Chr(9)))
		        Wend
		        inStream.close
		      Else
		        ProfileWizardWin.CuratorList.AddRow
		      End If
		      
		      
		      if vv<>Nil then
		        f=vv.root.child(basename+".hmm")  'Hmm profile
		      else
		        f=tmpfile.child(basename+".hmm")
		      end if      
		      
		      InStream = f.OpenAsTextFile
		      if InStream <>nil then
		        HmmProfile=inStream.ReadAll
		        inStream.close
		      else
		        msgbox "Can't read hmm profile"
		      end if
		      
		      if vv<>Nil then
		        f=vv.root.child("meme.txt")  'meme data
		      else
		        f=tmpfile.child("meme.txt")
		      end if
		      
		      
		      InStream = f.OpenAsTextFile
		      if InStream <>nil then
		        MEMEdata=inStream.ReadAll
		        inStream.close
		      else
		        'meme data is optional, so the warning goes to the log:
		        WriteToSTDOUT(LineEnd+"No MEME data is present in this .sig file")
		        MEMEdata=""
		      end if
		      
		      'Extract values from ProfileSettings
		      'and fill in the variables / configure settings windows accordingly:
		      dim OptionsNo,n as integer
		      dim theOption, switchName as string
		      
		      'nhmmer options
		      OptionsNo=countFields(ProfileSettings,"nhmmer.")
		      for n=1 to OptionsNo
		        theOption=NthField(ProfileSettings,"nhmmer.",n+1)
		        theOption=trim(NthField(TheOption,EndOfLine.Unix,1))
		        switchName=NthField(theOption," ",1)
		        select case switchName
		        case "--cut_ga"
		          nhmmerSettingsWin.gaButton.Value=true
		          HmmGenSettingsWin.BitScoreField.Text=mid(nhmmerSettingsWin.GAvalue.text,2,len(nhmmerSettingsWin.GAvalue.text)-2)
		          'nhmmerSettingsWin.BitScoreField.Text=mid(nhmmerSettingsWin.GAvalue.text,2,len(nhmmerSettingsWin.GAvalue.text)-2)
		        case "--cut_nc"
		          nhmmerSettingsWin.ncButton.Value=true
		          HmmGenSettingsWin.BitScoreField.Text=mid(nhmmerSettingsWin.NCvalue.text,2,len(nhmmerSettingsWin.NCvalue.text)-2)
		          'nhmmerSettingsWin.BitScoreField.Text=mid(nhmmerSettingsWin.NCvalue.text,2,len(nhmmerSettingsWin.GAvalue.text)-2)
		        case "--cut_tc"
		          nhmmerSettingsWin.tcButton.Value=true
		          HmmGenSettingsWin.BitScoreField.Text=mid(nhmmerSettingsWin.TCvalue.text,2,len(nhmmerSettingsWin.TCvalue.text)-2)
		          'nhmmerSettingsWin.BitScoreField.Text=mid(nhmmerSettingsWin.TCvalue.text,2,len(nhmmerSettingsWin.GAvalue.text)-2)
		        end select
		      next
		      'HmmGen and MastGen options
		      HmmGenSettingsWin.PalindromicBox.value=False
		      palindromic=false                           'enable the "Palindromise" function
		      ProfileWizardWin.PalindromicBox.value=false
		      HmmGenSettingsWin.IntergenicBox.value=false
		      ProfileWizardWin.WithinORFBox.value=False
		      HmmGenSettingsWin.AddQualifierBox.value=True
		      HmmGenSettingsWin.NextLocusBox.value=False
		      'ProfileWizardWin.NextLocusBox.value=False
		      OptionsNo=countFields(ProfileSettings,"HmmGen.")
		      for n=1 to OptionsNo
		        theOption=NthField(ProfileSettings,"HmmGen.",n+1)
		        theOption=trim(NthField(TheOption,EndOfLine.Unix,1))
		        switchName=NthField(theOption," ",1)
		        select case switchName
		        case "-L"
		          AlignmentLength=NthField(theOption," ",2)
		        case "-p"
		          HmmGenSettingsWin.PalindromicBox.value=true
		          palindromic=true
		          ProfileWizardWin.PalindromicBox.value=true
		        case "-i"
		          HmmGenSettingsWin.IntergenicBox.value=true
		          ProfileWizardWin.WithinORFBox.value=true
		          'case "-n"
		          'HmmGenSettingsWin.NextLocusBox.value=false
		          'ProfileWizardWin.NextLocusBox.value=false
		        case "-f"
		          HmmGenSettingsWin.FeatureCombo.Text=NthField(theOption," ",2)
		          ProfileWizardWin.FeatureCombo.Text=NthField(theOption," ",2)
		        case "-q"
		          HmmGenSettingsWin.AddQualifierBox.value=true
		          theOption=trim(right(theOption,len(theOption)-2))
		          HmmGenSettingsWin.KeyField.text=NthField(theOption,"#",1)
		          HmmGenSettingsWin.ValueField.text=NthField(theOption,"#",2)
		          ProfileWizardWin.KeyField.text=NthField(theOption,"#",1)
		          ProfileWizardWin.ValueField.text=NthField(theOption,"#",2)
		        end select
		      next
		      
		      MastGenSettingsWin.PalindromicBox.value=HmmGenSettingsWin.PalindromicBox.value
		      MastGenSettingsWin.IntergenicBox.value=HmmGenSettingsWin.IntergenicBox.value
		      MastGenSettingsWin.AddQualifierBox.value=HmmGenSettingsWin.AddQualifierBox.value
		      MastGenSettingsWin.NextLocusBox.value=HmmGenSettingsWin.NextLocusBox.value
		      'MastGenSettingsWin.lengthField.text=AlignmentLength
		      MastGenSettingsWin.FeatureCombo.Text=HmmGenSettingsWin.FeatureCombo.Text
		      MastGenSettingsWin.KeyField.text=HmmGenSettingsWin.KeyField.text
		      MastGenSettingsWin.ValueField.text=HmmGenSettingsWin.ValueField.text
		      
		      
		      'MASTgen p-value
		      if instr(ProfileSettings,"mastGen.-V")>0 then
		        theOption=NthField(ProfileSettings,"mastGen.-V",2)
		        theOption=NthField(trim(TheOption),EndOfLine.unix,1)
		        MastGenSettingsWin.PvalueField.text=theOption
		        MastSettingsWin.PvalueField.text=theOption
		        ProfileWizardWin.MASTField.text=theOption
		      else
		        MastGenSettingsWin.PvalueField.text=""
		        MastSettingsWin.PvalueField.text=""
		        ProfileWizardWin.MASTField.text=""
		      end if
		      ChangeView("Logo")
		      LogoTabs.value=0
		    else
		      SigFileOpened=false
		      MEMEdata=""
		      HmmProfile=""
		      ProfileSettings=""
		      Info=""
		      Informer.Text=""
		      nhmmerSettingsWin.AddAnnotationCheckBox.value=false
		      nhmmerSettingsWin.AddAnnotationCheckBox.enabled=false
		      nhmmerSettingsWin.AddAnnotationCheckBox.HelpTag="This option is enabled only for calibrated profiles"
		      'clear from restricted characters
		      
		      LogoFile=CleanedProfileCopy(tmpfile)
		      'LogoFile=tmpfile
		      HmmGenSettingsWin.PalindromicBox.value=False
		      HmmGenSettingsWin.IntergenicBox.value=True
		      HmmGenSettingsWin.AddQualifierBox.value=True
		      HmmGenSettingsWin.NextLocusBox.value=False
		      HmmGenSettingsWin.EvalueField.enabled=true
		      HmmGenSettingsWin.EvalueButton.enabled=true
		      nhmmerSettingsWin.MaskingBox.enabled=true
		      nhmmerSettingsWin.CutoffBox.enabled=false
		      nhmmerSettingsWin.TCvalue.text=""
		      nhmmerSettingsWin.GAvalue.text=""
		      nhmmerSettingsWin.NCvalue.text=""
		      nhmmerSettingsWin.ThresholdsBox.enabled=true
		      nhmmerSettingsWin.MaskingBox.HelpTag="Positions selected in the logo above will be masked according to the algorithm chosen."
		      nhmmerSettingsWin.CutoffBox.HelpTag="Use score tresholds stored in the profile. Disabled as you are not using calibrated profile."
		      nhmmerSettingsWin.ThresholdsBox.HelpTag="Thresholds to use with uncalibrated profile."
		      palindromic=false
		      
		      'ProfileWizardWin cleanup:
		      if Not ProfileWizardLocked then
		        ProfileWizardWin.InfoArea.text=""
		        ProfileWizardWin.InfoArea.Italic=false
		        ProfileWizardWin.InfoArea.TextColor=&c00000000 'black
		        ProfileWizardWin.GatheringField.text=""
		        ProfileWizardWin.NoiseField.text=""
		        ProfileWizardWin.TrustedField.text=""
		        ProfileWizardWin.PalindromicBox.value=false
		        ProfileWizardWin.WithinORFBox.value=True
		        'ProfileWizardWin.NextLocusBox.value=False
		        if Not SeqsChanged then 'otherwise editing the same profile twice leads to HmmGen.py error 
		          ProfileWizardWin.ValueField.text=""
		        end if
		        ProfileWizardWin.MASTField.text=""
		      End If
		      SeqsChanged=false
		      ChangeView("Logo")
		      LogoTabs.value=0
		    end if
		    
		    'removes line breaks and not allowed symbols, makes a copy in /tmp, then sets path to Logofile
		    'CleanedProfileCopy
		    
		    'store the seqs
		    dim tis as TextInputStream
		    tis=logofile.OpenAsTextFile
		    if tis<>nil then
		      sequences=tis.ReadAll
		      tis.Close
		      'RegPrecise data may contain gaps like this:
		      'TACAGAT-(17)-TTCAGAT-(13)-ATCTGTA-(23)-GTCTGTA
		      'filling the gaps with Ns:
		      if instr(sequences,"-(")>0 then
		        
		        sequences=FillGaps(sequences, false)
		        
		        
		        'write the seqs back to LogoFile:
		        dim tos as TextOutputStream
		        tos = TextOutputStream.Create(LogoFile)
		        tos.Write(Sequences)
		        tos.Close
		        
		      end if
		      
		      'determine the default length parameter
		      tis=logofile.OpenAsTextFile
		      dim minlength, maxlength, currentL, gapNo as integer
		      maxlength=0
		      if tis<>nil then
		        dim aline As string
		        while not tis.EOF
		          aLine=tis.readLine
		          if left(aLine,1)="A" OR left(aLine,1)="C" OR left(aLine,1)="G" OR left(aLine,1)="T"  then
		            if maxlength=0 then
		              maxlength=len(aline)
		              minlength=maxlength
		            end if
		            gapNo=CountFields(aline, "-")
		            if GapNo>1 then              'gapped alignment
		              currentL=maxlength-gapNo+1
		              if CurrentL<minlength then
		                minlength=CurrentL
		              end if
		            end if
		            'there may be gaps in some seqs. In this case nhmmer treats site length correctly, 
		            'while hmmgen expects fixed length and hence may set the site borders a bit off.
		            'in his case the logo may not be correct too!
		            
		            '(may also check for seq validity here)
		            exit
		          end if
		        wend
		        AlignmentLength=str(maxlength)
		        minAlignmentLength=str(minlength)
		        tis.Close
		        
		        ProfileWizardWin.FillDefaults(Sequences) ' hints with default cutoffs
		        
		      end
		      
		      
		      LogoWinToolbar.Item(1).Enabled=true
		      
		    else
		      'MsgBox "Can't open the alignment file"
		      WriteToSTDOUT(EndOfLine+"Can't read the binding site data!"+EndOfLine)
		      WriteToSTDOUT(EndOfLine+"(tried to read from "+logofile.ShellPath+")"+EndOfLine)
		      
		      LogoWinToolbar.Item(1).Enabled=false 'disable until alignment loaded
		      LogoWinToolbar.Item(4).Enabled=false
		      
		      Return
		    end if
		    'if WebLogoAvailable then
		    
		    DrawLogo
		    
		    'elseif SigFileOpened then
		    'use stored logodata within .sig file if available
		    'DrawLogo
		    'else
		    'ChangeView("Sequences")
		    'end if
		    
		    if GenomeFile<> Nil AND Logofile<>nil then
		      'LogoWinToolbar.Item(1).Enabled=true
		      LogoWinToolbar.Item(2).Enabled=false 'new alignment, no nhmmer output yet
		    end if
		    
		    if Palindromic then
		      LogoWinToolbar.Item(4).Enabled=false
		    else
		      LogoWinToolbar.Item(4).Enabled=true
		    End If
		    
		    
		  end if
		  'end if
		  
		  'HScrollBar.value=0
		  'LogoCanvas.left=0
		  
		  ControlAdjust 'adjust controls for new profile's logo
		  
		  if LengthsDiffer then
		    me.ChangeView("Sequences")
		    me.LogoTabs.value=1
		  else
		    me.ChangeView("Logo")
		    me.LogoTabs.value=0
		  end if
		  
		  RegulonID=0
		  RegulogID=0
		  
		  LastSearch=""
		  SeqsChanged=false
		  show
		  Exception err
		    ExceptionHandler(err,"LogoWin:LoadAlignment")
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub LoadRegpreciseData(ID as string, TFname as string, isRegulog As boolean)
		  'get the binding site sequences, store 'em in a temp file and open it
		  
		  'temporarily store the IDs as LoadAlignment() zeroes them
		  dim RgID,RnID as integer
		  RgID=RegulogID
		  RnID=RegulonID
		  
		  WriteToSTDOUT("Contacting RegPrecise... ")
		  
		  dim res as string
		  dim jsn as new JSONItem
		  dim hts as new HTTPSocket
		  hts.Yield=true
		  if isregulog then
		    res=hts.Get("https://regprecise.lbl.gov/Services/rest/sites?regulogId="+ID,0)
		    
		  else
		    res=hts.Get("https://regprecise.lbl.gov/Services/rest/sites?regulonId="+ID,0)
		  end if
		  if hts.HTTPStatusCode>=200 AND hts.HTTPStatusCode<300 then 'successful
		    if res<>"" then
		      JSN.load(res)
		      WriteToSTDOUT("got the data for "+TFname+".")
		      dim RegPreciseTemp as FolderItem
		      dim OutStream As TextOutputStream
		      
		      RegPreciseTemp=TemporaryFolder.child("RegPreciseTemp")
		      if RegPreciseTemp<>nil then
		        if RegPreciseTemp.Exists then
		          #if TargetLinux 
		            RegPreciseTemp.delete 'SpecialFolder.Trash returns NIL in Linux
		          #else 
		            RegPreciseTemp.MoveFileTo(SpecialFolder.Trash)
		          #endif
		          RegPreciseTemp=TemporaryFolder.child("RegPreciseTemp")
		        end if
		        dim fa as string
		        fa=JSON2Fasta(JSN)
		        if fa<>"" then
		          OutStream = TextOutputStream.Create(RegPreciseTemp)
		          outstream.Write(fa)
		          outstream.close
		          LoadAlignment(RegPreciseTemp)
		          logowin.ChangeView("Logo")
		          logowin.LogoTabs.value=0
		          me.title="SigmoID: "+TFname+" (RegPrecise)"
		          
		          'fill some hmmgen settings:
		          HmmGenSettingsWin.AddQualifierBox.Value=true
		          HmmGenSettingsWin.KeyField.text="bound_moiety"
		          HmmGenSettingsWin.ValueField.text=TFname
		          HmmGenSettingsWin.FeatureCombo.ListIndex=1 'protein_bind
		          HmmGenSettingsWin.IntergenicBox.Value=true
		          RegulogID=RgID
		          RegulonID=RnID
		        end if
		      end if
		    else
		      WriteToSTDOUT("no response in 15 sec.")
		    end if
		  else
		    
		    dim httpErr as String = HTTPerror(hts.HTTPStatusCode, true)
		    LogoWin.WriteToSTDOUT (httpErr)
		    
		    
		  end if
		  
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:LoadRegPreciseData")
		    
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Function LogoLength() As integer
		  dim instream as TextInputStream
		  dim aline As string
		  
		  InStream = LogoFile.OpenAsTextFile
		  while not InStream.EOF
		    aLine=InStream.readLine
		    if left(aLine,1)="A" OR left(aLine,1)="C" OR left(aLine,1)="G" OR left(aLine,1)="T"  then
		      return len(trim(aline))
		      exit
		    end if
		  wend
		  
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Function MASTGen() As boolean
		  'returns true if completed without errors
		  
		  'outfile must be set before calling this method
		  
		  'GenomeFile=GetOpenFolderItem("")
		  dim HitName as string
		  if GenomeFile<> nil then
		    dim cli as string
		    
		    
		    'The MastGen.py script is similar to the HmmGen.py,
		    'but -V is used instad of -E
		    
		    'usage:
		    'MastGen <report_file>  <input_file> <output_file> [options]
		    '
		    'This script allows to add features to a genbank file according to MAST
		    'results. Requires Biopython 1.64 (or newer)
		    '
		    'positional arguments:
		    'report_file           path to MAST report file produced with -tblout option.
		    'input_file            path to input Genbank file.
		    'output_file           path to output Genbank file.
		    '
		    'optional arguments:
		    '-h, --help            show this help message and exit
		    '-L <integer>, --length <integer>
		    'final feature's length in genbank file
		    '-q [<key#"value"> [<key#"value"> ...]], --qual [<key#"value"> [<key#"value"> ...]]
		    'add this qualifier to each annotated feature.
		    '-p, --palindromic     filter palindromic sites.
		    '-n, --name            don't pick 'locus_tag' and 'gene' qualifiers from the
		    'next CDS feature.
		    '-V <float or integer>, --pval <float or integer>
		    'threshold E-Value.
		    '-S <float or integer>, --score <float or integer>
		    'threshold Bit Score.
		    '-i, --insert          don't add features inside CDS
		    '-d, --duplicate       no duplicate features with the same location and the
		    'same protein_bind qualifier value
		    '-v, --version         show program's version number and exit
		    '-f <"feature key">, --feature <"feature key">
		    'feature key to add (promoter, protein_bind etc.)
		    
		    
		    
		    
		    if outfile<>nil and MASTResultFile<> NIL then
		      WriteToSTDOUT (EndofLine+EndofLine+"Running the MastGen script..."+EndofLine)
		      FixPath4Windows(outfile)
		      dim genomefilepath as string
		      #if TargetWindows
		        'GenomeFilePath=GetShortPathName(GenomeFile.shellpath)
		        GenomeFilePath=chr(34)+GenomeFile.shellpath+chr(34)
		      #else
		        GenomeFilePath=GenomeFile.shellpath
		      #endif
		      
		      cli=pythonPath+PlaceQuotesToPath(MastGenPath)+" "+PlaceQuotesToPath(MASTResultFile.ShellPath)+" "+PlaceQuotesToPath(GenomeFilePath)+" "+PlaceQuotesToPath(outFile.ShellPath)+" "+HmmGenOptions
		      
		      userShell(cli)
		      If shError=0 Then
		        'store hit number for genome scan:
		        dim LastHitStr as string
		        LastHitStr=NthField(shResult,"Features added:",3)
		        LastHitStr=NthField(LastHitStr,"CPU time:",1)
		        LastHitNo=Val(LastHitStr)
		        
		        WriteToSTDOUT (EndofLine+shResult)
		        
		        
		        'display the hits in the browser:
		        if MastGenSettingsWin.GenomeBrowserCheckBox.value then
		          'MastSettingsWin.AddAnnotationCheckBox.value
		          
		          redim GenomeWin.HmmHits(0)
		          redim GenomeWin.HmmHitDescriptions(0)
		          redim genomeWin.HmmHitNames(0)
		          
		          dim m,n,o,colonPos as integer
		          dim currentHit,HitInfo, hits2sort(0),hitloc as string
		          
		          'sort the hits according to genome position:
		          m=CountFields(shResult,"location: [")
		          for n=2 to m
		            currentHit=nthfield(shResult,"location: [",n)
		            colonPos=instrb(currenthit,":")
		            hitloc=nthfield(currentHit,":",1)
		            if lenb(hitLoc)<8 then 'assuming genome length is less than 100Mb
		              for o=0 to 8-lenb(hitLoc)
		                hitloc="0"+hitloc
		              next
		            end if
		            hitloc=hitloc+midb(currenthit,colonpos,lenb(currentHit)-colonpos)
		            hits2sort.append hitloc'+midb(currenthit,colonpos,lenb(currentHit)-colonpos)
		            'nthfield(sh.result,"location: [",n)
		          next
		          hits2sort.Sort
		          m=ubound(hits2sort)
		          for n=1 to m
		            while left(hits2sort(n),1)="0"
		              hits2sort(n)=right(hits2sort(n),lenb(hits2sort(n))-1)
		            wend
		          next
		          
		          'add sorted hits and their info into genome browser arrays:
		          'hmmgen result:
		          '2233715:2233745](-)
		          'qualifiers:
		          'Key: bound_moiety, Value: ['HrpL alternative sigma factor']
		          'Key: gene, Value: ['hrpJ']
		          'Key: inference, Value: ['profile:nhmmer:3.1b1']
		          'Key: locus_tag, Value: ['OA04_20620']
		          'Key: note, Value: nhmmer score 12.8 E-value 1.2
		          'Key: regulatory_class, Value: ['promoter']
		          'type: regulatory
		          
		          for n=1 to ubound(hits2sort)
		            currentHit=hits2sort(n)
		            GenomeWin.HmmHits.append(val(nthfield(currentHit,":",1)))
		            HitInfo=nthfield(currentHit,"]",1)+" ("+right(nthfield(currentHit,")",1),1)+") "
		            HitInfo=HitInfo+nthfield(nthfield(currentHit,"bound_moiety, Value: ['",2),"']",1)
		            HitInfo=HitInfo+" "+NthField(nthfield(currentHit,"MAST ",2),Endofline,1)
		            HitName=""
		            if instr(currenthit,"Key: gene")>0 then
		              'extract gene name
		              Hitname=nthfield(currentHit,"Key: gene, Value: ['",2)
		              Hitname=nthfield(HitName,"']",1)+" "
		            end if
		            'add locus_tag
		            Hitname=Hitname+nthfield(nthfield(currentHit,"Key: locus_tag, Value: ['",2),"']",1)+" "
		            
		            genomeWin.HmmHitDescriptions.append HitInfo
		            genomeWin.HmmHitNames.append HitName
		            
		          next
		          
		          'initialise array to select/deselect hits:
		          redim genomeWin.HmmHitChecked(ubound(hits2sort))
		          for n=1 to ubound(hits2sort)
		            genomeWin.HmmHitChecked(n)=true
		          next
		          genomeWin.AnyHitDeselected=false
		        end if
		        
		        
		        
		        if Ubound(genomeWin.HmmHits)>0 then
		          if NOT ScanningGenome then
		            WriteToSTDOUT (EndofLine.unix+"Genbank file with added features written to "+outFile.ShellPath+EndofLine)
		          end if
		          
		          WriteToSTDOUT (EndofLine.unix+"Loading the GenBank file...")
		          
		          'Set the genome map scrollbar:
		          Genomewin.SetScrollbar
		          
		          'Display the hit:
		          genomeWin.CurrentHit=1
		          Dim s0 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 0 )
		          s0.Enabled=false 'first hit: there's no previous one
		          Dim s1 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 1 )
		          s1.Title="1/"+str(UBound(genomeWin.HmmHits))
		          Dim s2 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 2 )
		          s2.enabled=true
		          
		          
		        end if
		        return true
		      else
		        WriteToSTDOUT (EndofLine+"MASTGen error code: "+Str(shError)+EndofLine)
		        WriteToSTDOUT (EndofLine+shResult)
		        WriteToSTDOUT (EndofLine+"MASTGen command line was: "+cli+EndofLine)
		        
		        return false
		      end if
		    else
		      return false
		    end if
		    
		  end if
		  
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:MastGen")
		    
		End Function
	#tag EndMethod

	#tag Method, Flags = &h1
		Protected Sub MASTsearch()
		  WriteToSTDOUT (EndofLine+"Running MAST...")
		  
		  dim cli as string
		  
		  
		  'Convert genome file to fasta format:
		  dim FastaFile as FolderItem
		  dim outfile As folderitem
		  dim tis as TextInputStream
		  dim seqin as string
		  tis=genomefile.OpenAsTextFile
		  seqin=tis.ReadAll
		  tis.Close
		  
		  outfile=TemporaryFolder.child("FastaFile")
		  if outfile<>nil then
		    Dim s as TextOutputStream=TextOutputStream.Create(outfile)
		    if s<> NIL then
		      s.Writeline ">"+GenomeFile.Name
		      s.write CleanUp(rightb(seqin,len(seqin)-instrb(seqin,"ORIGIN")-7))
		      s.close
		    end if
		    
		    
		  end if
		  
		  
		  
		  
		  cli=MASTpath+" "+ PlaceQuotesToPath(MakeWSLPath(memetmp.shellpath))+" "+PlaceQuotesToPath(MakeWSLPath(outfile.shellpath)) +nhmmerOptions+" -hit_list"
		  #If TargetWindows
		    ExecuteWSL(cli)
		  #Else
		    UserShell(cli)
		  #endif
		  If shError=0 Then
		    WriteToSTDOUT (EndofLine+shResult)
		    'write results to a temporary file for MastGen.py:
		    MASTResultFile=TemporaryFolder.child("mast.table")
		    
		    if MASTResultFile<>nil then
		      Dim tos as TextOutputStream
		      tos=TextOutputStream.Create(MASTResultFile)
		      tos.Write trim(shResult)
		      tos.close
		      LastSearch="MAST"
		      
		    else
		      msgbox "Can't create a file to store MAST results!"
		      return
		    End If
		  else
		    LogoWin.WriteToSTDOUT (EndOfLine + "MAST error code: "+Str(shError)+EndOfLine)
		    WriteToSTDOUT (EndofLine+shResult)
		    
		  End If
		  
		  
		  if MASTSettingsWin.ShowHitsCheckBox.value AND MASTSettingsWin.AddAnnotationCheckBox.value=false then
		    
		    
		    'display the hits in the browser:
		    'MAST output format:
		    '# All non-overlapping hits in all sequences from "/Users/Home/3-2rez9/Pca32_10182014.fsa".
		    '# sequence_name motif hit_start hit_end score hit_p-value
		    'gnl|BSU|OA04_contig1 +1 151274 151294  2344.29 2.61e-09
		    'gnl|BSU|OA04_contig1 +1 2506223 2506243  2388.66 1.62e-09
		    '# mast meme.txt FastaFile -hit_list  -mt 0.0000001
		    
		    
		    redim GenomeWin.HmmHits(0)
		    redim GenomeWin.HmmHitDescriptions(0)
		    redim genomeWin.HmmHitNames(0)
		    
		    dim m,n,o,colonPos as integer
		    dim HitList,currentHit,HitInfo, hits2sort(0),hitloc as string
		    
		    HitList=replaceall(NthField(shResult,"hit_p-value",2),"  "," ") 'remove double spaces in front of score
		    HitList=replaceall(HitList,"  "," ") 'remove double spaces in front of score
		    HitList=replaceall(HitList,"  "," ") 'remove double spaces in front of score
		    
		    HitList=trim(NthField(HitList,"# mast",1))
		    
		    'sort the hits according to genome position:
		    m=CountFields(HitList,EndOfLine.unix)
		    for n=1 to m
		      currentHit=nthfield(HitList,EndOfLine.unix,n)
		      'colonPos=instrb(currenthit,":")
		      hitloc=nthfield(currentHit," ",3)
		      if lenb(hitLoc)<8 then 'assuming genome length is less than 100Mb
		        for o=0 to 8-lenb(hitLoc)
		          hitloc="0"+hitloc
		        next
		      end if
		      hitloc=hitloc+":"+nthfield(currentHit," ",4)+"("+replace(nthfield(currentHit," ",2),"1","")+") score "+nthfield(currentHit," ",5)+" p-value "+nthfield(currentHit," ",6)
		      hits2sort.append hitloc
		      
		    next
		    hits2sort.Sort
		    
		    m=ubound(hits2sort)
		    for n=1 to m
		      while left(hits2sort(n),1)="0"
		        hits2sort(n)=right(hits2sort(n),lenb(hits2sort(n))-1)
		      wend
		    next
		    
		    'add sorted hits and their info into genome browser arrays:
		    'hmmgen result:
		    '2233715:2233745](-)
		    'qualifiers:
		    'Key: bound_moiety, Value: ['HrpL alternative sigma factor']
		    'Key: gene, Value: ['hrpJ']
		    'Key: inference, Value: ['profile:nhmmer:3.1b1']
		    'Key: locus_tag, Value: ['OA04_20620']
		    'Key: note, Value: nhmmer score 12.8 E-value 1.2
		    'Key: regulatory_class, Value: ['promoter']
		    'type: regulatory
		    
		    for n=1 to ubound(hits2sort)
		      currentHit=hits2sort(n)
		      GenomeWin.HmmHits.append(val(nthfield(currentHit,":",1)))
		      HitInfo=currentHit
		      'HitName="Unknown_name"
		      'if instr(currenthit,"Key: gene")>0 then
		      ''extract gene name
		      'Hitname=nthfield(currentHit,"Key: gene, Value: ['",2)
		      'Hitname=nthfield(HitName,"']",1)+" "
		      'end if
		      ''add locus_tag
		      'Hitname=Hitname+nthfield(nthfield(currentHit,"Key: locus_tag, Value: ['",2),"']",1)+" "
		      
		      genomeWin.HmmHitDescriptions.append HitInfo
		      genomeWin.HmmHitNames.append "Unknown_name" 'HitName
		      
		    next
		    
		    'initialise array to select/deselect hits:
		    redim genomeWin.HmmHitChecked(ubound(hits2sort))
		    for n=1 to ubound(hits2sort)
		      genomeWin.HmmHitChecked(n)=true
		    next
		    genomeWin.AnyHitDeselected=false
		    
		    
		  end if
		  
		  
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Function MatchingTFpresent() As boolean
		  ' searches the genome with hmmsearch,
		  ' returns true if there's a hit with the specified CRtag
		  
		  'hmmSearchSettingsWin.ShowModalWithin(self)
		  'if hmmSearchSettings="" then
		  'return false
		  '
		  'end if
		  '
		  'logowin.show
		  dim cli as string
		  
		  dim instream as TextInputStream
		  
		  
		  if GenomeFile=Nil then
		    logoWin.WriteToSTDOUT("Please select a file to search first.")
		    return false
		  else
		    logoWin.WriteToSTDOUT(EndOfLine.UNIX+"Exporting protein seqs... ")
		    
		  end if
		  
		  'export protein fastas:
		  dim CDSfasta as folderitem
		  CDSfasta=TemporaryFolder.child("CDS.fasta")
		  
		  'instream=CDSfasta.OpenAsTextFile
		  '
		  'if instream<>nil then
		  'CDSseqs=replaceall(trim(instream.ReadAll),EndOfLine.unix,"")
		  'instream.close
		  'end if
		  
		  
		  if CDSfasta<>nil then
		    if CDSfasta.exists then
		      'LogoWin.WriteToSTDOUT (EndofLine.unix+EndofLine.unix+"An existing CDS sequences file was found at "+CDSfasta.shellpath+" and will be reused.")
		      CDSfasta.Delete
		    end if
		    'LogoWin.WriteToSTDOUT (EndofLine.unix+EndofLine.unix+"Exporting CDS sequences...")
		    GenomeWin.ExportProteins(CDSfasta)
		    LogoWin.WriteToSTDOUT (" OK"+EndOfLine.UNIX)
		    
		    
		    instream=CDSfasta.OpenAsTextFile
		    
		    if instream<>nil then
		      CDSseqs=replaceall(trim(instream.ReadAll),EndOfLine.unix,"")
		    end if
		    instream.close
		    
		    cli=""
		    
		    
		    FixPath4Windows(CDSfasta)
		    
		    dim genomefilepath as string
		    #if TargetWindows
		      'GenomeFilePath=GetShortPathName(GenomeFile.shellpath)
		      GenomeFilePath=chr(34)+GenomeFile.shellpath+chr(34)
		    #else
		      GenomeFilePath=GenomeFile.shellpath
		    #endif
		    
		    dim modelFile as string
		    modelFile=Resources_f.Child("TF_HMMs").Child(TF_HMM).ShellPath
		    dim HmmSearchPath as string = replace(nhmmerPath,"nhmmer","hmmsearch")
		    
		    'some settings are required here, at least to set threshold
		    
		    cli=HmmSearchPath    '+" "+hmmSearchSettings
		    
		    
		    'if hmmSearchSettingsWin.AddAnnotationCheckBox.Value then
		    'hmmsearchResultFile=TemporaryFolder.child("hmmsearch.result")
		    '
		    'if hmmsearchResultFile<>nil then
		    'cli=cli +" -o "+hmmsearchResultFile.shellpath
		    'else
		    'return false
		    'end if
		    ''end if
		    'cli=cli+" "+modelFile+" "+CDSfasta.ShellPath
		    
		    dim alignmentsFile as folderitem = TemporaryFolder.Child("alignments.table")
		    if alignmentsFile<>nil then
		      if alignmentsFile.exists then
		        alignmentsFile.Delete
		      end if
		      LogoWin.WriteToSTDOUT (EndofLine.unix+"Running hmmsearch...")
		      HmmSearchPath = replace(nhmmerPath,"nhmmer","hmmsearch")
		      
		      cli=HmmSearchPath+" --cut_ga --notextw -A "+PlaceQuotesToPath(MakeWSLPath(alignmentsFile.ShellPath))+" "+modelFile+" "+PlaceQuotesToPath(MakeWSLPath(CDSfasta.ShellPath))
		      
		      
		      #If TargetWindows
		        ExecuteWSL(cli)
		      #Else
		        UserShell(cli)
		      #EndIf
		      
		      If shError=0 Then
		        'LogoWinToolbar.Item(2).Enabled=true
		        'logoWin.LastSearch="hmmsearch" 'not used
		        
		        // check for correct CRtag here!!!
		        LogoWin.WriteToSTDOUT (" OK"+EndofLine.unix)
		        
		        instream = alignmentsFile.OpenAsTextFile
		        
		        if instream<>nil then         'save hmmsearch results
		          Dim table As String=Trim(instream.ReadAll)
		          instream.close
		          Dim hmmSearchRes As String = GetCRtags(shResult,Table,CRtagCoords)
		          logoWin.WriteToSTDOUT (EndOfLine+hmmSearchRes)
		          
		          If InStr(hmmSearchRes,">"+CRtag+">")>0 Then
		            return true
		          else
		            return false
		          end if
		        else
		          return false
		        end if
		      else
		        logoWin.WriteToSTDOUT (EndofLine+shResult)
		        MsgBox "hmmsearch error code: "+Str(shError)
		        logoWin.WriteToSTDOUT (EndofLine+"hmmsearch command line was: "+cli+EndofLine)
		        'LogoWinToolbar.Item(2).Enabled=false
		        return false
		      end if
		    end if
		  end if
		  
		  
		  
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:MatchingTFpresent")
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Function nhmmer() As boolean
		  'returns true if completed without errors
		  
		  'nhmmeroptions parameter isn't used
		  '(nhmmerSettingsWin.OptionsField.text used instead)
		  
		  dim cli as string
		  
		  
		  
		  if GenomeFile=Nil then
		    WriteToSTDOUT("Please select a file to search first.")
		    return false
		  end if
		  'get the temp file to save nhmmer result table
		  nhmmerResultFile=TemporaryFolder.child("nhmmer.table")
		  
		  if nhmmerResultFile<>nil then
		    cli=""
		    dim hmmeroptions as string = nhmmerSettingsWin.OptionsField.text
		    
		    'USE nhmmeroptions VARIABLE!!!
		    
		    FixPath4Windows(nhmmerResultFile)
		    
		    dim genomefilepath as string
		    GenomeFilePath=GenomeFile.shellpath
		    
		    if SigFileOpened then
		      HmmFile.CopyFileTo(TemporaryFolder)
		      dim HmmFileTmp as folderitem = TemporaryFolder.child(HmmFile.DisplayName)
		      cli=nhmmerpath+" --dna "+nhmmeroptions+" --tblout "+PlaceQuotesToPath(MakeWSLPath(nhmmerResultFile.shellpath))+" "+PlaceQuotesToPath(MakeWSLPath(HmmFileTmp.ShellPath))+" "+PlaceQuotesToPath(MakeWSLPath(GenomeFilePath))
		    else
		      if masked then
		        alimask LogoFile
		        WriteToSTDOUT (EndofLine+EndofLine+"Alignment masked.")
		        '/usr/local/bin/nhmmer
		        cli=nhmmerpath+" --dna "+nhmmeroptions+" --tblout "+PlaceQuotesToPath(MakeWSLPath(nhmmerResultFile.shellpath))+" "+PlaceQuotesToPath(MakeWSLPath(alimasktmp.ShellPath))+" "+PlaceQuotesToPath(MakeWSLPath(GenomeFilePath))
		      else
		        cli=nhmmerpath+" --dna "+nhmmeroptions+" --tblout "+PlaceQuotesToPath(MakeWSLPath(nhmmerResultFile.shellpath))+" "+PlaceQuotesToPath(MakeWSLPath(Logofile.ShellPath))+" "+PlaceQuotesToPath(MakeWSLPath(GenomeFilePath))
		      end if
		    end if
		    
		    if instr(cli,"-E")>0 AND instr(cli,"--cut_")>0 then
		      msgbox "Incompatible nhmmer options -E and --cut_"
		    end if
		    
		    WriteToSTDOUT (EndOfLine+EndOfLine+"Running nhmmer...")
		    #If targetWindows
		      ExecuteWSL(cli)
		    #Else
		      userShell(cli)
		    #EndIf
		    
		    If shError=0 Then
		      WriteToSTDOUT (EndOfLine+shResult)
		      LogoWinToolbar.Item(2).Enabled=true
		      LastSearch="nhmmer"
		      
		      //save number of hits for genome scans
		      Dim cnt As String = NthField(shResult, "Total number of hits:",2)
		      HitsNo=Val(cnt)
		      
		      return true
		    else
		      WriteToSTDOUT (EndofLine+shResult)
		      MsgBox "nhmmer error code: "+Str(shError)
		      WriteToSTDOUT (EndofLine+"nhmmer command line was: "+cli+EndofLine)
		      LogoWinToolbar.Item(2).Enabled=false
		      return false
		    end if
		  end if
		  
		  
		  
		  '# nhmmer :: search a DNA model or alignment against a DNA database
		  '# HMMER 3.1b1 (May 2013); http://hmmer.org/
		  '# Copyright (C) 2013 Howard Hughes Medical Institute.
		  '# Freely distributed under the GNU General Public License (GPLv3).
		  '# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
		  'Usage: nhmmer [options] <query hmmfile|alignfile> <target seqfile>
		  '
		  'Basic options:
		  '-h : show brief help on version and usage
		  '
		  'Options directing output:
		  '-o <f>             : direct output to file <f>, not stdout
		  '-A <f>             : save multiple alignment of all hits to file <s>
		  '--tblout <f>       : save parseable table of hits to file <s>
		  '--dfamtblout <f>   : save table of hits to file, in Dfam format <s>
		  '--aliscoresout <f> : save scores for each position in each alignment to <s>
		  '--hmmout <f>       : if input is alignment(s), write produced hmms to file <s>
		  '--acc              : prefer accessions over names in output
		  '--noali            : don't output alignments, so output is smaller
		  '--notextw          : unlimit ASCII text output line width
		  '--textw <n>        : set max width of ASCII text output lines  [120]  (n>=120)
		  '
		  'Options controlling scoring system:
		  '--singlemx    : use substitution score matrix w/ single-sequence MSA-format inputs
		  '--popen <x>   : gap open probability  [0.03125]  (0<=x<0.5)
		  '--pextend <x> : gap extend probability  [0.75]  (0<=x<1)
		  '--mx <s>      : substitution score matrix choice (of some built-in matrices)  [DNA1]
		  '--mxfile <f>  : read substitution score matrix from file <f>
		  '
		  'Options controlling reporting thresholds:
		  '-E <x> : report sequences <= this E-value threshold in output  [10.0]  (x>0)
		  '-T <x> : report sequences >= this score threshold in output
		  '
		  'Options controlling inclusion (significance) thresholds:
		  '--incE <x> : consider sequences <= this E-value threshold as significant  [0.01]  (x>0)
		  '--incT <x> : consider sequences >= this score threshold as significant
		  '
		  'Options controlling model-specific thresholding:
		  '--cut_ga : use profile's GA gathering cutoffs to set all thresholding
		  '--cut_nc : use profile's NC noise cutoffs to set all thresholding
		  '--cut_tc : use profile's TC trusted cutoffs to set all thresholding
		  '
		  'Options controlling acceleration heuristics:
		  '--max    : Turn all heuristic filters off (less speed, more power)
		  '--F1 <x> : Stage 1 (SSV) threshold: promote hits w/ P <= F1  [0.02]
		  '--F2 <x> : Stage 2 (Vit) threshold: promote hits w/ P <= F2  [3e-3]
		  '--F3 <x> : Stage 3 (Fwd) threshold: promote hits w/ P <= F3  [3e-5]
		  '--nobias : turn off composition bias filter
		  '
		  'Options for selecting query alphabet rather than guessing it:
		  '--dna : input alignment is DNA sequence data
		  '--rna : input alignment is RNA sequence data
		  '
		  'Other expert options:
		  '--tformat <s>      : assert target <seqdb> is in format <s>
		  '--qformat <s>      : assert query <seqfile> is in format <s>
		  '--nonull2          : turn off biased composition score corrections
		  '-Z <x>             : set database size (Megabases) to <x> for E-value calculations  (x>0)
		  '--seed <n>         : set RNG seed to <n> (if 0: one-time arbitrary seed)  [42]  (n>=0)
		  '--w_beta <x>       : tail mass at which window length is determined
		  '--w_length <n>     : window length - essentially max expected hit length
		  '--block_length <n> : length of blocks read from target database (threaded)   (n>=50000)
		  '--toponly          : only search the top strand
		  '--bottomonly       : only search the bottom strand
		  '--cpu <n>          : number of parallel CPU workers to use for multithreads  (n>=0)
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:nhmmer")
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub nhmmerSearch()
		  if NOT SigFileOpened then
		    if masked then
		      nhmmerSettingsWin.MaskingBox.Enabled=true
		      nhmmerSettingsWin.MaskingBox.HelpTag="Masking options for alimask. HMMer default is Henikoff position-based"
		    else
		      nhmmerSettingsWin.MaskingBox.Enabled=False
		      nhmmerSettingsWin.MaskingBox.HelpTag="Masking options for alimask. To enable, drag/shift-drag over undesired positions in the logo"
		      'show cutoff values:
		    end if
		  end if
		  if GenomeFile<>Nil then
		    nhmmerSettingsWin.GenomeField.text=GenomeFile.ShellPath
		    
		    nhmmerSettingsWin.RunButton.Enabled=true
		  else
		    '#if Debugbuild
		    'GenomeFile=GetFolderItem(nhmmerSettingsWin.GenomeField.text,FolderItem.PathTypeShell)
		    '#else
		    nhmmerSettingsWin.RunButton.Enabled=false
		    '#endif
		  end if
		  nhmmerSettingsWin.EnableRun
		  nhmmerSettingsWin.ShowModalWithin(self)
		  'Genomefile=GetFolderItem(trim(nhmmerSettingsWin.GenomeField.text), FolderItem.PathTypeShell)
		  
		  'need a pref checkbox to enable CRtag-filtered search
		  
		  if nhmmerOptions <> "" then
		    
		    'check if the orthologous TF with matching CRtag is present in the genome
		    
		    if CRtag="" then
		      me.WriteToSTDOUT "No CRtag data in this profile. Please make sure that the TF able to recognise these sites is actually encoded in the genome."+EndOfLine.unix
		      if nhmmer then
		        if nhmmerSettingsWin.AddAnnotationCheckBox.value then
		          
		          Dim dlg as New SaveAsDialog
		          dlg.InitialDirectory=genomefile.Parent
		          dlg.promptText="Select where to save the modified genome file"
		          dlg.SuggestedFileName=nthfield(GenomeFile.Name,".",1)+"_"+nthfield(Logofile.Name,".",1)+".gb"
		          dlg.Title="Save genome file"
		          dlg.Filter=FileTypes.genbank
		          dlg.CancelButtonCaption=kCancel
		          dlg.ActionButtonCaption=kSave
		          outfile=dlg.ShowModal()
		          if outfile<>nil then
		            HmmGenSettingsWin.ReadOptions
		            if HmmGen then
		              if HmmGenSettingsWin.GenomeBrowserCheckBox.Value then 'Load the Seq into browser
		                if ubound(GenomeWin.HmmHitDescriptions)>0 then
		                  GenomeWin.opengenbankfile(outFile)
		                  genomeWin.ShowHit
		                  WriteToSTDOUT (" done."+EndofLine)
		                end if
		              end if
		            end if
		          end if
		        end if
		      end if
		    else
		      If MatchingTFpresent Then
		        
		        
		        
		        
		        if nhmmer then
		          if nhmmerSettingsWin.AddAnnotationCheckBox.value then
		            
		            Dim dlg as New SaveAsDialog
		            dlg.InitialDirectory=genomefile.Parent
		            dlg.promptText="Select where to save the modified genome file"
		            dlg.SuggestedFileName=nthfield(GenomeFile.Name,".",1)+"_"+nthfield(Logofile.Name,".",1)+".gb"
		            dlg.Title="Save genome file"
		            dlg.Filter=FileTypes.genbank
		            dlg.CancelButtonCaption=kCancel
		            dlg.ActionButtonCaption=kSave
		            outfile=dlg.ShowModal()
		            if outfile<>nil then
		              HmmGenSettingsWin.ReadOptions
		              if HmmGen then
		                if HmmGenSettingsWin.GenomeBrowserCheckBox.Value then 'Load the Seq into browser
		                  if ubound(GenomeWin.HmmHitDescriptions)>0 then
		                    GenomeWin.opengenbankfile(outFile)
		                    genomeWin.ShowHit
		                    WriteToSTDOUT (" done."+EndofLine)
		                  end if
		                end if
		              end if
		            end if
		          end if
		        end if
		        
		      else
		        Me.WriteToSTDOUT "No TF with matching CRtag could be found."+EndOfLine.unix
		        
		      end if
		    end if
		    
		    
		  end if
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h1
		Protected Sub Palindromise()
		  PalindromeLogoFile=TemporaryFolder.child("LogoPalindrome")
		  
		  'since we change data, that's not the .sig any more!
		  SigFileOpened=false
		  
		  If PalindromeLogoFile <> Nil then
		    RevCompAlignment(logofile, palindromeLogofile,true)
		    logofile=PalindromeLogoFile
		    
		    'replace contents of the Sequence variable (for viewing)
		    dim instream as TextInputStream = PalindromeLogoFile.OpenAsTextFile
		    Sequences=Instream.ReadAll
		    instream.Close
		    DrawLogo
		    palindromic=true
		    LogoWinToolbar.Item(4).Enabled=false
		    HmmGenSettingsWin.PalindromicBox.value=true
		  End If
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:Palindromise")
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h1
		Protected Sub ReadLogoData()
		  'currently unused
		  
		  
		  dim n, FeatureCount as integer
		  dim CurrentLine As String
		  
		  redim LogoData(0)
		  //Check that infile paths are valid
		  'LogoFile=GetFolderItem(InFilePathField.text, FolderItem.PathTypeShell)
		  if SigFileOpened then
		    'weblogo_out already read from the .sig file
		  else
		    If LogoFile.Exists Then
		      weblogo_out=weblogo(LogoFile)
		    End If
		  end if
		  
		  if weblogo_out<>"" then
		    for n=1 to countfields(weblogo_out,EndOfLine.Unix)
		      
		      CurrentLine=NthField(weblogo_out,EndOfLine.Unix,n)
		      
		      if instr("0123456789",left(CurrentLine,1))>0 then
		        LogoData.Append(CurrentLine)
		      end if
		      
		    next
		    
		    LogoLength=ubound(Logodata)
		    
		  end if
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:ReadLogoData")
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Function RepeatGen() As boolean
		  'This function is virtually identical to the HmmGen function (only the script name is changed)
		  
		  dim HitName as string
		  if GenomeFile<> nil then
		    dim cli as string
		    
		    
		    'usage:
		    'HmmGen <report_file>  <input_file> <output_file> [options]
		    '
		    'This script allows to add features to a genbank file according to nhmmer
		    'results. Requires Biopython 1.64 (or newer)
		    '
		    'positional arguments:
		    'report_file           path to nhmmer report file produced with -tblout
		    'option.
		    'input_file            path to input Genbank file.
		    'output_file           path to output Genbank file.
		    '
		    'optional arguments:
		    '-h, --help            show this help message and exit
		    '-L <integer> or <integer>:<integer>, --length <integer> or <integer>:<integer>
		    'maximal and minimal allowed length of profile to
		    'genome alignment.
		    '-q [<key#"value"> [<key#"value"> ...]], --qual [<key#"value"> [<key#"value"> ...]]
		    'add this qualifier to each annotated feature.
		    '-p, --palindromic     filter palindromic sites.
		    '-n, --name            don't pick 'locus_tag' and 'gene' qualifiers from the
		    'next CDS feature.
		    '-E <float or integer>, --eval <float or integer>
		    'threshold E-Value.
		    '-i, --insert          don't add features inside CDS
		    '-b <integer>, --boundary <integer>
		    'set allowed length boundary for hits being within
		    'features
		    '-d, --duplicate       no duplicate features with the same location and the
		    'same protein_bind qualifier value
		    '-v, --version         show program's version number and exit
		    '-f <"feature key">, --feature <"feature key">
		    'feature key to add (promoter, protein_bind etc.)
		    
		    
		    
		    if outfile<>nil then
		      WriteToSTDOUT (EndofLine+EndofLine+"Running the HmmGen script..."+EndofLine)
		      dim GenomeFilePath,outFilePath as string
		      #if TargetWindows
		        'GenomeFilePath=GetShortPathName(GenomeFile.shellpath)
		        FixPath4Windows(outfile)
		        GenomeFilePath=chr(34)+GenomeFile.shellpath+chr(34)
		        outFilePath=chr(34)+outFile.ShellPath+chr(34)
		      #else
		        GenomeFilePath=GenomeFile.shellpath
		        outFilePath=outFile.ShellPath
		      #endif
		      
		      cli=pythonPath+PlaceQuotesToPath(RepeatGenPath)+" "+PlaceQuotesToPath(nhmmerResultFile.ShellPath)+" "+PlaceQuotesToPath(GenomeFilePath)+" "+PlaceQuotesToPath(outFilePath)+" "+HmmGenOptions
		      
		      userShell(cli)
		      If shError=0 Then
		        'store hit number for genome scan:
		        dim LastHitStr as string
		        LastHitStr=NthField(shResult,"Features added:",3)
		        LastHitStr=NthField(LastHitStr,"CPU time:",1)
		        LastHitNo=Val(LastHitStr)
		        
		        WriteToSTDOUT (EndofLine+shResult)
		        
		        
		        dim ms,t1 as double
		        ms=microseconds
		        
		        'display the hits in the browser:
		        if HmmGenSettingsWin.GenomeBrowserCheckBox.value then
		          
		          
		          redim GenomeWin.HmmHits(0)
		          redim GenomeWin.HmmHitDescriptions(0)
		          redim genomeWin.HmmHitNames(0)
		          
		          dim m,n,o,colonPos as integer
		          dim currentHit,HitInfo, hits2sort(0),hitloc as string
		          
		          'sort the hits according to genome position:
		          m=CountFields(shResult,"location: [")
		          for n=2 to m
		            currentHit=nthfield(shResult,"location: [",n)
		            colonPos=instrb(currenthit,":")
		            hitloc=nthfield(currentHit,":",1)
		            if lenb(hitLoc)<8 then 'assuming genome length is less than 100Mb
		              for o=0 to 8-lenb(hitLoc)
		                hitloc="0"+hitloc
		              next
		            end if
		            hitloc=hitloc+midb(currenthit,colonpos,lenb(currentHit)-colonpos)
		            hits2sort.append hitloc'+midb(currenthit,colonpos,lenb(currentHit)-colonpos)
		            'nthfield(sh.result,"location: [",n)
		          next
		          hits2sort.Sort
		          m=ubound(hits2sort)
		          for n=1 to m
		            while left(hits2sort(n),1)="0"
		              hits2sort(n)=right(hits2sort(n),lenb(hits2sort(n))-1)
		            wend
		          next
		          
		          'add sorted hits and their info into genome browser arrays:
		          'hmmgen result:
		          '2233715:2233745](-)
		          'qualifiers:
		          'Key: bound_moiety, Value: ['HrpL alternative sigma factor']
		          'Key: gene, Value: ['hrpJ']
		          'Key: inference, Value: ['profile:nhmmer:3.1b1']
		          'Key: locus_tag, Value: ['OA04_20620']
		          'Key: note, Value: nhmmer score 12.8 E-value 1.2
		          'Key: regulatory_class, Value: ['promoter']
		          'type: regulatory
		          
		          for n=1 to ubound(hits2sort)
		            currentHit=hits2sort(n)
		            GenomeWin.HmmHits.append(val(nthfield(currentHit,":",1)))
		            HitInfo=nthfield(currentHit,"]",1)+" ("+right(nthfield(currentHit,")",1),1)+") "
		            HitInfo=HitInfo+nthfield(nthfield(currentHit,"bound_moiety, Value: ['",2),"']",1)
		            HitInfo=HitInfo+" "+NthField(nthfield(currentHit,"nhmmer ",2),Endofline,1)
		            HitName=""
		            if instr(currenthit,"Key: gene")>0 then
		              'extract gene name
		              Hitname=nthfield(currentHit,"Key: gene, Value: ['",2)
		              Hitname=nthfield(HitName,"']",1)+" "
		            end if
		            'add locus_tag
		            Hitname=Hitname+nthfield(nthfield(currentHit,"Key: locus_tag, Value: ['",2),"']",1)+" "
		            
		            Hitinfo=Replace(HitInfo,"score ","Score=")
		            Hitinfo=Replace(HitInfo,"E-value ","E-value=")
		            genomeWin.HmmHitDescriptions.append HitInfo
		            genomeWin.HmmHitNames.append HitName
		            
		          next
		          
		          'initialise array to select/deselect hits:
		          redim genomeWin.HmmHitChecked(ubound(hits2sort))
		          for n=1 to ubound(hits2sort)
		            genomeWin.HmmHitChecked(n)=true
		          next
		          genomeWin.AnyHitDeselected=false
		        end if
		        
		        
		        
		        if Ubound(genomeWin.HmmHits)>0 then
		          if NOT ScanningGenome then
		            WriteToSTDOUT (EndofLine.unix+"Genbank file with added features written to "+outFile.ShellPath+EndofLine)
		          end if
		          
		          WriteToSTDOUT (EndofLine.unix+"Loading the GenBank file...")
		          
		          'Set the genome map scrollbar:
		          Genomewin.SetScrollbar
		          
		          'Display the hit:
		          genomeWin.CurrentHit=1
		          Dim s0 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 0 )
		          s0.Enabled=false 'first hit: there's no previous one
		          Dim s1 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 1 )
		          s1.Title="1/"+str(UBound(genomeWin.HmmHits))
		          Dim s2 As SegmentedControlItem = genomeWin.SegmentedControl1.Items( 2 )
		          if Ubound(genomeWin.HmmHits)>1 then
		            s2.enabled=true
		          else
		            s2.enabled=false
		          end if
		          
		        end if
		        return true
		      else
		        WriteToSTDOUT (EndOfLine+"HmmGen error code: "+Str(shError)+EndOfLine)
		        WriteToSTDOUT (EndofLine+ShResult)
		        WriteToSTDOUT (EndofLine+"HmmGen command line was: "+cli+EndofLine)
		        return false
		      end if
		    else
		      return false
		    end if
		    
		  end if
		  
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:HmmGen")
		    
		End Function
	#tag EndMethod

	#tag Method, Flags = &h1
		Protected Sub SaveHMM()
		  msgbox "Not implemented yet"
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub SaveLog()
		  
		  Dim f as FolderItem=GetSaveFolderItem("????","hmm_out.log")
		  If f <> nil then
		    Dim s as TextOutputStream=TextOutputStream.Create(f)
		    s.Write STDOUT.StyledText.text 'RTFData
		    s = nil
		  End if
		  
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub SaveLogo()
		  Dim f As FolderItem
		  Dim dlg as New SaveAsDialog
		  
		  If LogoPic <> Nil Then
		    // Get a temporary file to save the image to
		    If Picture.IsExportFormatSupported(Picture.Formats.PNG) Then
		      dlg.InitialDirectory=SpecialFolder.Documents
		      'dlg.promptText="Prompt Text"
		      dlg.SuggestedFileName=NthField(LogoFile.Name,".",1)+".Png"
		      dlg.Title="Save Logo"
		      'dlg.Filter=FileTypes1.Text  //defined as a file type in FileTypes1 file type set
		      dlg.CancelButtonCaption=kCancel
		      dlg.ActionButtonCaption=kSave
		      f=dlg.ShowModal()
		      If f <> Nil then
		        LogoPic.Save(f, Picture.SaveAsPNG)
		      Else
		        //user canceled
		      End if
		      
		    else
		      msgbox "Looks like the PNG image format isn't supported by your computer, therefore the logo could not be saved."
		    End If
		    
		  End If
		  Exception err
		    ExceptionHandler(err,"LogoWin:SaveLogo")
		    
		    
		    
		    
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Function TermGen() As boolean
		  'returns true if completed without errors
		  
		  'outfile must be set before calling this method
		  
		  'GenomeFile=GetOpenFolderItem("")
		  if GenomeFile<> nil then
		    dim cli as string
		    
		    
		    'usage:
		    'TermGen <input_file> <output_file> [options]
		    '
		    'This script allows to add terminators to a genbank file according to TransTerm
		    'HP results. Requires Biopython 1.64 (or newer)
		    '
		    'positional arguments:
		    'input_file            path to input Genbank file.
		    'output_file           path to input Genbank file.
		    '
		    'optional arguments:
		    '-h, --help            show this help message and exit
		    '-o <path>, --output <path>
		    '                      redirects TransTerm HP output file to directory given
		    '-C <integer>, --confidence <integer>
		    '                      threshold Score.
		    '--minstem <integer>   Stem must be n nucleotides long
		    '--minloop <integer>   Loop portion of the hairpin must be at least n long
		    '--maxlen <integer>    Total extent of hairpin <= n NT long
		    '--maxloop <integer>   The loop portion can be no longer than n
		    '-v, --version         show program's version number and exit
		    
		    
		    
		    
		    if outfile<>nil then
		      WriteToSTDOUT (EndofLine+EndofLine+"Running TermGen script..."+EndofLine)
		      
		      FixPath4Windows(outfile)
		      cli=pythonPath+PlaceQuotesToPath(TermGenPath)+" "+PlaceQuotesToPath(GenomeFile.ShellPath)+" "+PlaceQuotesToPath(outFile.ShellPath)+" "+TermGenOptions
		      
		      userShell(cli)
		      If shError=0 Then
		        'store hit number for genome scan:
		        'dim LastHitStr as string
		        'LastHitStr=NthField(Sh.Result,"Features added:",3)
		        'LastHitStr=NthField(LastHitStr,"CPU time:",1)
		        'LastHitNo=Val(LastHitStr)
		        
		        WriteToSTDOUT (EndofLine)
		        
		        dim termCount as integer, tc as string
		        
		        'transterm output:
		        '6 terminators were added.
		        tc=NthField(shResult,"terminators were added",1)
		        termcount=countfields(tc,EndOfLine)
		        tc=NthField(tc,EndOfLine,termcount)
		        WriteToSTDOUT (trim(tc)+" terminators added."+EndofLine)
		        'WriteToSTDOUT (nthfield(Sh.Result,"seconds.",1)+"seconds."+EndofLine)
		        if NOT ScanningGenome then
		          WriteToSTDOUT (EndofLine+"Genbank file with added terminators written to "+outFile.ShellPath+EndofLine)
		        end if
		        return true
		      else
		        WriteToSTDOUT (EndofLine+shResult)
		        WriteToSTDOUT (EndofLine+"TermGen command line was: "+cli+EndofLine)
		        
		        return false
		      End If
		    end if
		  end if
		  
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:TermGen")
		    
		End Function
	#tag EndMethod

	#tag Method, Flags = &h1
		Protected Sub TermGenSearch()
		  TermGenOptions=""
		  TermGenSettingsWin.showmodalwithin(self)
		  if TermGenSettingsWin.OKpressed then
		    dim fn as string=nthfield(GenomeFile.Name,".",1)+"_term.gb"
		    outfile=GetSaveFolderItem("????",fn)
		    if outfile<>nil then
		      if TermGen then
		        if TermGenSettingsWin.GenomeBrowserCheckBox.Value then 'Load the Seq into browser
		          GenomeWin.opengenbankfile(outFile)
		          GenomeWin.ShowGenomeStart
		          'genomeWin.ShowHit
		        end if
		      end if
		    end if
		  end if
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub WriteToSTDOUT(txt as string)
		  'STDOUT.text=STDOUT.text+txt
		  stdout.TextFont=FixedFont  'workaround for problems setting font at initialisation 
		  stdout.AppendText(txt)
		  stdout.ScrollPosition=stdout.LineNumber(Len(stdout.Text))
		  STDOUT.refresh(false)
		  App.DoEvents  'seems to be required as of Xojo 2018, otherwise STDout isn't updated
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub WriteToSTDOUT(txt as string, clr as string)
		  Dim ss,se,sl As Integer
		  Dim colr As Color
		  Select Case clr
		  Case "Red"
		    colr=&cFF000000   '
		  Case "Brown"
		    colr=&c66330000   '
		  Case "Green"
		    colr=&c00804000   '
		  Case "Blue"
		    colr=&c0080FF00   '
		  Case "Black"
		    colr=&c00000000
		  End Select
		  
		  ss=Len(stdout.Text)
		  
		  stdout.TextFont=FixedFont  'workaround for problems setting font at initialisation 
		  stdout.AppendText(txt)
		  stdout.ScrollPosition=stdout.LineNumber(Len(stdout.Text))
		  se=Len(stdout.Text)
		  sl=se-ss
		  stdout.SelStart=ss
		  stdout.SelLength=sl
		  stdout.SelTextColor=colr
		  stdout.SelStart=se
		  stdout.SelLength=0
		  STDOUT.refresh(false)
		  App.DoEvents  'seems to be required as of Xojo 2018, otherwise STDout isn't updated
		End Sub
	#tag EndMethod


	#tag Property, Flags = &h0
		AlignmentLength As String
	#tag EndProperty

	#tag Property, Flags = &h0
		alimaskTmp As folderitem
	#tag EndProperty

	#tag Property, Flags = &h0
		bioprospectLogo As boolean = False
	#tag EndProperty

	#tag Property, Flags = &h0
		BioProspectSettings As Dictionary
	#tag EndProperty

	#tag Property, Flags = &h0
		BioProsWinClosed As Boolean = True
	#tag EndProperty

	#tag Property, Flags = &h0
		BioPrSettingsSaved As Boolean = false
	#tag EndProperty

	#tag Property, Flags = &h0
		CheckState As String
	#tag EndProperty

	#tag Property, Flags = &h0
		CRtag As String
	#tag EndProperty

	#tag Property, Flags = &h0
		CRtagCoords As string
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected CurrentX As Integer
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected DragStartY As Integer
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected FirstX As Integer
	#tag EndProperty

	#tag Property, Flags = &h0
		GenomeFile As folderitem
	#tag EndProperty

	#tag Property, Flags = &h0
		HitsNo As Integer
	#tag EndProperty

	#tag Property, Flags = &h0
		HmmFile As folderitem
	#tag EndProperty

	#tag Property, Flags = &h0
		HmmGenOptions As String
	#tag EndProperty

	#tag Property, Flags = &h0
		HmmGenPath As string
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected HmmProfile As string
	#tag EndProperty

	#tag Property, Flags = &h0
		HScrollBarLast As Integer
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected Info As string
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected InformerHasFocus As Boolean
	#tag EndProperty

	#tag Property, Flags = &h0
		IsRegulog As boolean
	#tag EndProperty

	#tag Property, Flags = &h0
		LastHitNo As Integer
	#tag EndProperty

	#tag Property, Flags = &h0
		LastSearch As string
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected LastX As Integer
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected LogoData(0) As string
	#tag EndProperty

	#tag Property, Flags = &h0
		LogoFile As Folderitem
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected LogoLength As Integer
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected LogoPic As Picture
	#tag EndProperty

	#tag Property, Flags = &h0
		Masked As boolean
	#tag EndProperty

	#tag Property, Flags = &h0
		MASTGenPath As string
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected MASTResultFile As folderitem
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected MEMEdata As string
	#tag EndProperty

	#tag Property, Flags = &h0
		MEMEtmp As FolderItem
	#tag EndProperty

	#tag Property, Flags = &h0
		minAlignmentLength As string
	#tag EndProperty

	#tag Property, Flags = &h0
		nhmmerOptions As string
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected nhmmerResultFile As folderitem
	#tag EndProperty

	#tag Property, Flags = &h0
		OperOnPath As string
	#tag EndProperty

	#tag Property, Flags = &h0
		OutFile As folderitem
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected pA As Picture
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected PalindromeLogoFile As folderitem
	#tag EndProperty

	#tag Property, Flags = &h0
		Palindromic As boolean = false
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected pC As Picture
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected pG As picture
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected ProfileSettings As string
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected pT As Picture
	#tag EndProperty

	#tag Property, Flags = &h0
		RegulogID As Integer
	#tag EndProperty

	#tag Property, Flags = &h0
		RegulonID As Integer
	#tag EndProperty

	#tag Property, Flags = &h0
		RepeatGenPath As string
	#tag EndProperty

	#tag Property, Flags = &h0
		ScanningGenome As boolean
	#tag EndProperty

	#tag Property, Flags = &h0
		SeedProteinID As String
	#tag EndProperty

	#tag Property, Flags = &h0
		SeedProteinSeq As String
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected SelArray1(0) As Integer
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected SelArray2(0) As Integer
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected SeqsChanged As Boolean
	#tag EndProperty

	#tag Property, Flags = &h0
		Sequences As string
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected SigFileOpened As boolean
	#tag EndProperty

	#tag Property, Flags = &h0
		TermGenOptions As String
	#tag EndProperty

	#tag Property, Flags = &h0
		TermGenPath As String
	#tag EndProperty

	#tag Property, Flags = &h0
		TF_HMM As String
	#tag EndProperty

	#tag Property, Flags = &h1
		Protected totalEntropy As Double
	#tag EndProperty

	#tag Property, Flags = &h0
		Weblogo_out As string
	#tag EndProperty

	#tag Property, Flags = &h0
		Weighting As String
	#tag EndProperty


#tag EndWindowCode

#tag Events LogoWinToolbar
	#tag Event
		Sub Action(item As ToolItem)
		  
		  
		  select case Item.Name
		    
		  Case "LoadAlignmentTool"
		    'This should fire only on Linux and Windows
		    dim tmpfile as folderitem
		    dim GenomeFile as folderitem
		    Dim dlg as New OpenDialog
		    
		    '#If Not TargetLinux Then
		    'dlg.InitialDirectory = SpecialFolder.Documents
		    '#Else //open Home directory on linux
		    'dlg.InitialDirectory = SpecialFolder.Home
		    '#Endif
		    
		    dlg.promptText="Select a fasta file"
		    'dlg.SuggestedFileName=nthfield(GenomeFile.Name,".",1)+".tbl"
		    dlg.Title="Open alignment"
		    dlg.Filter=FileTypes.Fasta
		    tmpfile=dlg.ShowModalwithin(self)
		    if tmpfile<>Nil then
		      LoadAlignment(tmpFile)
		      ChangeView("Logo")
		      LogoTabs.value=0
		      logowin.Title="SigmoID: "+NthField(tmpfile.name,".",1)
		    end if
		  Case "LoadGenomeTool" 'No such button any more
		    GenomeFile=GetOpenFolderItem("")
		    if GenomeFile<> Nil then
		      WriteToSTDOUT (EndofLine+"Genome from "+GenomeFile.shellpath+" loaded.")
		      if Logofile<>nil then
		        LogoWinToolbar.Item(1).Enabled=true
		        LogoWinToolbar.Item(2).Enabled=false 'new genome, no nhmmer output yet
		        LogoWinToolbar.Item(3).Enabled=true
		        
		      end if
		    end if
		    '
		  Case "SearchTool"
		    nhmmerSearch
		  Case "HmmGenTool"
		    HmmGenSearch
		  Case "TermGenTool"
		    TermGenSearch
		  Case "SettingsTool"
		    SettingsWin.show
		  Case "PalindromiseTool"
		    'dim oldentropy as double = totalEntropy
		    Palindromise
		    'if totalEntropy<oldentropy then
		    'msgbox "Binding site entropy decreased after palindromising. Please check that the site is indeed palindromic!"
		    'end if
		  End Select
		  
		  Exception err
		    ExceptionHandler(err,"LogoWinToolbar:Action")
		End Sub
	#tag EndEvent
	#tag Event
		Sub DropDownMenuAction(item As ToolItem, hitItem As MenuItem)
		  
		  
		  If item.Name = "LoadAlignmentTool" Then
		    dim f,tmpfile as folderitem
		    dim n,m as integer
		    
		    
		    'tmpfile=Profile_f.item(hititem.Index)
		    ' appears to be a large negative number, hence the workaround:
		    f=Profile_f
		    m=f.Count
		    for n=1 to m
		      if f.Item(n).name=hititem.Text+".sig" then
		        tmpfile=f.Item(n)
		        exit
		      end if
		    next
		    #if TargetCocoa then               'a workaround for toolbar deficiency on Mac
		      if hititem.Text="More..." then
		        dim GenomeFile as folderitem
		        Dim dlg as New OpenDialog
		        dlg.promptText="Select an alignment file"
		        dlg.Title="Open alignment"
		        
		        dlg.Filter=FileTypes.Fasta + FileTypes.Sig_file
		        tmpfile=dlg.ShowModalwithin(self)
		        if tmpfile<>Nil then
		          LoadAlignment(tmpFile)
		          ChangeView("Sequences") 'a workaround for invisible logo
		          ChangeView("Logo")
		          LogoTabs.value=0
		          logowin.Title="SigmoID: "+NthField(tmpfile.name,".",1)
		        end if
		      else
		        if tmpfile<>Nil then
		          LoadAlignment(tmpFile)
		          ChangeView("Sequences") 'a workaround for invisible logo
		          ChangeView("Logo")
		          LogoTabs.value=0
		          logowin.Title="SigmoID: "+NthField(tmpfile.name,".",1)
		        end if
		      end if
		    #else
		      if tmpfile<>Nil then
		        LoadAlignment(tmpFile)
		        logowin.ChangeView("Logo")
		        logowin.LogoTabs.value=0
		        logowin.Title="SigmoID: "+NthField(tmpfile.name,".",1)
		      end if
		    #endif
		    
		  else
		    if Palindromic then
		      LogoWinToolbar.Item(4).Enabled=false
		    else
		      LogoWinToolbar.Item(4).Enabled=true
		    End If
		    
		  End If
		  
		  Exception err
		    ExceptionHandler(err,"LogoWinToolbar:DropDownMenuAction")
		End Sub
	#tag EndEvent
	#tag Event
		Sub Open()
		  #If TargetCocoa
		    Me.SettingsTool.icon=SystemIcons.PreferencesGeneral(32,32)
		  #EndIf
		End Sub
	#tag EndEvent
#tag EndEvents
#tag Events STDOUT
	#tag Event
		Sub TextChange()
		  if len(me.Text)>0 then
		    LogoWinToolbar.Item(5).Enabled=true 'SaveLog button
		  else
		    LogoWinToolbar.Item(5).Enabled=false
		  end if
		End Sub
	#tag EndEvent
#tag EndEvents
#tag Events Splitter
	#tag Event
		Function MouseDown(X As Integer, Y As Integer) As Boolean
		  DragStartY=Y
		  'Me.MouseCursor=System.Cursors.HandClosed
		  return true
		End Function
	#tag EndEvent
	#tag Event
		Sub MouseUp(X As Integer, Y As Integer)
		  DragStartY=Y
		  self.invalidate(false)
		  
		End Sub
	#tag EndEvent
	#tag Event
		Sub MouseDrag(X As Integer, Y As Integer)
		  if Y<>DragStartY then
		    dim deltaY as integer = Y-DragStartY
		    TopPanel.Height=TopPanel.Height+deltaY
		    STDOUT.height=STDOUT.height-deltaY
		    STDOUT.top=STDOUT.top+deltaY
		    HScrollBar.top=HScrollBar.top+deltaY
		    me.top=me.top+deltaY
		  end if
		  
		End Sub
	#tag EndEvent
	#tag Event
		Sub MouseEnter()
		  Me.MouseCursor=System.Cursors.ArrowNorthSouth
		End Sub
	#tag EndEvent
	#tag Event
		Sub Paint(g As Graphics, areas() As REALbasic.Rect)
		  'draw three little dots in the centre
		  
		  g.ForeColor=DarkBevelColor
		  
		  g.FillOval(me.width/2,1,3,3)
		  g.FillOval(me.width/2-7,1,3,3)
		  g.FillOval(me.width/2+7,1,3,3)
		  Splitter.Width=Logowin.Width
		End Sub
	#tag EndEvent
#tag EndEvents
#tag Events Informer
	#tag Event
		Sub Open()
		  'if FixedFont="" then
		  'dim ff as string
		  'ff=SetDefaultFonts(true)
		  'FixedFont=NthField(ff,";",1)
		  'end if
		  '
		  'me.TextFont=FixedFont
		End Sub
	#tag EndEvent
	#tag Event
		Sub TextChange()
		  'watch only for sequence change
		  'for other changes Profile Wizard should be used
		  
		  if ViewSequences.Checked=true then
		    SeqsChanged=true
		    LengthsDiffer=false 'we don't actually know
		    FileSaveLogo.enabled=true
		  end if
		End Sub
	#tag EndEvent
	#tag Event
		Function KeyDown(Key As String) As Boolean
		  'enable editing of only the sequences
		  
		  if ViewSequences.Checked then
		    return false 
		  else
		    return true
		  end if
		End Function
	#tag EndEvent
	#tag Event
		Sub GotFocus()
		  InformerHasFocus=true
		End Sub
	#tag EndEvent
	#tag Event
		Sub LostFocus()
		  InformerHasFocus=false
		End Sub
	#tag EndEvent
#tag EndEvents
#tag Events HScrollBar
	#tag Event
		Sub ValueChanged()
		  Dim delta As Integer
		  delta = HScrollBarLast - Me.Value
		  LogoCanvas.left=LogoCanvas.left+delta
		  HScrollBarLast = Me.Value
		End Sub
	#tag EndEvent
	#tag Event
		Sub Open()
		  #if TargetLinux
		    me.Height=17
		  #endif
		End Sub
	#tag EndEvent
#tag EndEvents
#tag Events LogoCanvas
	#tag Event
		Sub Open()
		  me.left=0
		End Sub
	#tag EndEvent
	#tag Event
		Sub Paint(g As Graphics, areas() As REALbasic.Rect)
		  dim n as integer
		  
		  'draw background:
		  g.ForeColor=&cFFFFFF00 'white
		  g.FillRect(0,0,g.width,g.height)
		  
		  'draw selrect:
		  g.ForeColor=HighlightColour
		  
		  for n=1 to ubound(SelArray1)
		    g.fillRect(SelArray1(n),0,SelArray2(n)-SelArray1(n),me.height)
		    
		  next
		  if lastx>0 then
		    g.fillRect(FirstX,0,LastX-FirstX,me.height)
		  end if
		  g.DrawPicture(LogoPic,10,0)
		  if logoPic<>nil then
		    HScrollbar.Maximum = g.Width-LogoWin.Width
		    if LogoPic.width>LogoWin.width then
		      
		      HScrollBar.Visible=true
		      HScrollBar.top=LogoCanvas.Height+LogoTabs.height
		    else
		      HScrollBar.Visible=false
		    end
		    
		    if logopic.width< logowin.Width then
		      LogoCanvas.left=0
		    end
		  end if
		  
		  Exception err
		    ExceptionHandler(err,"LogoWin:LogoCanvas:Paint")
		End Sub
	#tag EndEvent
	#tag Event
		Sub MouseUp(X As Integer, Y As Integer)
		  selarray1.Append firstX
		  selarray2.Append lastX
		  if lastx=0 then
		    'nothing was selected
		    redim SelArray1(0)
		    redim SelArray2(0)
		  end if
		  invalidate
		  
		  if ubound(SelArray1)>0 then
		    masked=true
		    #if Target64Bit 
		      #if TargetLinux
		        FileSaveAlignmentSelection.enabled=true
		      #endif
		    #endif
		  else
		    masked=false
		    #if Target64Bit 
		      #if TargetLinux
		        FileSaveAlignmentSelection.enabled=false
		      #endif
		    #endif
		  end if
		  
		End Sub
	#tag EndEvent
	#tag Event
		Sub MouseDrag(X As Integer, Y As Integer)
		  if CurrentX<>X then
		    CurrentX=X
		    'adjustFirstX and LastX to letter boundaries:
		    lastX=(ceil((X+7)/30)-1)*30+7
		    if lastx<37 then lastx=37
		    self.Invalidate(false)
		    
		  end if
		End Sub
	#tag EndEvent
	#tag Event
		Function MouseDown(X As Integer, Y As Integer) As Boolean
		  'shift controls multiple selection
		  
		  firstX=(floor((X-7)/30))*30+7
		  if firstX<37 then firstX=37
		  
		  if keyboard.AlternateMenuShortCutKey then    'shift pressed
		    'selarray1.Append firstX
		  else
		    'clear selection arrays:
		    redim selarray1(0)
		    redim selarray2(0)
		    lastx=0
		    
		  end if
		  
		  return true
		End Function
	#tag EndEvent
	#tag Event
		Sub MouseEnter()
		  Me.MouseCursor=System.Cursors.StandardPointer
		End Sub
	#tag EndEvent
#tag EndEvents
#tag Events LogoTabs
	#tag Event
		Sub Open()
		  Me.appendTab("Logo")
		  me.appendTab("Sequences")
		  Me.appendTab("Info")
		  Me.appendTab("Settings")
		  Me.appendTab("HMM")
		  Me.appendTab("MEME")
		  
		  Me.Left=0
		  ChangeView("Logo")
		  
		  
		End Sub
	#tag EndEvent
	#tag Event
		Sub TabChanged(tabIndex as integer)
		  Dim Tabname As String
		  
		  Tabname=me.tabs(tabIndex).caption
		  
		  ChangeView(TabName)
		  
		End Sub
	#tag EndEvent
#tag EndEvents
#tag ViewBehavior
	#tag ViewProperty
		Name="MinimumWidth"
		Visible=true
		Group="Size"
		InitialValue="64"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MinimumHeight"
		Visible=true
		Group="Size"
		InitialValue="64"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MaximumWidth"
		Visible=true
		Group="Size"
		InitialValue="32000"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MaximumHeight"
		Visible=true
		Group="Size"
		InitialValue="32000"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Type"
		Visible=true
		Group="Frame"
		InitialValue="0"
		Type="Types"
		EditorType="Enum"
		#tag EnumValues
			"0 - Document"
			"1 - Movable Modal"
			"2 - Modal Dialog"
			"3 - Floating Window"
			"4 - Plain Box"
			"5 - Shadowed Box"
			"6 - Rounded Window"
			"7 - Global Floating Window"
			"8 - Sheet Window"
			"9 - Metal Window"
			"11 - Modeless Dialog"
		#tag EndEnumValues
	#tag EndViewProperty
	#tag ViewProperty
		Name="HasCloseButton"
		Visible=true
		Group="Frame"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="HasMaximizeButton"
		Visible=true
		Group="Frame"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="HasMinimizeButton"
		Visible=true
		Group="Frame"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="HasFullScreenButton"
		Visible=true
		Group="Frame"
		InitialValue="False"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="DefaultLocation"
		Visible=true
		Group="Behavior"
		InitialValue="0"
		Type="Locations"
		EditorType="Enum"
		#tag EnumValues
			"0 - Default"
			"1 - Parent Window"
			"2 - Main Screen"
			"3 - Parent Window Screen"
			"4 - Stagger"
		#tag EndEnumValues
	#tag EndViewProperty
	#tag ViewProperty
		Name="HasBackgroundColor"
		Visible=true
		Group="Background"
		InitialValue="False"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="BackgroundColor"
		Visible=true
		Group="Background"
		InitialValue="&hFFFFFF"
		Type="Color"
		EditorType="Color"
	#tag EndViewProperty
	#tag ViewProperty
		Name="AlignmentLength"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="String"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Backdrop"
		Visible=true
		Group="Appearance"
		InitialValue=""
		Type="Picture"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="CheckState"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="String"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Composite"
		Visible=true
		Group="Appearance"
		InitialValue="False"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="CRtag"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="String"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="CRtagCoords"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="string"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="FullScreen"
		Visible=false
		Group="Appearance"
		InitialValue="False"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Height"
		Visible=true
		Group="Position"
		InitialValue="400"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="HmmGenOptions"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="String"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="HmmGenPath"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="string"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="HScrollBarLast"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="ImplicitInstance"
		Visible=true
		Group="Appearance"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Interfaces"
		Visible=true
		Group="ID"
		InitialValue=""
		Type="String"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="IsRegulog"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="LastHitNo"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="LastSearch"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="string"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="MacProcID"
		Visible=true
		Group="Appearance"
		InitialValue="0"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Masked"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MASTGenPath"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="string"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="MenuBar"
		Visible=true
		Group="Appearance"
		InitialValue=""
		Type="MenuBar"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MenuBarVisible"
		Visible=false
		Group="Appearance"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="minAlignmentLength"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="string"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Name"
		Visible=true
		Group="ID"
		InitialValue=""
		Type="String"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="nhmmerOptions"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="string"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="OperOnPath"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="string"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Palindromic"
		Visible=false
		Group="Behavior"
		InitialValue="false"
		Type="boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="RegulogID"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="RegulonID"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="RepeatGenPath"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="string"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Resizeable"
		Visible=true
		Group="Appearance"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="ScanningGenome"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="SeedProteinID"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="String"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="SeedProteinSeq"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="String"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Sequences"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="string"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Super"
		Visible=true
		Group="ID"
		InitialValue=""
		Type="String"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="TermGenOptions"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="String"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="TermGenPath"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="String"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="TF_HMM"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="String"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Title"
		Visible=true
		Group="Appearance"
		InitialValue="Untitled"
		Type="String"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Visible"
		Visible=true
		Group="Appearance"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Weblogo_out"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="string"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Weighting"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="String"
		EditorType="MultiLineEditor"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Width"
		Visible=true
		Group="Position"
		InitialValue="600"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="HitsNo"
		Visible=false
		Group="Behavior"
		InitialValue=""
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="BioProsWinClosed"
		Visible=false
		Group="Behavior"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="BioPrSettingsSaved"
		Visible=false
		Group="Behavior"
		InitialValue="false"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
#tag EndViewBehavior
